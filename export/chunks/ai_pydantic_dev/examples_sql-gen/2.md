---
url: https://ai.pydantic.dev/examples/sql-gen/
session_id: pydantic_ai_docs
chunk_number: 2
title: Pydantic SQL Generator Example
summary: This document provides an example of generating SQL using Pydantic, showcasing the required imports, database table schema creation, and configuration for logging with logfire. It integrates async programming and database management using asyncpg.
embedding: [-0.022161584347486496, 0.012179065495729446, 0.05805158242583275, -0.03684445098042488, 0.01944204978644848, -0.0012102251639589667, -0.02639777958393097, -0.009590278379619122, -0.03603382036089897, -0.008073614910244942, 0.01306160632520914, -0.04665046185255051, 0.02277609333395958, -0.03263440355658531, -0.022213881835341454, 0.03127463534474373, 0.006259503308683634, 0.030307110399007797, 0.0017307609086856246, 0.0053998432122170925, 0.0606665201485157, -0.026907693594694138, 0.019468199461698532, -0.020474949851632118, -0.019651245325803757, 0.033994171768426895, -0.033183541148900986, 0.06281076371669769, 0.0074525680392980576, -0.02737838216125965, 0.016670217737555504, -0.03574617579579353, 0.019559722393751144, 0.01983429118990898, -0.007485254667699337, 0.0073022092692554, 0.030019467696547508, 0.009753711521625519, 0.005553470458835363, -0.017140906304121017, 0.03365422785282135, -0.042780354619026184, 0.036347612738609314, 0.020135007798671722, 0.005537127144634724, 0.036190714687108994, -0.005020677577704191, 0.003602074459195137, 0.04053150862455368, -0.0262539591640234, -0.043460238724946976, 0.0006288104341365397, 0.01013287715613842, 0.03572002798318863, -0.026423929259181023, -0.04003467410802841, -0.04542144015431404, 0.031483832746744156, -0.021246356889605522, -0.015114330686628819, 0.00879926048219204, -0.04074070602655411, -0.008897320367395878, 0.03190222010016441, -0.010583953931927681, 0.02448887750506401, -0.04155133664608002, 0.00965565163642168, -0.011538405902683735, 0.04675505682826042, 0.012728202156722546, 0.04780103266239166, -0.025207985192537308, -0.02685539424419403, 0.006962267681956291, -0.03815191984176636, 0.012394797056913376, 0.04000852257013321, -0.01791231334209442, -0.027038440108299255, -0.026737721636891365, 0.012440558522939682, -0.02255382388830185, 0.011603779159486294, -0.0017748879035934806, -0.024227382615208626, -0.07049867510795593, 0.011453419923782349, 0.019468199461698532, -0.026803094893693924, -0.013937609270215034, 0.014525970444083214, -0.004448660183697939, 0.022671496495604515, 0.0777159035205841, 0.02425353229045868, 0.041891276836395264, 0.0015599728794768453, -0.027770621702075005, -0.0006038868450559676, 0.031980667263269424, -0.04011312127113342, -0.02944418042898178, -0.01901058666408062, 0.0140552818775177, 0.015885736793279648, -0.029025791212916374, 0.0038014634046703577, -0.02907809056341648, -0.016068782657384872, -0.0805923342704773, -0.012924321927130222, 0.03540623560547829, -0.011401121504604816, -0.045081499963998795, -0.024515027180314064, -0.0318237729370594, -0.02818901091814041, 0.036635253578424454, -0.012466708198189735, -0.04230966791510582, 0.02085411548614502, -0.05237717181444168, -0.014225252903997898, 0.011976407840847969, 0.02506416290998459, -0.0024956297129392624, -0.057580895721912384, -0.03438641130924225, 0.005922830197960138, 0.02795366756618023, 0.0243973545730114, 0.06092801317572594, -0.022867616266012192, -0.029261134564876556, 0.0038570307660847902, -0.058469973504543304, -0.02706458978354931, -0.021050235256552696, 0.027012290433049202, 0.01046628225594759, -0.01612108200788498, 0.0037785826716572046, 0.02952262945473194, -0.03867490589618683, -0.013140054419636726, -0.030647052451968193, 0.03098699264228344, -0.018526822328567505, 0.022292330861091614, 0.020540323108434677, 0.012067930772900581, -0.04840246960520744, 0.02729993313550949, 0.00604703975841403, -0.01138804666697979, 0.00042288421536795795, 0.04947459325194359, 0.00847239326685667, -0.04037461429834366, 0.0047003477811813354, 0.03710594400763512, -0.0539722815155983, -0.04280650615692139, -0.015728840604424477, -0.01427755132317543, -0.037602782249450684, -0.012250975705683231, -0.08561301231384277, -0.00825012382119894, -0.014473672024905682, -0.012237900868058205, -0.018618345260620117, 0.01989966444671154, 0.01605570875108242, -0.023625947535037994, -0.009629501961171627, -0.021272504702210426, -0.01759852096438408, -0.07656533271074295, -0.04126369208097458, -0.0013483264483511448, -0.03734128922224045, -0.01929822936654091, -0.0038929861038923264, -0.03224216401576996, -0.024240458384156227, 0.02078874222934246, 0.02167782001197338, 0.03689675033092499, 0.012787037529051304, 0.028738148510456085, -0.004095643758773804, 0.013937609270215034, 0.002356711309403181, -0.07211993634700775, 0.05140964314341545, 0.002793078776448965, -0.00774674816057086, 0.03017636388540268, 0.024737296625971794, 0.01921978034079075, 0.029601076617836952, -0.0576854906976223, -0.005984934978187084, -0.014303700998425484, -0.00016343350580427796, -0.008426631800830364, -0.03470020368695259, -0.010610103607177734, 0.03286974877119064, -0.061869390308856964, 0.015585019253194332, 0.0086946627125144, -0.009224187582731247, -0.0047003477811813354, -0.036059968173503876, -0.01206139288842678, 0.03430796042084694, -0.03009791485965252, -0.03734128922224045, 0.011976407840847969, 0.011303061619400978, -0.03940708935260773, 0.0011407658457756042, 0.05658721923828125, -0.0058215013705194, -0.025011863559484482, -0.004710153676569462, 0.04978838562965393, -0.005043558310717344, -0.01791231334209442, -0.008609677664935589, -0.013689191080629826, -0.006494847591966391, -0.01870986819267273, 0.008237048983573914, 0.018657568842172623, 0.017860013991594315, 0.005546933505684137, 0.0009340224787592888, -0.007557165343314409, -0.010603565722703934, -0.0006610885611735284, 0.02145555056631565, 0.007969018071889877, -0.005831307731568813, -0.03765508159995079, 0.05133119598031044, 0.05496595799922943, 0.038047321140766144, -0.02863355167210102, -0.01504895742982626, -0.03352348133921623, -0.023926666006445885, -0.030490156263113022, -0.049605339765548706, -0.022083135321736336, -0.016905562952160835, -0.030594753101468086, -0.02263227291405201, 0.025835569947957993, -0.029993318021297455, 0.033314287662506104, -0.007897106930613518, -0.011688764207065105, 0.042649608105421066, -0.06762225180864334, 0.01656562089920044, -0.01643487438559532, 0.007949406281113625, 0.0480886772274971, 0.07902336865663528, -0.0325559563934803, -0.05117430165410042, -0.013597668148577213, 0.011701839044690132, 0.0569533109664917, 0.03794272243976593, -0.004174091853201389, 0.00634122034534812, -0.00558615755289793, -1.8858694602386095e-05, 0.04738264158368111, 0.001068037934601307, 0.04727804660797119, 0.0001908086269395426, -0.02042265050113201, 0.004713422618806362, -0.004389823880046606, 0.014630567282438278, -0.01064932718873024, -0.013584593310952187, -0.03033326007425785, 0.013780713081359863, -0.02101101167500019, 0.059202153235673904, 0.027116887271404266, 0.012440558522939682, 0.02403126284480095, 0.026463154703378677, 0.005903218407183886, 0.0023975695949047804, -0.018592195585370064, 0.00019755025277845562, 0.03653065860271454, -0.010479356162250042, -0.003588999854400754, 0.055802736431360245, 0.010283236391842365, 0.008367795497179031, 0.013251189142465591, -0.00879926048219204, -0.027849070727825165, -0.0034484469797462225, -0.031170038506388664, 0.027247633785009384, -0.03373267501592636, 0.01983429118990898, -0.05904525890946388, -0.028424356132745743, -0.02442350424826145, 0.03888409957289696, -0.01280011236667633, -0.05611652880907059, 0.012185602448880672, 0.008786185644567013, -0.017258578911423683, 0.02461962401866913, 0.049082349985837936, -0.018670644611120224, -0.020527249202132225, 0.0047036162577569485, 0.03736743703484535, 0.04317259415984154, -0.04965763911604881, -0.012407871894538403, 0.03692289814352989, 0.011342285200953484, 0.049369994550943375, -0.036216866225004196, 0.042335815727710724, -0.07332281023263931, -0.015218928456306458, -0.01379378791898489, 0.0017846939153969288, 0.04029616713523865, 0.07295671850442886, -0.005285439547151327, 0.014264476485550404, -0.03629531338810921, 0.048350170254707336, 0.025574075058102608, 0.05601193383336067, 0.026306258514523506, -0.042414262890815735, -0.013950684107840061, -0.01194372121244669, -0.010283236391842365, 0.01975584216415882, -0.0362430140376091, -0.00976024940609932, -0.023312155157327652, -0.04424471780657768, -0.026933841407299042, 0.03203296661376953, -0.026685424149036407, -0.031483832746744156, 0.009845234453678131, 0.014251401647925377, 0.01157762948423624, 0.018448375165462494, -0.018526822328567505, 0.002315852791070938, -0.014251401647925377, -0.018474522978067398, -0.05305705592036247, 0.03904099762439728, 0.030882395803928375, 0.044401615858078, 0.011080792173743248, 0.013081218115985394, 0.020148083567619324, -0.06040502339601517, 0.009034604765474796, 0.0149835841730237, -0.004337525460869074, 0.0070341783575713634, -0.039459384977817535, 0.016552545130252838, 0.061712492257356644, -0.04764413833618164, -0.00752447871491313, -0.023469051346182823, -0.035092443227767944, 0.013676116243004799, 0.010355147533118725, 0.010701626539230347, 0.04539529234170914, 0.013414622284471989, 0.0034353723749518394, -0.028058264404535294, 0.01648717187345028, 0.016094932332634926, 0.02212235890328884, -0.007962480187416077, 0.033471181988716125, 0.022357704117894173, 0.0058836061507463455, -0.018016910180449486, 0.010015205480158329, -0.02077566832304001, 0.020945638418197632, -0.01923285610973835, -0.013950684107840061, -0.06814523786306381, -0.02233155444264412, 0.012479783035814762, 0.006550414953380823, 0.03943323716521263, -0.04539529234170914, -0.06312455981969833, 0.01657869480550289, 0.019115183502435684, -0.03247750550508499, 0.04047921299934387, 0.04040076211094856, -0.03959013149142265, 0.026803094893693924, -0.025848643854260445, -0.023952815681695938, -0.02604476362466812, 0.03247750550508499, 0.008184750564396381, 0.010806223377585411, 0.007557165343314409, 0.023835143074393272, -0.013702264986932278, 0.011786825023591518, -0.0232990812510252, 0.02588786743581295, -0.012656291015446186, -0.001483159139752388, 0.028450505807995796, -0.03885795176029205, -0.01135536003857851, -0.03519704192876816, -0.01975584216415882, 0.03069934993982315, -0.008792722597718239, 0.03511859104037285, 0.007393731735646725, -0.026528527960181236, -0.030385557562112808, -0.006406593602150679, -0.02271072007715702, 0.05637802183628082, 0.010708163492381573, 0.04793177917599678, 0.0037164778914302588, 0.05135734751820564, 0.013859161175787449, -0.02188701555132866, 0.0062725781463086605, -0.022004688158631325, -0.006540609057992697, 0.002038015751168132, 0.03891025111079216, 0.010407445952296257, -0.00972102489322424, -0.016160305589437485, 0.004948766436427832, 0.0021393445786088705, 0.011656077578663826, -0.016604844480752945, -0.0076486882753670216, 0.025417178869247437, 0.014486745931208134, -0.023926666006445885, -0.014695941470563412, 0.058103881776332855, -0.034804798662662506, 0.030960844829678535, 0.005962054245173931, -0.023874366655945778, 0.010257086716592312, -0.027116887271404266, -0.028895044699311256, -0.012453633360564709, 0.02442350424826145, -0.009969444014132023, 0.01494435966014862, 0.053292397409677505, -0.015519645996391773, 0.008831947110593319, 0.032346758991479874, -0.028947344049811363, -0.006347757298499346, 0.0012429117923602462, -0.026306258514523506, -0.00917842611670494, -0.008073614910244942, -0.036190714687108994, 0.05496595799922943, -0.01937667652964592, -0.019481273368000984, 0.01774234138429165, 0.012917784973978996, 0.02484189346432686, -0.003015348222106695, -0.005030483473092318, 0.006507922429591417, -0.007831733673810959, 0.002564271679148078, 0.016029559075832367, 0.01253861840814352, -0.03734128922224045, 0.015375824645161629, -0.06155559793114662, -0.027247633785009384, -0.01042705774307251, -0.04032231494784355, -0.020461875945329666, 0.003046400612220168, 0.009590278379619122, -0.010917358100414276, 0.012185602448880672, -0.05496595799922943, -0.022462300956249237, -0.04458466172218323, -0.0013221771223470569, 0.027247633785009384, 0.016382575035095215, 0.023259857669472694, -0.038570307195186615, -9.969444363377988e-05, -0.01753314770758152, 0.01438214909285307, -0.022056985646486282, -0.010335534811019897, -0.016408724710345268, 0.0584176741540432, -0.03966858237981796, -0.024606548249721527, 0.0006038868450559676, -0.025038013234734535, 0.03307894244790077, 0.0005127726471982896, -0.008969230577349663, 0.017323952168226242, 0.05279555916786194, -0.01944204978644848, 0.005223334766924381, -0.022396927699446678, 0.009989055804908276, 0.03755048289895058, -0.002240673406049609, -0.00953797996044159, -0.0067530726082623005, 0.02115483395755291, 0.020318053662776947, 0.003098699264228344, 0.026907693594694138, 0.01334924902766943, -0.024279681965708733, 0.035981521010398865, 0.030934695154428482, 0.006916506215929985, -0.05643032118678093, 0.013545368798077106, -0.012983158230781555, 0.024645773693919182, -0.013545368798077106, -0.032948195934295654, 0.015192778781056404, -0.00707993982359767, -0.021926239132881165, -0.012022169306874275, -0.002747317310422659, 0.012303274124860764, 0.007191074546426535, -0.035170890390872955, 0.011270374990999699, 0.03530163690447807, -0.031980667263269424, -0.013715339824557304, 0.011996019631624222, 0.0013524122769013047, 0.023913590237498283, -0.03673985227942467, -0.032582104206085205, 0.032948195934295654, -0.03888409957289696, -0.023534424602985382, 0.0013695728266611695, -0.006148368585854769, -0.005811695475131273, 0.027090737596154213, -0.07243373245000839, 0.0044388542883098125, 0.042361967265605927, -0.016395648941397667, -0.03017636388540268, 0.01567654311656952, 0.02101101167500019, 0.012813187204301357, 0.044035524129867554, 0.006609251257032156, -0.017925387248396873, 0.007511403877288103, -0.014748239889740944, 0.0032098342198878527, -0.031039291992783546, -0.06019582971930504, -0.029548779129981995, -0.010165564715862274, -0.04549988731741905, 0.03297434374690056, 0.031614579260349274, -0.0354846827685833, 0.01042705774307251, 0.011054642498493195, 0.020357277244329453, 0.018526822328567505, 0.014852837659418583, 0.01759852096438408, -0.03470020368695259, -0.004036807455122471, -0.04074070602655411, 0.029156537726521492, -0.008446243591606617, 0.02698614075779915, 0.043094146996736526, -0.014525970444083214, 0.015885736793279648, 0.02729993313550949, 0.03888409957289696, -0.020318053662776947, 0.0026116673834621906, -0.014355999417603016, 0.033183541148900986, 0.03885795176029205, 0.02315525896847248, 0.008753499016165733, -0.004667661152780056, -0.008746961131691933, -0.031170038506388664, 0.02506416290998459, -0.004007389768958092, -0.01774234138429165, -0.021690895780920982, -0.014434447512030602, -0.0024204503279179335, -0.00920457486063242, 0.031170038506388664, -0.036347612738609314, -0.018683718517422676, -0.04246656224131584, -0.028659699484705925, 0.02226618118584156, -0.049814533442258835, 0.018396075814962387, -0.009152276441454887, 0.017663894221186638, 0.026057839393615723, 0.048768557608127594, 9.387212048750371e-05, 0.03211141750216484, 0.0054031116887927055, 0.00795594323426485, -0.023704396560788155, 0.012250975705683231, 0.0347525030374527, 0.0028421087190508842, 0.026463154703378677, 0.0006124670617282391, -0.01915440708398819, -0.013140054419636726, -0.014892061240971088, 0.01612108200788498, 0.02359979785978794, -0.009152276441454887, -0.04547373950481415, 0.009368008933961391, 0.055436644703149796, -0.027718322351574898, 0.0008629289222881198, 0.007367582526057959, -0.011695302091538906, 0.029339583590626717, 0.007890569977462292, -0.03645221143960953, -0.017493922263383865, 0.005030483473092318, 0.017023233696818352, -0.024985715746879578, -0.02566559799015522, 0.028790447860956192, -0.015179703943431377, -0.031248487532138824, -0.025103386491537094, 0.001869679312221706, -0.0015379092656075954, 0.0011187023483216763, 0.0014545582234859467, -0.008125914260745049, -0.018696794286370277, -0.014695941470563412, 0.02787521854043007, -0.031091591343283653, -0.0317976251244545, 0.0214424766600132, -0.03778582811355591, 0.024305831640958786, -0.013963758945465088, -0.024384278804063797, -0.020749518647789955, 0.02388744242489338, 0.015401974320411682, -0.03851800784468651, -0.006507922429591417, 0.003834150033071637, 0.004206778481602669, -0.0347525030374527, 0.018330702558159828, -0.04147288575768471, -0.03365422785282135, 0.052194125950336456, -0.014591343700885773, -0.013479995541274548, -0.025129536166787148, -0.008492005057632923, 0.027561426162719727, 0.013532294891774654, -0.009322247467935085, -0.05214182659983635, -0.05857456848025322, 0.01819995604455471, -0.035327788442373276, -0.0038243441376835108, 0.014878986403346062, -0.006442548707127571, -0.03713209182024002, 0.0131269795820117, -0.010923895984888077, -0.007093014195561409, -0.01686633750796318, 0.0732182115316391, -0.00364129850640893, 0.016304126009345055, -0.01132267341017723, 0.009590278379619122, 0.005942442454397678, -0.03762893006205559, 0.03470020368695259, 0.0008686491055414081, 0.012211752124130726, 0.031039291992783546, -0.060614220798015594, 0.002240673406049609, -0.026371631771326065, -0.013846087269484997, -0.015101255849003792, 0.05658721923828125, -0.015114330686628819, -0.010570879094302654, 0.014617493376135826, -0.009283022955060005, -0.034935545176267624, -0.006171249318867922, -0.018683718517422676, -0.02484189346432686, -0.002814325038343668, 0.008629289455711842, 0.02248845063149929, -0.011054642498493195, 0.0007072585285641253, 0.023534424602985382, 0.028581252321600914, 0.006403324659913778, 0.022501526400446892, -0.004196972586214542, -0.03744588419795036, 0.030516304075717926, 0.013689191080629826, -0.015571944415569305, 0.00032911423477344215, -0.012120229192078114, -0.02558715082705021, -0.03639991208910942, -0.022749943658709526, 0.011106940917670727, 0.005896680988371372, 0.03289589658379555, 0.029182687401771545, -0.03862260654568672, -0.01449982076883316, -0.12520314753055573, -0.01769004389643669, 0.01612108200788498, -0.013872236013412476, -0.004654586315155029, 0.0032229088246822357, 0.034072618931531906, 0.017624668776988983, -0.033549629151821136, -0.033837273716926575, -0.009596815332770348, -0.02928728424012661, -0.039093296974897385, -0.029156537726521492, 0.026907693594694138, 0.012414409779012203, 0.0029548779129981995, 0.0073218210600316525, 0.0480886772274971, -0.011316136457026005, 0.03396802023053169, -0.026450078934431076, -0.051069702953100204, 0.007047252729535103, 0.02420123480260372, -0.02669849805533886, -0.02026575431227684, 0.011113478802144527, 0.023952815681695938, -0.023168334737420082, -0.0065536838956177235, -0.01065586507320404, 0.011636465787887573, -0.008792722597718239, -0.0292088370770216, 0.027849070727825165, 0.002498898422345519, 0.012715127319097519, 0.021952388808131218, 0.012152915820479393, -7.451546844094992e-05, -0.03540623560547829, 0.0042198533192276955, -0.005141618195921183, 0.04688580334186554, 0.0015665101818740368, -0.009439919143915176, 0.018958287313580513, -0.01813458278775215, 0.03313124179840088, 0.027247633785009384, 0.0125778429210186, -0.03959013149142265, 0.007799047045409679, 0.011930646374821663, 0.05873146653175354, -0.05826077610254288, -0.010577416978776455, -0.0002974489761982113, -0.00508605083450675, -0.003860299475491047, -0.0038766427896916866, -0.0010753924725577235, -0.04377403110265732, 0.01478746347129345, -0.015611168928444386, -0.015846513211727142, -0.006713848561048508, -0.02114175818860531, -0.008165137842297554, 0.004370212089270353, 0.00632160808891058, -0.021926239132881165, -0.015218928456306458, -0.017284728586673737, 0.03135308623313904, 0.02284146659076214, -0.021507849916815758, -0.015611168928444386, 0.02434505522251129, 0.039982374757528305, -0.018304552882909775, 0.003268670290708542, 0.018317626789212227, -0.023089885711669922, -0.008374333381652832, 0.015571944415569305, 0.006233354099094868, 0.027404529973864555, 0.026606975123286247, 0.010642790235579014, -0.03778582811355591, -0.0071453130804002285, 0.04223121702671051, -0.013257726095616817, 0.019729692488908768, -0.012453633360564709, -0.00678575923666358, -0.015741916373372078, -0.009289560839533806, 0.021873941645026207, 0.028581252321600914, -0.026384705677628517, 0.019716618582606316, 0.01997811160981655, 0.01434292457997799, -0.010002130642533302, 0.0017520071705803275, -0.023926666006445885, 0.03417721390724182, -0.008106302469968796, 0.001496233744546771, 0.002876429818570614, 0.0005560825229622424, -0.026437005028128624, 0.0037197466008365154, 0.08153370767831802, -0.023037588223814964, -0.013911460526287556, 0.012329423800110817, 0.01357151847332716, 0.0347786508500576, -0.031039291992783546, 0.06281076371669769, -0.01191103458404541, 0.008858095854520798, -0.006092801224440336, -0.05133119598031044, -0.027482978999614716, 0.0011236054124310613, 0.026659274473786354, 0.03951168432831764, -0.004291763994842768, -0.0018762167310342193, 0.014460597187280655, -0.04950074106454849, 0.041760530322790146, -0.008276272565126419, 0.02410971187055111, -0.013362323865294456, 0.008191287517547607, 0.007093014195561409, -0.0021033892408013344, -0.031405381858348846, -0.01627797819674015, -0.019141333177685738, 0.019546648487448692, 0.0010843813652172685, -0.0003801872080657631, 0.032346758991479874, -0.011348823085427284, -0.03485709801316261, -0.03490939736366272, 0.02573097124695778, -0.01308775506913662, 0.08268427848815918, 0.00412179296836257, -0.04518609493970871, -0.011093867011368275, -0.03174532577395439, -0.007217223756015301, 0.03681829944252968, 0.014512895606458187, -0.010884671472012997, -0.02020038105547428, -0.009989055804908276, -0.00340268574655056, -0.006432742811739445, -0.039616283029317856, -0.00033953311503864825, -0.011074254289269447, 0.003005542326718569, 0.028528952971100807, -0.004929154645651579, 0.012159452773630619, 0.015702690929174423, 0.027456829324364662, -0.010355147533118725, -0.00821089930832386, 0.0414205901324749, -0.008943081833422184, 0.02537795528769493, 0.016447948291897774, 0.028424356132745743, 0.02115483395755291, 0.013519220054149628, -0.0009078731527552009, 0.04016542062163353, -0.031091591343283653, -0.03490939736366272, 0.026672348380088806, 0.01216599065810442, -0.011924108490347862, 0.018435299396514893, -0.021180983632802963, 0.031614579260349274, 0.07002799212932587, 0.01707553304731846, 0.004742840304970741, -0.0019089033594354987, 0.03888409957289696, -0.00532793253660202, -0.027038440108299255, 0.00412179296836257, 0.004533645696938038, 0.030202511698007584, -0.0007289134664461017, 0.0029532434418797493, -0.048271723091602325, 0.032503657042980194, -0.021808568388223648, -0.014212178066372871, 0.05125274881720543, -0.03579847514629364, -0.028005966916680336, 0.026306258514523506, -0.026371631771326065, 0.003971434198319912, 0.002806153381243348, -0.02899964153766632, -0.016225678846240044, -0.030751649290323257, -0.039093296974897385, 0.0004314644611440599, 0.007982092909514904, 0.01161685399711132, 0.010342072695493698, -0.006599444895982742, 0.0354846827685833, 0.004909542389214039, 0.00506643857806921, 0.01937667652964592, -0.026371631771326065, -0.003327506361529231, 0.03098699264228344, -0.0033503868617117405, -0.01142727117985487, -0.023874366655945778, 0.0012085908092558384, -0.00018090046069119126, 0.02077566832304001, 0.0002175708650611341, 0.010021742433309555, -0.009897532872855663, 0.01634335145354271, 0.005233141127973795, 0.03062090277671814, 0.02737838216125965, -0.001340154791250825, 0.026280108839273453, -0.0038047321140766144, 0.036190714687108994, 0.012414409779012203, 0.004945497959852219, 0.03485709801316261, -0.012427483685314655, 0.012630141340196133, 0.004357137251645327, -0.014186028391122818, 0.0027669293340295553, -0.013715339824557304, 0.024959566071629524, 0.007315283641219139, 0.005059901624917984, -0.008701199665665627, -0.011832586489617825, -0.013440771959722042, 0.004004120826721191, 0.03297434374690056, 0.020527249202132225, -0.006125487852841616, -0.004161017015576363, -0.0018108432414010167, -0.012525544501841068, 0.011316136457026005, -0.03718439117074013, -0.05554124340415001, -0.02152092382311821, 0.010629715397953987, -0.015611168928444386, -0.05569814145565033, 0.007184537127614021, 0.008563916198909283, -0.015859587118029594, 0.022318480536341667, -0.021416326984763145, 0.004174091853201389, -0.04332949221134186, -0.003268670290708542, -0.0036184180062264204, 0.03352348133921623, 0.039093296974897385, -0.009636039845645428, -0.02174319326877594, -0.00846585538238287, -0.008511616848409176, 0.019585872069001198, 0.008740424178540707, 0.010028280317783356, -0.019128257408738136, -0.028345907106995583, 0.016657143831253052, 0.021638596430420876, 0.01357151847332716, -0.007870958186686039, 0.0038995235227048397, -0.029470330104231834, -0.04691195487976074, 0.037681229412555695, 0.008230511099100113, -0.04654586315155029, 0.010302848182618618, 0.004007389768958092, -0.0048964680172502995, -0.01988658867776394, 0.023992039263248444, 0.00532793253660202, 0.012597454711794853, -0.041682083159685135, 0.036190714687108994, -0.02826745994389057, -0.007700987160205841, 0.001336068962700665, 0.01357151847332716, 0.016604844480752945, 0.015768064185976982, 0.0067334603518247604, -0.0015869393246248364, -0.02582249417901039, -0.020435726270079613, 0.046336669474840164, 0.015571944415569305, 0.0054913656786084175, 0.019193630665540695, -0.033628080040216446, 0.021782418712973595, -0.03891025111079216, 0.010387834161520004, -0.009675263427197933, -0.02485496737062931, -0.016696367412805557, -0.038648758083581924, -0.015140480361878872, 0.014146804809570312, -0.010544730350375175, -0.018905987963080406, 0.021115608513355255, 0.007779435254633427, -0.00133116589859128, 0.011263837106525898, 0.0650596097111702, 0.009263411164283752, -0.00994983222335577, 0.011917571537196636, 0.005367156583815813, 0.008099764585494995, 0.0026525259017944336, -0.0075375535525381565, -0.01604263298213482, -0.017650818452239037, -0.01508818194270134, 0.023795919492840767, -0.00463824300095439, 0.0026165705639868975, 0.03734128922224045, -0.028816595673561096, -0.02242307737469673, 0.022004688158631325, 0.03870105370879173, -0.010577416978776455, 0.03608611971139908, 0.055593542754650116, -0.018108433112502098, -0.02069721929728985, 0.015794213861227036, -0.0031902221962809563, 0.01678789034485817, -0.042126622051000595, 0.01213330402970314, 0.06725616008043289, 0.02706458978354931, -0.04000852257013321, 0.0020739713218063116, 0.004425779450684786, -0.0465981625020504, -0.010322460904717445, -0.023246781900525093, -0.006883819587528706, -0.015297376550734043, 0.018984436988830566, -0.018592195585370064, -0.0039027922321110964, 0.023704396560788155, -0.005948979873210192, 0.016461022198200226, 0.02714303694665432, 0.0012625238159671426, -0.015127405524253845, -0.009629501961171627, 0.00023636571131646633, 0.004324450623244047, -0.04570908471941948, -0.004461735021322966, -0.03485709801316261, -0.0007840722682885826, -0.04738264158368111, 0.010034817270934582, 0.030856246128678322, -0.0014905135612934828, 0.020213456824421883, -0.045081499963998795, 0.0009863212471827865, 0.010309386067092419, 0.01010019052773714, -0.0037164778914302588, -0.04769643396139145, 0.01415987964719534, -0.009217649698257446, -0.005906486883759499, 0.03671370446681976, -0.0008089958573691547, 0.007419881410896778, 0.017794640734791756, -0.03639991208910942, 0.014709015376865864, 0.009439919143915176, 0.013270800933241844, -0.011348823085427284, 0.007857883349061012, 0.023952815681695938, -0.0017863282701000571, -0.03224216401576996, -0.031117741018533707, 0.01715398021042347, -0.015885736793279648, -0.0067334603518247604, 0.028293609619140625, 0.009014992043375969, -0.04667660966515541, -0.013290412724018097, 0.02787521854043007, -7.456653838744387e-05, 0.016304126009345055, 0.007936331443488598, -0.0028421087190508842, 0.03226831182837486, 0.013780713081359863, 0.026881543919444084, -0.01634335145354271, -0.019259003922343254, 0.028005966916680336, -0.0004751829255837947, -0.021703969687223434, 0.04230966791510582, -0.016408724710345268, 0.021324804052710533, -0.008812334388494492, -0.030673200264573097, -0.005027214530855417, -0.00017477170331403613, 0.002333830576390028, -0.0002917288220487535, -0.005233141127973795, 0.007347970735281706, -0.004533645696938038, 0.004497690126299858, -0.0069295805878937244, 0.03603382036089897, -0.02018730714917183, -0.026306258514523506, 0.031117741018533707, 0.005694023333489895, -0.00798862986266613, -0.01805613376200199, -0.00438328692689538, 0.022880692034959793, 0.0025397567078471184, -0.03344503417611122, -0.004648048896342516, -0.025024939328432083, -0.004069494549185038, -0.012009094469249249, 0.0041348678059875965, 0.012257513590157032, 0.05444297194480896, -0.03655680641531944, -0.0021540536545217037, -0.007792509626597166, 0.006409862078726292, -0.0011946989689022303, -0.042649608105421066, 0.029548779129981995, -0.021024087443947792, -0.03595537319779396, -0.008223974145948887, 0.017467772588133812, -0.001500319573096931, -0.005707098171114922, -0.001727492199279368, 0.014931285753846169, 0.04842861741781235, -0.02388744242489338, 0.012708589434623718, -0.005553470458835363, 0.010074041783809662, -0.007903644815087318, 0.054024580866098404, -0.00949875544756651, -0.06553030014038086, -0.009119589813053608, 0.019572796300053596, 0.02648930251598358, -0.0026476229541003704, 0.016617918387055397, -0.02418815903365612, 0.021952388808131218, 0.004164285957813263, 0.011067717336118221, 0.007759822998195887, 0.011342285200953484, 0.00010372920223744586, -0.025704821571707726, 0.02269764617085457, 0.0005021494580432773, 0.011662615463137627, -0.007400269154459238, 0.0036511046346277, 0.0073022092692554, 0.015781139954924583, -0.0019791796803474426, 0.0017830595606938004, -0.032137565314769745, 0.02626703307032585, 0.033915720880031586, -0.00438328692689538, 0.012715127319097519, -0.006128756795078516, 0.0021262699738144875, -0.01627797819674015, -0.024671923369169235, -0.012826262041926384, 0.04385247826576233, -0.015428123064339161, -0.005615575239062309, -0.0030349602457135916, 0.031013142317533493, 0.014591343700885773, -0.006524265743792057, 0.007138775661587715, 0.003981240093708038, -0.038936398923397064, -0.014892061240971088, 0.021024087443947792, 0.003147729439660907, -0.014643642120063305, 0.010753924958407879, -0.01864449493587017, 0.015428123064339161, -0.004066225606948137, 0.0021001205313950777, -0.0006218645139597356, 0.0005168584757484496, 0.022527674213051796, -0.012427483685314655, 0.020474949851632118, -0.0005029666353948414, 0.025874793529510498, 0.02256689965724945, 0.007583315018564463, 0.0022014493588358164, 0.007890569977462292, 0.026959991082549095, 0.005756128113716841, -0.020174233242869377, -0.011067717336118221, -0.025639448314905167, 0.026083987206220627, 0.017990760505199432, 0.016748666763305664, 0.012394797056913376, 0.006282384041696787, 0.004396361298859119, 0.015022807754576206, -0.01589881256222725, 0.006635400466620922, 0.007459105458110571, -0.013649966567754745, -0.003002273617312312, 0.045447591692209244, -0.009328784421086311, -0.040270015597343445, 0.01508818194270134, 0.002474383218213916, -0.006243159994482994, 0.01827840320765972, 0.0005082782008685172, 0.029757972806692123, 0.044401615858078, -0.01613415591418743, 0.027169186621904373, 0.0247634444385767, 0.02344290167093277, -0.023116035386919975, -0.012930858880281448, -0.01899751089513302, -0.015127405524253845, -0.024985715746879578, -0.020461875945329666, -0.0034353723749518394, 0.010074041783809662, 0.006818445865064859, 0.0063837128691375256, 0.007099551614373922, -0.000899701495654881, 0.002302778186276555, -0.0071257008239626884, -0.011218075640499592, -0.02197853848338127, -0.019912738353013992, -0.013911460526287556, 0.005448873154819012, -0.015506571158766747, 0.012250975705683231, 0.0021703969687223434, -0.004128330387175083, 0.010747388005256653, 0.015624243766069412, -0.008361258544027805, 0.013649966567754745, -0.022213881835341454, -0.019141333177685738, -0.012009094469249249, -0.013859161175787449, -0.022396927699446678, 0.006086263805627823, -0.0024792863987386227, -0.0006141014164313674, 0.007661763112992048, -0.010603565722703934, 0.01116577722132206, 0.03069934993982315, -0.0003270713204983622, 0.005435798317193985, -0.0022112554870545864, 0.027247633785009384, -0.002739145653322339, 0.03506629541516304, -0.004144673701375723, -0.0015403608558699489, -0.017559295520186424, -0.004654586315155029, -0.02818901091814041, 0.03417721390724182, -0.008962693624198437, -0.008923470042645931, 0.02056647278368473, 0.002726071048527956, 0.004867049865424633, -0.053867682814598083, -0.02093256451189518, 0.016029559075832367, -0.015166630037128925, 0.017663894221186638, -0.02604476362466812, 0.020880265161395073, 0.0621308833360672, 0.007995166815817356, 0.04100219905376434, -0.003075818531215191, 0.027849070727825165, 0.011015418916940689, 0.0016277977265417576, -0.014212178066372871, 0.00015985840582288802, 0.022004688158631325, 0.02588786743581295, -0.03885795176029205, 0.03734128922224045, -0.014120655134320259, -0.04563063755631447, 0.006132025271654129, 0.00555020198225975, 0.02403126284480095, -0.014002983458340168, 0.022946065291762352, 0.0010345340706408024, -0.004249271471053362, -0.0026606975588947535, 0.002721167868003249, 0.017846940085291862, -0.026437005028128624, 0.015467347577214241, -0.021703969687223434, 0.037472035735845566, -0.009086903184652328, 0.021207131445407867, 0.03260825201869011, -0.004484615288674831, 0.004337525460869074, 0.00216385954990983, -0.024645773693919182, 0.017807714641094208, 0.023612873628735542, -0.006177786737680435, -0.027352232486009598, -0.017193205654621124, -0.02722148597240448, 0.03713209182024002, -0.052324872463941574, 0.03033326007425785, -0.006609251257032156, -0.006011084653437138, 0.014774389564990997, 0.008008241653442383, -0.012773962691426277, 0.02580942027270794, 0.004971647169440985, -0.010342072695493698, -0.010577416978776455, 0.00026374083245173097, -0.013872236013412476, -0.021285580471158028, 0.015401974320411682, -0.013401547446846962, 0.0003620052302721888, -0.025783270597457886, -0.01737625151872635, 0.02071029506623745, 0.024881117045879364, -0.0266331247985363, 0.011178852058947086, -0.0029891987796872854, 0.0070341783575713634, -0.002628010930493474, 0.005406380631029606, -0.007844808511435986, 0.01161031611263752, 0.013336174190044403, -0.009191500954329967]
metadata : {"source": "pydantic_ai_docs", "crawled_at": "2025-03-14T10:15:03.245415", "url_path": "/examples/sql-gen/", "chunk_size": 4596}
updated_dt: 2025-03-14T10:15:03.245415
---
```
importasyncio
importsys
fromcollections.abcimport AsyncGenerator
fromcontextlibimport asynccontextmanager
fromdataclassesimport dataclass
fromdatetimeimport date
fromtypingimport Annotated, Any, Union
importasyncpg
importlogfire
fromannotated_typesimport MinLen
fromdevtoolsimport debug
frompydanticimport BaseModel, Field
fromtyping_extensionsimport TypeAlias
frompydantic_aiimport Agent, ModelRetry, RunContext
frompydantic_ai.format_as_xmlimport format_as_xml
# 'if-token-present' means nothing will be sent (and the example will work) if you don't have logfire configured
logfire.configure(send_to_logfire='if-token-present')
logfire.instrument_asyncpg()
DB_SCHEMA = """
CREATE TABLE records (
  created_at timestamptz,
  start_timestamp timestamptz,
  end_timestamp timestamptz,
  trace_id text,
  span_id text,
  parent_span_id text,
  level log_level,
  span_name text,
  message text,
  attributes_json_schema text,
  attributes jsonb,
  tags text[],
  is_exception boolean,
  otel_status_message text,
  service_name text
);
"""
SQL_EXAMPLES = [
  {
    'request': 'show me records where foobar is false',
    'response': "SELECT * FROM records WHERE attributes->>'foobar' = false",
  },
  {
    'request': 'show me records where attributes include the key "foobar"',
    'response': "SELECT * FROM records WHERE attributes ? 'foobar'",
  },
  {
    'request': 'show me records from yesterday',
    'response': "SELECT * FROM records WHERE start_timestamp::date > CURRENT_TIMESTAMP - INTERVAL '1 day'",
  },
  {
    'request': 'show me error records with the tag "foobar"',
    'response': "SELECT * FROM records WHERE level = 'error' and 'foobar' = ANY(tags)",
  },
]

@dataclass
classDeps:
  conn: asyncpg.Connection

classSuccess(BaseModel):
"""Response when SQL could be successfully generated."""
  sql_query: Annotated[str, MinLen(1)]
  explanation: str = Field(
    '', description='Explanation of the SQL query, as markdown'
  )

classInvalidRequest(BaseModel):
"""Response the user input didn't include enough information to generate SQL."""
  error_message: str

Response: TypeAlias = Union[Success, InvalidRequest]
agent: Agent[Deps, Response] = Agent(
  'google-gla:gemini-1.5-flash',
  # Type ignore while we wait for PEP-0747, nonetheless unions will work fine everywhere else
  result_type=Response, # type: ignore
  deps_type=Deps,
  instrument=True,
)

@agent.system_prompt
async defsystem_prompt() -> str:
  return f"""\
Given the following PostgreSQL table of records, your job is to
write a SQL query that suits the user's request.
Database schema:
{DB_SCHEMA}
today's date = {date.today()}
{format_as_xml(SQL_EXAMPLES)}
"""

@agent.result_validator
async defvalidate_result(ctx: RunContext[Deps], result: Response) -> Response:
  if isinstance(result, InvalidRequest):
    return result
  # gemini often adds extraneous backslashes to SQL
  result.sql_query = result.sql_query.replace('\\', '')
  if not result.sql_query.upper().startswith('SELECT'):
    raise ModelRetry('Please create a SELECT query')
  try:
    await ctx.deps.conn.execute(f'EXPLAIN {result.sql_query}')
  except asyncpg.exceptions.PostgresError as e:
    raise ModelRetry(f'Invalid query: {e}') frome
  else:
    return result

async defmain():
  if len(sys.argv) == 1:
    prompt = 'show me logs from yesterday, with level "error"'
  else:
    prompt = sys.argv[1]
  async with database_connect(
    'postgresql://postgres:postgres@localhost:54320', 'pydantic_ai_sql_gen'
  ) as conn:
    deps = Deps(conn)
    result = await agent.run(prompt, deps=deps)
  debug(result.data)

# pyright: reportUnknownMemberType=false
# pyright: reportUnknownVariableType=false
@asynccontextmanager
async defdatabase_connect(server_dsn: str, database: str) -> AsyncGenerator[Any, None]:
  with logfire.span('check and create DB'):
    conn = await asyncpg.connect(server_dsn)
    try:
      db_exists = await conn.fetchval(
        'SELECT 1 FROM pg_database WHERE datname = $1', database
      )
      if not db_exists:
        await conn.execute(f'CREATE DATABASE {database}')
    finally:
      await conn.close()
  conn = await asyncpg.connect(f'{server_dsn}/{database}')
  try:
    with logfire.span('create schema'):
      async with conn.transaction():
        if not db_exists:
          await conn.execute(
            "CREATE TYPE log_level AS ENUM ('debug', 'info', 'warning', 'error', 'critical')"
          )
          await conn.execute(DB_SCHEMA)
    yield conn
  finally:
    await conn.close()

if __name__ == '__main__':
  asyncio.run(main())

```

© Pydantic Services Inc. 2024 to present