---
url: https://ai.pydantic.dev/api/pydantic_graph/persistence/
session_id: pydantic_ai_docs
chunk_number: 12
title: Pydantic Graph Persistence Methods
summary: This documentation chunk outlines various asynchronous methods for persisting state snapshots in a Pydantic graph. It covers functions for saving node snapshots, conditionally saving a new node snapshot, saving end snapshots, and managing the recording of runs using context managers.
embedding: [0.033465124666690826, 0.05230491980910301, -0.024922290816903114, -0.07636153697967529, 0.010188751854002476, 0.029273441061377525, 0.03587989881634712, -0.013919122517108917, -0.021152054890990257, -0.04084613174200058, 0.01886257529258728, 0.027952149510383606, 0.027564873918890953, -0.03052639029920101, -0.024945072829723358, 0.03649498149752617, -0.02309982106089592, 0.03141484409570694, 0.019238458946347237, 0.026835886761546135, -0.004413797054439783, -0.01557073649019003, 0.027245942503213882, -0.003271905006840825, -0.011105682700872421, -0.03189324215054512, -0.004342606756836176, 0.028225520625710487, 0.00973313394933939, -0.029273441061377525, -0.007432264741510153, -0.019694076851010323, -0.0047042532823979855, 0.0030811151955276728, 0.0010037828469648957, 0.017677968367934227, 0.01416971255093813, 0.024079399183392525, -0.022974524646997452, 0.005322184879332781, 0.019785201177001, -0.11691151559352875, -0.001799690187908709, -0.0056610507890582085, -0.0009304569102823734, 0.0030925055034458637, 0.020411675795912743, 0.0575445219874382, 0.03262223303318024, -0.0012372869532555342, -0.03993489593267441, -0.027997711673378944, -0.005316489841789007, 0.029546812176704407, -0.014374740421772003, -0.00229232688434422, 0.008502966724336147, 0.02765599824488163, -0.030549170449376106, -0.004433730151504278, 0.06055159866809845, -0.010632979683578014, 0.002307988703250885, 0.06082497164607048, -0.013691313564777374, 0.0070620751939713955, -0.03405742719769478, 0.04979902133345604, -0.03114147298038006, -0.038226328790187836, 0.02270115539431572, 0.05471969395875931, -0.04414936155080795, -0.06059716269373894, -0.012244727462530136, -0.02201772853732109, 0.030503608286380768, 0.06656575202941895, 0.0036221612244844437, -0.005233909003436565, -0.0027351302560418844, 0.036950599402189255, -0.03394352272152901, 0.029683496803045273, -0.020571142435073853, -0.01006915234029293, -0.08460821956396103, -0.027883807197213173, 0.0062362682074308395, -0.003576599294319749, 0.007295579183846712, -0.008223900571465492, -0.016356676816940308, 0.001737042679451406, 0.053535085171461105, 0.0027522160671651363, -0.002081603743135929, 0.004319825675338507, -0.016436411067843437, 0.007010818459093571, 0.020958416163921356, 0.01454559713602066, -0.06501665711402893, -0.017154008150100708, 0.007187370210886002, 0.038864195346832275, 0.042463574558496475, 0.019375145435333252, 0.019876325502991676, 0.004786834120750427, -0.08469934016466141, -0.03660888597369194, 0.006691885646432638, 0.010815226472914219, -0.021573500707745552, -0.07900411635637283, 0.007842320948839188, 0.024762826040387154, 0.011384748853743076, -0.002130012959241867, -0.03884141519665718, 0.0034199808724224567, -0.044764444231987, -0.013702703639864922, 0.0261752400547266, -0.020445846021175385, -0.03701894357800484, 0.00019399350276216865, -0.042463574558496475, -0.008343500085175037, -0.010758274234831333, -0.03865916654467583, 0.0005972863873466849, -0.06724917888641357, 0.03863638639450073, 0.006298915483057499, -0.027906587347388268, -0.0013426485238596797, -0.023122601211071014, 0.00893010850995779, -0.009909686632454395, -0.028316643089056015, 0.02093563601374626, 0.010348218493163586, 0.009978028945624828, 0.04948008805513382, -0.02997964806854725, 0.04697418957948685, -0.005336422938853502, 0.0359710231423378, 0.030047990381717682, 0.02574240416288376, -0.033351220190525055, 0.018281662836670876, 0.014739234931766987, -0.006885523442178965, -0.0032690574880689383, 0.05389958247542381, -0.01706288568675518, -0.011601166799664497, -0.05216823145747185, 0.03480919823050499, -0.0023720599710941315, 0.007033599074929953, 0.02569684199988842, 0.003693351522088051, -0.020878683775663376, -0.07658934593200684, -0.040982816368341446, -0.031164254993200302, 0.010462122969329357, -0.015342927537858486, 0.013588800095021725, 0.03125537931919098, 0.024284426122903824, 0.0026610924396663904, -0.027405407279729843, 0.013976074755191803, -0.02622080221772194, -0.0213798638433218, -0.03241720423102379, -0.01994466781616211, -0.052259355783462524, -0.009898295626044273, -0.025992993265390396, -0.03544706106185913, 0.020480018109083176, 0.019443487748503685, -0.020035790279507637, 0.008440318517386913, 0.0011340610217303038, 0.06264743953943253, -0.04501503333449364, 0.010934825986623764, 0.02426164597272873, -0.0295695923268795, 0.007711330428719521, 0.021072320640087128, 0.013201524503529072, 0.015160680748522282, -0.034672509878873825, 0.03879585117101669, -0.008651042357087135, -0.029227878898382187, 0.069527268409729, -0.020924245938658714, 0.0019306802423670888, -0.01934097334742546, -0.047930989414453506, -0.05918474495410919, -0.00035452755400910974, -0.01954600214958191, -0.00859409011900425, 0.010644369758665562, 0.019796591252088547, 0.04984458163380623, 0.017757702618837357, -0.025879088789224625, 0.0439671128988266, 0.041347309947013855, 0.004670082125812769, 0.036153268069028854, 0.026744762435555458, -0.014374740421772003, 0.02122039720416069, 0.026835886761546135, -0.006293220445513725, -0.02362378127872944, 0.0073411413468420506, 0.0627385675907135, -0.03925146907567978, -0.0018580661853775382, -0.006019849795848131, -0.027359846979379654, 0.015923840925097466, -0.02462613955140114, -0.030845321714878082, -0.02274671569466591, 0.03863638639450073, 0.008098606020212173, 0.007517693098634481, 0.021003978326916695, -0.053489524871110916, 0.008935803547501564, -0.0020915702916681767, 0.008673823438584805, -0.010564636439085007, -0.0415523387491703, 0.032599449157714844, 0.04779430106282234, 0.011880232952535152, 0.003089657984673977, -0.009505325928330421, -0.0006916135316714644, 0.00037659655208699405, -0.04417214170098305, 0.031756557524204254, 0.017074275761842728, -0.03426245599985123, 0.018805623054504395, 0.027405407279729843, 0.02225692756474018, -0.014864529483020306, 0.011834671720862389, 0.022029118612408638, -0.00815555825829506, 0.05462856963276863, -0.006572286132723093, 0.015285976231098175, -0.027154818177223206, -0.008258071728050709, 0.037634026259183884, -0.004399558994919062, -0.01332681905478239, 0.002444674028083682, 0.03569765016436577, -0.003867055755108595, 0.002836220432072878, -0.01583271659910679, 0.006697581149637699, -0.008275157772004604, 0.007096246350556612, -0.01478479616343975, 0.059685926884412766, 0.010826616548001766, 0.037634026259183884, -0.011282234452664852, 0.021117882803082466, 0.03209827095270157, 0.009049708023667336, -0.0221771951764822, -0.02929622121155262, 0.014112760312855244, 0.02729150280356407, 0.023692123591899872, -0.03847691789269447, -0.015684641897678375, 0.022974524646997452, -0.0012237607734277844, -0.023282067850232124, 0.026972571387887, -0.019432097673416138, -0.007620207034051418, 0.004325521178543568, -0.01598079316318035, 0.0020901465322822332, 0.0019420706667006016, 0.0032832955475896597, -0.02034333348274231, -0.015969403088092804, -0.017074275761842728, -0.003400047542527318, -0.053808458149433136, -0.011043035425245762, -0.01202830858528614, 0.031710997223854065, 0.02574240416288376, -0.022963134571909904, 0.021436816081404686, -0.02485394850373268, -0.017040103673934937, -0.03808964416384697, 0.03606214374303818, -0.00035203591687604785, 0.005364899057894945, 0.017882997170090675, -0.014078589156270027, 0.01092913094907999, 0.005951507017016411, 0.012700345367193222, -0.0010315470863133669, -0.0363582968711853, -0.04287363216280937, -0.0319843664765358, 0.025241224095225334, -0.04820435866713524, 0.053808458149433136, -0.005171261727809906, -0.005117157008498907, 0.06146283447742462, -0.06018710508942604, 0.00037054537096992135, -0.05080138146877289, 0.005233909003436565, -0.023247895762324333, -0.005991373676806688, 0.02302008680999279, 0.038499701768159866, -0.01205108966678381, -0.02681310474872589, -0.006190706510096788, 0.039707086980342865, -0.022872012108564377, 0.049571212381124496, -0.006714666727930307, 0.0227808877825737, -0.0015903906896710396, -0.05781789496541023, 0.008577004075050354, -0.006748837884515524, -0.03009355254471302, -0.008799117989838123, 0.04615407809615135, -0.01390773244202137, -0.048751100897789, -0.024967852979898453, -0.02226831763982773, -0.03314619138836861, -0.001667276257649064, 0.027109256014227867, 0.09285490214824677, 0.03619883209466934, 0.03193880617618561, 0.0011141278082504869, 0.01467089168727398, 0.02526400424540043, 0.017529893666505814, 0.02034333348274231, 0.0647432804107666, 0.002466031117364764, 0.019807981327176094, 0.017438769340515137, 0.05822794884443283, -0.008702299557626247, 0.0009361521224491298, 0.025195661932229996, -0.009425592608749866, -0.017370427027344704, -0.03492310270667076, -0.00017308135284110904, 0.0006157958996482193, -0.02241639420390129, -0.008890241384506226, 0.007944834418594837, -0.01059311255812645, 0.009573668241500854, 0.024557797238230705, 0.021527938544750214, 0.04503781720995903, 0.011265149340033531, -0.05175817757844925, 0.005789193324744701, -0.024557797238230705, 0.024033837020397186, 0.03385239839553833, 0.0008208238868974149, 0.04692862927913666, 0.019762421026825905, -0.019637124612927437, -0.042736947536468506, 0.042941972613334656, -0.013873560354113579, 0.001563338446430862, -0.019591564312577248, 0.032553888857364655, -0.05526643246412277, 0.006953866221010685, -0.03193880617618561, -0.026311924681067467, 0.026198020204901695, -0.0014487220905721188, -0.060050420463085175, 0.01566185988485813, -0.008240986615419388, 0.006122363731265068, 0.06173620745539665, 0.0511658750474453, -0.07253434509038925, 0.06150839850306511, -0.044263266026973724, 0.04788542538881302, -0.00395533163100481, 0.0227808877825737, -0.006999427918344736, 0.06483440846204758, -0.0245805773884058, -0.015855498611927032, 0.025446251034736633, 0.01152712944895029, -0.04385320842266083, 3.110125180683099e-05, -0.03385239839553833, -0.012666173279285431, 0.06693024933338165, -0.0411650650203228, -0.026949791237711906, -0.04364817962050438, -0.05180373787879944, 0.03533315658569336, -0.002998534357175231, 0.004473596811294556, 0.010222923010587692, -0.022450564429163933, -0.0130876200273633, -0.0027536398265510798, 0.010040676221251488, 0.06446991115808487, -0.038112424314022064, 0.0519404262304306, -0.02302008680999279, 0.01658448576927185, 0.008326414972543716, 0.021311521530151367, 0.01754128374159336, 0.05426407605409622, 0.018441129475831985, 0.02290618233382702, -0.0006574422004632652, -0.01833861507475376, 0.03752012178301811, 0.020525580272078514, 0.0037218276411294937, -0.00610527815297246, 0.03285004198551178, -0.026790324598550797, -0.018270272761583328, -0.0066861906088888645, 0.0030554865952581167, 0.018680328503251076, -0.0046473010443151, -0.027268722653388977, -0.016322506591677666, -0.02950125001370907, -0.00037374894600361586, 0.029660716652870178, 0.03856804221868515, 0.05850132182240486, 0.005737936124205589, -0.02341875247657299, 0.003556666197255254, -0.009562277235090733, 0.025195661932229996, 0.03745178133249283, -0.01019444689154625, -0.0017242284957319498, -0.006993732415139675, -0.03120981715619564, -0.03681391477584839, 0.05690665915608406, -0.011595471762120724, 0.017313474789261818, 0.003024162957444787, 0.005718003027141094, 0.012221946381032467, -0.03549262508749962, -0.04401267692446709, 0.026949791237711906, -0.022427784278988838, 0.03214383125305176, 0.02972905896604061, -0.037315092980861664, 0.02893172763288021, 0.01902204193174839, -0.0024261644575744867, -0.0007240051054395735, -0.012370022013783455, -0.026106897741556168, 0.017370427027344704, 0.007386703044176102, -0.010462122969329357, -0.025560155510902405, -0.036950599402189255, -0.007079160772264004, -0.00035506149288266897, -0.0035879898350685835, 0.014215273782610893, -0.012768687680363655, -0.0028063205536454916, 0.03788461536169052, -0.0223822221159935, -0.004191683605313301, -0.015764374285936356, -0.012916763313114643, 0.00963062047958374, -0.04779430106282234, -0.004969081375747919, -0.008508661761879921, -0.03528759628534317, -0.01850947178900242, 0.0237832460552454, -0.009408506564795971, 0.02029777131974697, -0.012677564285695553, -0.040458858013153076, -0.014750625006854534, -0.023487094789743423, 0.019215678796172142, -0.021470986306667328, 0.005609793588519096, -0.01762101612985134, -0.0104905990883708, 0.005006100051105022, -0.021767137572169304, -0.03585711866617203, 0.02569684199988842, 0.006629238370805979, -0.004223007243126631, 0.013429333455860615, 0.020969808101654053, 0.03433079645037651, -0.007096246350556612, -0.004183140583336353, -0.022564468905329704, 0.0018381328554823995, -0.009511020965874195, 0.049890145659446716, 0.03193880617618561, 0.015582127496600151, -0.020764779299497604, 0.012347240932285786, -0.0019093231530860066, -0.0007895001326687634, -0.005242452025413513, -0.017165398225188255, -0.002812015824019909, -0.021003978326916695, -0.026927009224891663, -0.014340569265186787, -0.023327630013227463, -0.0029672107193619013, -0.017484331503510475, -0.0243755504488945, 0.0067659239284694195, 0.027633216232061386, -0.01894230768084526, 0.058091264218091965, -0.025947431102395058, 0.022370832040905952, -0.001658733352087438, -0.011436006054282188, -0.0008101453422568738, -0.007944834418594837, -0.008360586129128933, -0.011236673220992088, 0.035105347633361816, 0.009881210513412952, -0.01575298421084881, 0.016937589272856712, -0.07221541553735733, 0.004373930394649506, 0.0024304359685629606, 0.014067198149859905, 0.0018181996420025826, 0.029751839116215706, -0.005601251032203436, 0.03337400034070015, 0.023828808218240738, -0.01602635532617569, -0.02845332957804203, 0.015092338435351849, -0.009220564737915993, 0.014591158367693424, -0.030913664028048515, -0.026767542585730553, -0.01116832997649908, -0.004242940340191126, -0.019443487748503685, 0.035150911659002304, 0.0407550074160099, -0.06533558666706085, -0.00010447172826388851, 0.03813520818948746, 0.013235695660114288, -0.00501464307308197, -0.004989014472812414, -0.01575298421084881, -0.0555398054420948, -0.010359608568251133, -0.038545262068510056, 0.028476109728217125, -0.03733787685632706, -0.006577981170266867, 0.029432907700538635, 0.0235782191157341, -0.03253110870718956, 0.036631666123867035, 0.0227808877825737, -0.0019506135722622275, 0.00896997470408678, 0.011396138928830624, 0.02046862803399563, 0.008514356799423695, 0.003941093571484089, 0.0075119975954294205, 0.04168902337551117, 0.0016786666819825768, 0.012370022013783455, 0.02322511561214924, 0.021994946524500847, -0.021573500707745552, -0.003502561477944255, -0.012062479741871357, 0.01282563991844654, 0.011179720982909203, -0.013634361326694489, -0.023532656952738762, -0.0020488561131060123, -0.048341043293476105, -0.04107394069433212, 0.011407529935240746, -0.02861279435455799, 0.030025210231542587, -0.009277516975998878, 0.006595067214220762, -0.002746520796790719, 0.009408506564795971, -0.004633062984794378, -0.001915018423460424, 0.0051541756838560104, 0.01042795181274414, 0.01970546878874302, 0.025628499686717987, 0.05540312081575394, -0.013622971251606941, 0.003989502787590027, -0.005501584615558386, 0.019523220136761665, -0.008548527956008911, -0.005401918198913336, 0.02505897730588913, -0.007699939887970686, 0.008223900571465492, -0.025400690734386444, 0.018919527530670166, 0.03232607990503311, -0.018771450966596603, -0.011903014034032822, 0.029387345537543297, -0.013691313564777374, -0.02649417333304882, 0.012609221041202545, -0.009773001074790955, -0.022120242938399315, -0.03228051960468292, 5.923253411310725e-06, 0.05203154683113098, -0.010177361778914928, 0.010564636439085007, 0.03977543115615845, -0.007728416007012129, -0.02717760019004345, -0.04383042827248573, -0.0367683544754982, 0.0066861906088888645, -0.020571142435073853, 0.003847122425213456, -0.006828571204096079, -0.0048295482993125916, 0.060414914041757584, -0.02833942510187626, -0.03241720423102379, 0.008047348819673061, -0.03177933767437935, 0.027428189292550087, -0.009767306037247181, -0.03590267896652222, 0.009744524955749512, 0.007751197088509798, -0.0022097460459917784, -0.013372381217777729, -0.004240092821419239, -0.02717760019004345, -0.03168821334838867, -0.03089088387787342, 0.012073870748281479, -0.0044764443300664425, 0.011401833966374397, 0.03533315658569336, 0.009243344888091087, 0.0007980429800227284, -0.031232597306370735, -0.021596280857920647, 0.000968187756370753, -0.0015590670518577099, -0.007466435898095369, -0.0013426485238596797, -0.05175817757844925, 0.028749480843544006, -0.041028380393981934, 0.03205271065235138, 0.00614514434710145, 0.007768282666802406, -0.0002329701674170792, 0.024557797238230705, -0.0031779338605701923, -0.005165566224604845, -0.03490031883120537, 0.04884222522377968, -0.017598235979676247, 0.027086475864052773, -0.03961596265435219, 0.00567528884857893, -0.02961515448987484, -0.031551528722047806, 0.027838245034217834, 0.006549505051225424, 2.7163539925822988e-05, 0.02233665995299816, -0.0443543903529644, 0.040026020258665085, -0.035993803292512894, -0.010632979683578014, -0.04367096349596977, 0.024785606190562248, -0.03410298749804497, -0.007170284632593393, -0.038499701768159866, 0.00920917373150587, -0.0019577324856072664, -0.021391253918409348, -0.018053853884339333, -0.015513784252107143, -0.006691885646432638, 0.042144641280174255, 0.02786102518439293, -0.027724340558052063, 0.020115524530410767, -0.007398093119263649, 0.04433160647749901, 0.019728248938918114, -0.008776336908340454, 0.011117073707282543, 0.001886542304418981, 0.0005684543284587562, 0.01374826580286026, -0.028248300775885582, -0.02765599824488163, -0.007546169217675924, -0.010456427931785583, 0.01750711165368557, -0.03246276453137398, -0.02761043608188629, 0.015889668837189674, 0.03232607990503311, 0.007181674707680941, -0.00873077567666769, -0.0163908489048481, -0.11299320310354233, -0.03328287601470947, -0.001220201258547604, -0.01506955735385418, 0.009790086187422276, 0.004356844816356897, -0.0069880373775959015, -0.01586688868701458, -0.00760312145575881, -0.02026359923183918, 0.005396222695708275, -0.007608816493302584, -0.018805623054504395, -0.039820991456508636, 0.03827189281582832, -0.024922290816903114, 0.017962729558348656, 0.026744762435555458, 0.024512235075235367, 0.0034313711803406477, -0.010758274234831333, -0.006167925428599119, -0.07463018596172333, 0.0319615863263607, 0.0013946174876764417, -0.021926604211330414, -0.006196401547640562, 0.0013996007619425654, -0.030161894857883453, -0.005430394317954779, 0.038750290870666504, -0.03683669492602348, -0.010274180211126804, -0.014192492701113224, -0.018999259918928146, 0.043147001415491104, 0.026585295796394348, 0.03310063108801842, 0.014636720530688763, 0.01766657829284668, -0.01372548472136259, -0.026949791237711906, 0.007352531421929598, -0.0023378885816782713, 0.02581074647605419, 0.0007745501934550703, -0.030480828136205673, 0.01115124486386776, -0.02792936936020851, 0.013429333455860615, 0.02134569175541401, 0.009636315517127514, 0.02206329070031643, -0.04549343138933182, 0.03449026495218277, 0.0639687329530716, -0.04483278840780258, -0.005100071430206299, -0.014044417068362236, 0.04453663527965546, -0.022974524646997452, 0.036905039101839066, 0.01795133948326111, 0.002345007611438632, -0.0019947513937950134, -0.010809531435370445, 0.02770156040787697, -0.02246195636689663, 0.0025585785042494535, -0.02849888987839222, 0.0004314130637794733, -0.0159921832382679, 0.00841184239834547, -0.004089169204235077, 0.005410460755228996, 0.01218777522444725, -0.004712796304374933, -0.0443543903529644, -0.020514190196990967, -0.029068412259221077, 0.06743142753839493, 0.020833121612668037, 0.04752093181014061, -0.01015458069741726, -0.007130417972803116, -0.002995686838403344, -0.009436982683837414, 0.013474895618855953, 0.013645751401782036, 0.021368473768234253, -0.013019277714192867, 0.036745570600032806, 0.0007101229857653379, -0.023828808218240738, -0.05389958247542381, 0.020320551469922066, 0.0323716402053833, -0.020650874823331833, 0.016835076734423637, 0.0009019807912409306, 0.010040676221251488, -0.013019277714192867, -0.0012970868265256286, -0.0057350886054337025, -0.03729231283068657, 0.013645751401782036, 0.032029926776885986, -0.004960538353770971, -0.017803264781832695, 0.05426407605409622, 0.024443892762064934, -0.011014559306204319, 0.0033060763962566853, 0.0211862251162529, -0.017472941428422928, -0.003773084608837962, 0.04610851779580116, -0.020354723557829857, 0.006076802033931017, -0.01566185988485813, -0.016994541510939598, 0.01621999219059944, -0.020252209156751633, 0.02005857229232788, 0.01095191203057766, -0.006629238370805979, -0.0021442510187625885, -0.02185826189815998, -0.01092913094907999, 0.007386703044176102, 0.032348860055208206, 0.019956057891249657, -0.03214383125305176, -0.002403383608907461, 0.014602549374103546, -0.035469841212034225, 0.06360423564910889, -0.048978909850120544, -0.0173932071775198, -0.03273613750934601, -0.01242697425186634, -0.02294035442173481, 0.00967048667371273, -0.04305587708950043, -0.04291919246315956, 0.02389715053141117, 0.019773811101913452, -0.025605717673897743, -0.022370832040905952, 0.004245787858963013, -0.029000069946050644, 0.008053043857216835, -0.01332681905478239, 0.029432907700538635, -0.025992993265390396, 0.054537445306777954, -0.02817995846271515, -0.004926367197185755, -0.03173377737402916, 0.007432264741510153, -0.00835489109158516, 0.00853144284337759, -0.03189324215054512, 0.03264501318335533, 0.010826616548001766, 0.01862337626516819, 0.008753555826842785, 0.01922706887125969, -0.010245704092085361, -0.029706276953220367, 0.01862337626516819, 0.024785606190562248, 0.02833942510187626, 0.02405661717057228, 0.01560490857809782, 0.03132371976971626, 0.014693672768771648, -0.008873156271874905, -0.02421608380973339, 0.009562277235090733, -0.032029926776885986, 0.02881782315671444, 0.02094702608883381, 0.02585630863904953, 0.06857047230005264, -0.004709948785603046, -0.009516716003417969, 0.035743214190006256, -0.01922706887125969, 0.01583271659910679, 0.04383042827248573, 0.02485394850373268, -0.022587250918149948, 0.058455757796764374, -0.04016270488500595, 0.018372785300016403, 0.024033837020397186, -0.008229595609009266, 0.019295411184430122, -0.004131883382797241, 0.04004880040884018, 0.017415989190340042, -0.0189878698438406, -0.05640547722578049, -0.00408632168546319, 0.0319615863263607, 0.006481162738054991, 0.010798140428960323, -0.003237733617424965, 0.012996496632695198, 0.013543237932026386, -0.00899275578558445, 0.013338210061192513, -0.018805623054504395, -0.06241963431239128, 0.00720445578917861, 0.0033203144557774067, 0.0035167995374649763, -0.015126509591937065, -0.030480828136205673, -0.018520861864089966, 0.0077398065477609634, -0.0030099248979240656, -0.03508256748318672, -0.030480828136205673, 0.015331537462770939, -0.0005022473633289337, 0.00839475728571415, 0.03672279044985771, -0.00029757534503005445, 0.011515738442540169, 0.0387730710208416, -0.009482544846832752, 0.01989910565316677, 0.01634528674185276, -0.006521028932183981, 0.02972905896604061, -0.03449026495218277, 0.01946626789867878, 0.019557392224669456, -0.0029501249082386494, -0.014659501612186432, -0.008799117989838123, -0.004641606006771326, 0.02770156040787697, 0.01841834746301174, 0.029911305755376816, 0.029227878898382187, -0.0013953293673694134, 0.024671701714396477, 0.01454559713602066, -0.013827999122440815, 0.02681310474872589, -0.015263195149600506, -0.0015903906896710396, 0.007181674707680941, -0.013030667789280415, 0.023487094789743423, -0.013827999122440815, 0.026311924681067467, 0.0071418085135519505, 0.030822541564702988, 0.010741188190877438, 0.01287120208144188, -0.007574645336717367, 0.009026926942169666, -0.007033599074929953, 0.01666422002017498, 0.02950125001370907, 0.011925795115530491, -0.033305659890174866, -0.0036848087329417467, 0.002233950886875391, -0.0018310138257220387, -0.01480757724493742, -0.001096330233849585, -0.04059554263949394, -0.016163039952516556, -0.016561705619096756, -0.007420874200761318, -0.025332346558570862, 0.005399070214480162, 0.0205825325101614, -0.018008291721343994, -0.0026425831019878387, -0.017290694639086723, 0.008377671241760254, 0.002817711094394326, -0.0008414690382778645, 0.02013830468058586, 0.004257178399711847, 0.017598235979676247, 0.007597425952553749, -0.056815534830093384, -0.005615489091724157, 0.009283212013542652, -0.006241963244974613, 0.019830763339996338, -0.021801309660077095, -0.025628499686717987, -0.01793994940817356, 0.001361158094368875, -0.010519075207412243, 0.013064838945865631, -0.000694817106705159, -0.021334301680326462, -0.03109591268002987, -0.02749653160572052, 0.0031750863417983055, 0.002077332232147455, 0.0022311031352728605, -0.024238863959908485, -0.019249850884079933, 0.013099010102450848, 0.00610527815297246, 0.03977543115615845, 0.013474895618855953, -0.02945568785071373, -0.01682368479669094, 0.012893982231616974, -0.020890073850750923, 0.025674059987068176, -0.00810999609529972, 0.04032217338681221, -0.0010457851458340883, 0.023760465905070305, -0.029842963442206383, 0.0014280768809840083, 0.01842973753809929, -0.010507684201002121, -0.02569684199988842, 0.007084856275469065, 0.014511425979435444, 0.04711087793111801, -0.01874867081642151, 0.014158321544528008, -0.01258644089102745, -0.009476849809288979, -0.021357081830501556, -0.019728248938918114, -0.026835886761546135, -0.034148551523685455, -0.006304610520601273, 0.04779430106282234, 0.002696687588468194, -0.007039294578135014, -0.06059716269373894, 0.0025799355935305357, -0.014818967320024967, 0.026471391320228577, 0.07248878479003906, 0.02346431463956833, 0.013805218040943146, -0.005900249816477299, -0.007967615500092506, -0.042941972613334656, 0.021083712577819824, 0.018247490748763084, 0.0057350886054337025, -0.040663883090019226, -0.019033432006835938, 0.039980459958314896, -0.017848825082182884, -0.004664386622607708, 0.024033837020397186, -0.045379526913166046, 0.0019947513937950134, 0.027838245034217834, -0.013679923489689827, -0.00795052945613861, 0.04629076272249222, 0.02909119427204132, -0.008189729414880276, -0.021596280857920647, 0.008178338408470154, -0.03120981715619564, 0.016687000170350075, -0.017894387245178223, 0.024512235075235367, 0.004410949535667896, 0.011259454302489758, -0.04549343138933182, 0.005299404263496399, -0.003619313472881913, -0.02062809467315674, 0.018566424027085304, 0.0026767542585730553, -0.03576599434018135, 0.004094864707440138, 0.012506707571446896, 0.018794232979416847, 0.0015277432976290584, -0.007107636891305447, 0.007381007540971041, -0.0019278326071798801, 0.019363755360245705, -0.020616702735424042, -0.001584695535711944, 0.023600999265909195, 0.027428189292550087, 0.03665444999933243, -0.007181674707680941, 0.020013010129332542, -0.01766657829284668, 0.012392803095281124, -0.00967048667371273, 0.009038317017257214, 0.02925066091120243, 0.010684236884117126, 0.0211862251162529, -0.024238863959908485, -0.011532824486494064, 0.014272226020693779, -0.002841915702447295, 0.014283617027103901, -0.008878851309418678, 0.0231795534491539, -0.015844106674194336, -0.0041802930645644665, 0.05440076068043709, -0.003197867190465331, 0.03724675253033638, -0.01742737926542759, -0.006327391602098942, 0.014044417068362236, -0.0012344393180683255, -0.010319742374122143, 0.013622971251606941, -0.008952888660132885, 0.026676420122385025, 0.0076372926123440266, 0.009858429431915283, -0.016481973230838776, 0.025947431102395058, -0.019956057891249657, -0.0038699032738804817, 0.020514190196990967, -0.016368068754673004, -0.021915214136242867, 0.03173377737402916, 0.01738181710243225, 0.00471564382314682, -0.002362093422561884, 0.027952149510383606, 0.021960776299238205, 0.03783905506134033, -0.015411270782351494, -0.02558293752372265, -0.035948239266872406, -0.004596044309437275, -0.006646323949098587, 0.018805623054504395, -0.008178338408470154, 0.027747120708227158, 0.022006338462233543, 0.02214302308857441, 0.015491004101932049, -0.021778529509902, -0.009425592608749866, -0.006150839850306511, -0.014272226020693779, 0.014443082734942436, 0.015593517571687698, -0.04496947303414345, 0.010843702591955662, -0.013030667789280415, -0.030982008203864098, 0.01295093446969986, -0.030959226191043854, -0.012267508544027805, 0.017313474789261818, -0.02306564897298813, 0.003328857244923711, -0.002518711844459176, 0.0057550217024981976, -0.0034057428129017353, 0.030002430081367493, -0.011145549826323986, -0.016493363305926323, 0.005296556279063225, -6.304788985289633e-05, 0.0067659239284694195, -0.009812867268919945, -0.013315428979694843, 0.03269057348370552, 0.028271082788705826, 0.007899273186922073, -0.005817669443786144, 0.00031021161703392863, -0.027838245034217834, -0.009459763765335083, 0.032872822135686874, 0.010621588677167892, 0.0034199808724224567, 0.009767306037247181, 0.0021001130808144808, 0.009237649850547314, 0.006555200554430485, 0.022154413163661957, 0.03073141723871231, 0.019933277741074562, -0.013543237932026386, -0.001600357354618609, -0.0037588465493172407, -0.004718491341918707, -0.07326333224773407, 0.031551528722047806, 0.01416971255093813, -0.002229679375886917, -0.04651857167482376, 0.020354723557829857, 0.0030497913248836994, 0.019489049911499023, -0.00793344434350729, -0.012916763313114643, 0.050254639238119125, -0.0016800904413685203, -0.0112879304215312, 0.0347864143550396, 0.01414693146944046, 0.05959480255842209, 0.0022325271274894476, 0.030549170449376106, 0.01862337626516819, 0.0022965981625020504, 0.02125456929206848, -0.0044280351139605045, -0.01795133948326111, -0.0259702131152153, -0.008548527956008911, -0.0016601572278887033, -0.02410217933356762, 0.0003160848282277584, 0.02014969475567341, -0.012016918510198593, 0.020559750497341156, -0.024648921564221382, -0.019671296700835228, -0.005940116476267576, 0.002961515448987484, -0.001604628749191761, 0.01857781410217285, -0.02102676033973694, -0.0046473010443151, -0.0040265219286084175, 0.021755747497081757, 0.021083712577819824, 0.011697986163198948, 0.016459191218018532, 0.01401024591177702, -0.010894959792494774, -0.026198020204901695, 0.016755342483520508, 0.016402238979935646, 0.023760465905070305, 0.032075490802526474, 0.004798224661499262, -0.023168163374066353, 0.00016266977763734758, -0.03528759628534317, 0.017655188217759132, -0.00947115384042263, 0.008827594108879566, -0.027268722653388977, 0.02346431463956833, -0.018725890666246414, 0.026995351538062096, 0.00707346573472023, 0.024945072829723358, -0.032918382436037064, -0.016732562333345413, -0.03168821334838867, 0.029956867918372154, -0.009778696112334728, -0.0001834929280448705, -0.02153932861983776, 0.03492310270667076, 0.03114147298038006, -0.024762826040387154, 0.011880232952535152, -0.004462206270545721, -0.037907399237155914, 0.011310710571706295, -0.017472941428422928, 0.0069880373775959015, -0.021869651973247528, -0.021641843020915985, -0.013019277714192867, 0.03847691789269447, -0.03772515058517456, -0.014796186238527298, 0.029546812176704407, 0.015593517571687698, 0.007745502050966024, -0.015479613095521927, -0.002503050025552511, 0.028157178312540054, 0.03783905506134033, -0.01670978218317032, 0.030913664028048515, -0.015342927537858486, 0.017757702618837357, -0.004066388588398695, -0.043579839169979095, -0.03348790481686592, -0.01914733648300171, 0.022644203156232834, -0.03412577137351036, -0.008548527956008911, 0.015502394177019596, 0.03369293361902237, -0.001118399202823639, -0.012483926489949226, 0.016174430027604103, 0.02074199914932251, -0.02014969475567341, -0.007785368245095015, -0.00727279856801033, -0.015798546373844147, -0.030982008203864098, 0.003647789591923356, -0.0026497021317481995, 0.0024503692984580994, 0.019921885803341866, 0.008742165751755238, 0.0056610507890582085, -0.01181189063936472, -0.030685855075716972, 0.00859409011900425, -0.02521844208240509, -0.004658691585063934, -0.030047990381717682, -0.04528840631246567, -0.013304038904607296, 0.021960776299238205, -0.008742165751755238, -0.0012714583426713943, 0.030275799334049225, -0.01438613049685955, -0.017131227999925613, 0.04524284228682518, -0.018122196197509766, -0.027245942503213882, -0.036905039101839066, 0.018873965367674828, -0.0259702131152153, -0.00830932892858982, 0.019090384244918823, -0.02638026885688305, 0.01835000514984131, -0.0007439383771270514, -0.0071361130103468895, -0.016447801142930984, 0.023509876802563667, -0.01522902399301529, -4.2958879930665717e-05, 0.010632979683578014, 0.04544787108898163, -0.025150099769234657, 0.003804408246651292, 0.006879827938973904, 0.014089979231357574, -0.0035851423162966967, -0.040549978613853455, 0.01857781410217285, 0.030344143509864807, -0.04783986508846283, -0.00558416498824954, 0.004262873437255621, 0.029660716652870178, 0.01494426280260086, -0.0009745948482304811, -0.005669593345373869, -0.007022208534181118, -0.0201838668435812, 0.006959561258554459, -0.030321361497044563, 0.0253779087215662, 0.06966395676136017, 0.0018623375799506903, -0.003667722921818495, 0.017655188217759132, 0.02341875247657299, -0.007369617465883493, 0.00012609577970579267, 0.012780077755451202, -0.0010828040540218353, 0.014124150387942791, -0.0006855623214505613, -0.00939142145216465, -0.03544706106185913, -0.013133182190358639, 0.02246195636689663, -0.019489049911499023, -0.021801309660077095, -0.0035509709268808365, 0.0004057845799252391, -0.01530875638127327, -0.007819539867341518, 0.033715713769197464, 0.0016986000118777156, -0.005549993831664324, 0.0431697815656662, 0.01518346183001995, -0.013543237932026386, 0.041347309947013855, 0.02014969475567341, -0.001526319538243115, -0.026106897741556168, 0.008918717503547668, 0.029432907700538635, 0.003502561477944255, -0.011800499632954597, -0.01658448576927185, -0.02093563601374626, -0.0017356189200654626, 0.0004420916084200144, 0.025332346558570862, 0.01178910955786705, -0.010496294125914574, 0.012153604067862034, 0.004735576920211315, -0.014625330455601215, -0.007198760751634836, 0.015525175258517265, -0.0631486177444458, 0.008007481694221497, -0.01287120208144188, -0.0243755504488945, -0.023851590231060982, 0.0023848742712289095, -0.005635422188788652, -0.0223822221159935, 0.017723530530929565, -0.0033231619745492935, -0.030389703810214996, 0.0006211351719684899, -0.003915464971214533, -0.010940521024167538]
metadata : {"source": "pydantic_ai_docs", "crawled_at": "2025-03-15T11:18:00.800683", "url_path": "/api/pydantic_graph/persistence/", "chunk_size": 4913}
updated_dt: 2025-03-15T11:18:00.800683
---
```
  """
  _snapshots_type_adapter: pydantic.TypeAdapter[list[Snapshot[StateT, RunEndT]]] | None = field(
    default=None, init=False, repr=False
  )
  async defsnapshot_node(self, state: StateT, next_node: BaseNode[StateT, Any, RunEndT]) -> None:
    await self._append_save(NodeSnapshot(state=state, node=next_node))
  async defsnapshot_node_if_new(
    self, snapshot_id: str, state: StateT, next_node: BaseNode[StateT, Any, RunEndT]
  ) -> None:
    async with self._lock():
      snapshots = await self.load_all()
      if not any(s.id == snapshot_id for s in snapshots):
        await self._append_save(NodeSnapshot(state=state, node=next_node), lock=False)
  async defsnapshot_end(self, state: StateT, end: End[RunEndT]) -> None:
    await self._append_save(EndSnapshot(state=state, result=end))
  @asynccontextmanager
  async defrecord_run(self, snapshot_id: str) -> AsyncIterator[None]:
    async with self._lock():
      snapshots = await self.load_all()
      try:
        snapshot = next(s for s in snapshots if s.id == snapshot_id)
      except StopIteration as e:
        raise LookupError(f'No snapshot found with id={snapshot_id!r}') frome
      assert isinstance(snapshot, NodeSnapshot), 'Only NodeSnapshot can be recorded'
      exceptions.GraphNodeStatusError.check(snapshot.status)
      snapshot.status = 'running'
      snapshot.start_ts = _utils.now_utc()
      await self._save(snapshots)
    start = perf_counter()
    try:
      yield
    except Exception:
      duration = perf_counter() - start
      async with self._lock():
        await _graph_utils.run_in_executor(self._after_run_sync, snapshot_id, duration, 'error')
      raise
    else:
      snapshot.duration = perf_counter() - start
      async with self._lock():
        await _graph_utils.run_in_executor(self._after_run_sync, snapshot_id, snapshot.duration, 'success')
  async defload_next(self) -> NodeSnapshot[StateT, RunEndT] | None:
    async with self._lock():
      snapshots = await self.load_all()
      if snapshot := next((s for s in snapshots if isinstance(s, NodeSnapshot) and s.status == 'created'), None):
        snapshot.status = 'pending'
        await self._save(snapshots)
        return snapshot
  defshould_set_types(self) -> bool:
"""Whether types need to be set."""
    return self._snapshots_type_adapter is None
  defset_types(self, state_type: type[StateT], run_end_type: type[RunEndT]) -> None:
    self._snapshots_type_adapter = build_snapshot_list_type_adapter(state_type, run_end_type)
  async defload_all(self) -> list[Snapshot[StateT, RunEndT]]:
    return await _graph_utils.run_in_executor(self._load_sync)
  def_load_sync(self) -> list[Snapshot[StateT, RunEndT]]:
    assert self._snapshots_type_adapter is not None, 'snapshots type adapter must be set'
    try:
      content = self.json_file.read_bytes()
    except FileNotFoundError:
      return []
    else:
      return self._snapshots_type_adapter.validate_json(content)
  def_after_run_sync(self, snapshot_id: str, duration: float, status: SnapshotStatus) -> None:
    snapshots = self._load_sync()
    snapshot = next(s for s in snapshots if s.id == snapshot_id)
    assert isinstance(snapshot, NodeSnapshot), 'Only NodeSnapshot can be recorded'
    snapshot.duration = duration
    snapshot.status = status
    self._save_sync(snapshots)
  async def_save(self, snapshots: list[Snapshot[StateT, RunEndT]]) -> None:
    await _graph_utils.run_in_executor(self._save_sync, snapshots)
  def_save_sync(self, snapshots: list[Snapshot[StateT, RunEndT]]) -> None:
    assert self._snapshots_type_adapter is not None, 'snapshots type adapter must be set'
    self.json_file.write_bytes(self._snapshots_type_adapter.dump_json(snapshots, indent=2))
  async def_append_save(self, snapshot: Snapshot[StateT, RunEndT], *, lock: bool = True) -> None:
    assert self._snapshots_type_adapter is not None, 'snapshots type adapter must be set'
    async with AsyncExitStack() as stack:
      if lock:
        await stack.enter_async_context(self._lock())
      snapshots = await self.load_all()
      snapshots.append(snapshot)
      await self._save(snapshots)
  @asynccontextmanager
  async def_lock(self, *, timeout: float = 1.0) -> AsyncIterator[None]:
"""Lock a file by checking and writing a `.pydantic-graph-persistence-lock` to it.
    Args:
      timeout: how long to wait for the lock
    Returns: an async context manager that holds the lock
    """
    lock_file = self.json_file.parent / f'{self.json_file.name}.pydantic-graph-persistence-lock'
    lock_id = secrets.token_urlsafe().encode()
    await asyncio.wait_for(_get_lock(lock_file, lock_id), timeout=timeout)
    try:
      yield
    finally:
      await _graph_utils.run_in_executor(lock_file.unlink, missing_ok=True)

```
  
---|---  
####  json_file `instance-attribute`
```
json_file: Path[](https://docs.python.org/3/library/pathlib.html#pathlib.Path "pathlib.Path")