---
url: https://ai.pydantic.dev/examples/rag/
session_id: pydantic_ai_docs
chunk_number: 3
title: Database Connection Context Manager in AsyncPG
summary: This document chunk defines an asynchronous context manager `database_connect` for PostgreSQL using the asyncpg library. It includes logic to connect to the database, check for its existence, and create it if necessary. Additionally, it establishes a connection pool for subsequent database interactions and includes a schema for the `doc_sections` table, which involves creating a vector extension and a structure for storing document data.
embedding: [0.022151131182909012, -0.0005997931002639234, -0.009065317921340466, -0.049679990857839584, -0.01394368801265955, -0.02512168698012829, -0.03208712860941887, 0.03313706815242767, -0.02939826250076294, 0.013661997392773628, 0.02023051306605339, -0.0014396634651347995, -0.0010939521016553044, -0.05920625850558281, -0.018847666680812836, 0.04637653008103371, -0.04612044617533684, 0.01923179067671299, -0.011382863856852055, -0.00776569964364171, 0.055723536759614944, -0.012759307399392128, 0.017733708024024963, 0.012426399625837803, -0.013661997392773628, 0.038002632558345795, 0.008105008862912655, 0.05961599200963974, -0.016081977635622025, -0.03326510637998581, -0.009475049562752247, -0.016670966520905495, 0.04868127033114433, 0.06980807334184647, -0.017516039311885834, -0.003437906736508012, 0.0175800584256649, -0.007170307915657759, 0.05306027829647064, 0.007016658782958984, 0.011286833323538303, -0.0623304657638073, 0.03667100518941879, 0.015172883868217468, -0.010326524265110493, 0.0315493568778038, 0.027426429092884064, 0.03175422176718712, 0.03692708536982536, -0.06801549345254898, -0.048578836023807526, 0.017951378598809242, -0.031190840527415276, 0.02571067586541176, -0.004084514919668436, -0.021767007187008858, -0.018322698771953583, 0.014878389425575733, -0.020806698128581047, 0.012407193891704082, -0.026991087943315506, -0.03216395527124405, 0.0036235663574188948, -0.004721520002931356, -0.05490407347679138, 0.0033546797931194305, -0.06417425721883774, 0.035902757197618484, -0.024955233559012413, 0.006264416500926018, 0.046478960663080215, 0.011126781813800335, -0.024327831342816353, -0.05326514691114426, 0.006587720476090908, -0.04996168240904808, -0.033956531435251236, 0.05326514691114426, -0.03047380968928337, -0.050678715109825134, -0.03039698489010334, -0.004318189807236195, -0.032880984246730804, 0.026581356301903725, -0.030678674578666687, -0.035569850355386734, -0.08711924403905869, 0.01793857477605343, 0.009974410757422447, -0.015787482261657715, -0.02225356362760067, -0.013751626946032047, -0.019590307027101517, -0.02306022308766842, 0.02829710952937603, 0.025659460574388504, 0.029500696808099747, 0.00674137007445097, -0.03595397248864174, 0.013533956371247768, 0.031088408082723618, -0.021280450746417046, -0.011427678167819977, -0.015262513421475887, 0.022343192249536514, -0.01206788420677185, 0.005909102037549019, 0.022420017048716545, 0.001187582267448306, -0.02229197509586811, -0.11912954598665237, -0.007740091532468796, 0.01956469751894474, 0.028245892375707626, -0.01944946125149727, -0.018399523571133614, 0.00045774734462611377, -0.010633823461830616, -0.008854050189256668, 0.004897576756775379, -0.06314992904663086, -0.03567228466272354, -0.011959049850702286, 0.011594132520258427, -0.0018421929562464356, 0.04289380833506584, 0.004775937180966139, -0.038181889802217484, -0.04263772442936897, -0.015889914706349373, 0.04396935552358627, -0.012516029179096222, 0.05802828073501587, -0.0256082434207201, -0.019807975739240646, -0.02645331621170044, -0.05659421905875206, -0.03308584913611412, -0.0244686771184206, 0.04847640544176102, -0.00048935750965029, -0.008687596768140793, -0.01545457448810339, 0.009897585958242416, -0.050422631204128265, -0.0023895693011581898, -0.04473759979009628, 0.03072989173233509, -0.012944966554641724, 0.015236904844641685, 0.0037996231112629175, -0.012778513133525848, -0.037669725716114044, 0.025736285373568535, 0.028194675222039223, 0.019923213869333267, 0.007400782313197851, 0.05813071131706238, 0.014327812008559704, -0.03400774672627449, -0.013508348725736141, 0.016863027587532997, -0.026658181101083755, -0.0037996231112629175, -0.0004141333047300577, -0.012586451135575771, 0.01007684413343668, -0.033956531435251236, -0.05231764167547226, -0.025185707956552505, -0.005883493926376104, -0.044225435703992844, 0.017708100378513336, 0.022048696875572205, 0.015608224086463451, -0.0406658910214901, 0.009628699161112309, -0.0054161436855793, -0.013866864144802094, -0.025723479688167572, -0.02693987265229225, 0.017656883224844933, -0.03367483988404274, -0.01734958402812481, -0.022343192249536514, -0.030678674578666687, 0.004756730981171131, 0.0047087157145142555, 0.041536569595336914, 0.02423820272088051, 0.02829710952937603, 0.006837401073426008, -0.025633851066231728, -0.045557063072919846, 0.0032874583266675472, 0.0008050591568462551, 0.013738822191953659, -0.02527533657848835, 0.015915522351861, 0.03761851042509079, 0.0034699169918894768, 0.0377209410071373, -0.014481461606919765, -0.07011537253856659, 0.0052720969542860985, -0.04189508780837059, 0.014455853030085564, -0.01381564699113369, -0.02696548029780388, -0.003212234005331993, -0.0027064711321145296, -0.08179272711277008, 0.02384127490222454, -0.017528843134641647, 0.012765709310770035, -0.015108863823115826, 0.011991060338914394, 0.0020550615154206753, 0.027759335935115814, -0.04711916670203209, 0.0024904017336666584, 0.017298368737101555, -0.007458400912582874, -0.035134509205818176, -0.0027640897314995527, 0.02568506821990013, 0.01960311084985733, -0.06714481115341187, 0.014353420585393906, 0.07257375866174698, 0.0208579134196043, -0.0026712599210441113, 0.009250978007912636, -0.01291295699775219, -0.0066261328756809235, 0.01129323523491621, -0.022279171273112297, -0.002564025344327092, 0.025953954085707664, 0.02737521193921566, 0.0004377409059088677, -0.05485285818576813, 0.0032026309054344893, 0.0021991077810525894, -0.003940468654036522, 0.008207442238926888, -0.018886080011725426, -0.05603083595633507, 0.0551089383661747, 0.03208712860941887, -0.009327802807092667, -0.015032039023935795, 0.0018822058336809278, -0.013213853351771832, -0.024814387783408165, -0.02099875919520855, -0.07323957234621048, -0.05905260890722275, 0.02845075912773609, -0.04929586872458458, -0.0022663294803351164, 0.03142131492495537, -0.04112683981657028, 0.01727275922894478, 0.013918080367147923, -0.009743936359882355, 0.030934758484363556, -0.019718347117304802, 0.02262488380074501, -0.020537810400128365, 0.009513461962342262, 0.039923250675201416, 0.018041007220745087, 0.011158792302012444, -0.03820749744772911, -0.00027108725043945014, 0.014558286406099796, 0.03454551845788956, 0.052368856966495514, -0.001057940535247326, -0.05603083595633507, -0.05423825979232788, 0.011536513455212116, 0.017106305807828903, 0.0015068850480020046, 0.020243316888809204, -0.010966730304062366, -0.024968037381768227, 0.003982082009315491, 0.0011315642623230815, 0.017477625980973244, -0.0038316333666443825, -0.03441748023033142, 0.002492002211511135, -0.02391809970140457, 0.009122936986386776, 0.06120370328426361, -0.01658133789896965, 0.0016709378687664866, 0.01813063584268093, 0.026427706703543663, -0.0169142447412014, 0.01834830641746521, -0.012688884511590004, -0.032471250742673874, 0.025083273649215698, -0.006094762124121189, 0.0017349584959447384, 0.02686304785311222, -0.03139570727944374, 0.0002476797380950302, 0.017618471756577492, 0.0008618774591013789, -0.04307306557893753, -0.012925760820508003, 0.0035531437024474144, 0.009353410452604294, 0.015902718529105186, 0.0021254841703921556, -0.04350840672850609, -0.02329069748520851, -0.011587729677557945, 0.03334193304181099, -0.03613322973251343, -0.041946303099393845, 0.00201664911583066, 0.011434081010520458, -0.028348324820399284, 0.0025240124668926, 0.010153668001294136, 0.04542902484536171, -0.005201674532145262, -0.007138297893106937, 0.004404617939144373, 0.0074519990012049675, -0.03964155912399292, 0.006690153386443853, 0.014327812008559704, -0.01228555478155613, 0.02574908919632435, -0.07446876913309097, 0.020473791286349297, -0.032471250742673874, 0.0015589018585160375, -0.039001353085041046, 0.038745272904634476, 0.03098597377538681, 0.03746486082673073, -0.01028170995414257, 0.026427706703543663, -0.02590273879468441, 0.07416146993637085, 0.024263810366392136, 0.05746489763259888, 0.03500646725296974, -0.04606923088431358, -0.0021254841703921556, 0.0006730166496708989, -0.04742646589875221, 0.011069162748754025, 0.011389265768229961, 0.004212555941194296, -0.040358591824769974, -0.016184410080313683, -0.03672222048044205, -0.000558979925699532, 0.014289399608969688, 0.0032330406829714775, -0.01846354268491268, 0.02044818177819252, 0.002736880909651518, 0.011177998036146164, -0.0038220302667468786, -0.015889914706349373, -0.015979543328285217, 0.005829076282680035, -0.011363658122718334, 0.0223303884267807, 0.027093522250652313, 0.01964152231812477, 0.0446607768535614, -0.021165212616324425, -0.008758019655942917, -0.08927033841609955, -0.003425102448090911, 0.010524988174438477, 0.0005297705065459013, 0.013073008507490158, -0.047477684915065765, 0.004804746713489294, 0.031114015728235245, -0.07134456932544708, -0.017784925177693367, -0.03313706815242767, -0.06658143550157547, 0.0004389412933960557, 0.018284285441040993, 0.033034633845090866, 0.05449433997273445, -0.006901421584188938, 0.007752895820885897, -0.04058906435966492, -0.012087090872228146, -0.010422554798424244, 0.0035691489465534687, 0.036901477724313736, 0.04440469294786453, 0.028783665969967842, 0.008309874683618546, -0.012035874649882317, 0.00032550477772019804, -0.013521152548491955, 0.02965434640645981, 0.022932181134819984, -0.001786174951121211, -0.0662229135632515, 0.010838689282536507, 0.005777860060334206, -0.013329090550541878, 0.03820749744772911, -0.011888626962900162, -0.02539057284593582, 0.004990406334400177, 0.0030489815399050713, 0.01628684252500534, 0.028220284730196, 0.02763129398226738, -0.029423872008919716, 0.030934758484363556, -0.02272731624543667, -0.01941104792058468, -0.04348279535770416, 0.030550634488463402, -0.034289438277482986, 0.005605004262179136, -0.04158778861165047, -0.001962231704965234, 0.021869439631700516, 0.01683741994202137, -0.006533303298056126, -0.02354677952826023, -0.011766987852752209, -0.0525481142103672, 0.009097328409552574, -0.027528861537575722, 0.009929596446454525, 0.009647905826568604, 0.012419997714459896, 0.002237520180642605, 0.005054426845163107, -0.004455834161490202, -0.04089636355638504, -0.011011544615030289, -0.03172861412167549, 0.02763129398226738, -0.012330369092524052, 0.04660700261592865, -0.046402137726545334, 0.07242011278867722, -0.03341875597834587, 0.0951090157032013, 0.033623624593019485, -0.05021776631474495, 0.026350881904363632, 0.01850195601582527, -0.05700394883751869, -0.0014412639429792762, 0.05751611292362213, 0.019283007830381393, -0.04435347765684128, 0.020320141687989235, 0.024212593212723732, -0.012317565269768238, 0.008924473077058792, -0.033290717750787735, -0.028578799217939377, 0.008521143347024918, -0.001145168673247099, 0.003895654110237956, -0.005588999018073082, 4.911580981570296e-05, -0.01241359580308199, 0.048911742866039276, 0.03546741604804993, -0.03533937409520149, 0.019206183031201363, 0.01348274014890194, 0.003418700536713004, 0.013905276544392109, 0.006411663722246885, 0.007055071182549, 0.006306029856204987, 0.011069162748754025, -0.014276595786213875, -0.0034411076921969652, -0.0032778552267700434, -0.050422631204128265, -0.04686308652162552, 0.032957810908555984, -0.030012860894203186, -0.03830993175506592, -0.01734958402812481, -0.03802824020385742, 0.02443026378750801, -0.021754203364253044, -0.0315493568778038, 0.013329090550541878, -0.03567228466272354, -0.014968018047511578, 0.0025752289220690727, -0.01956469751894474, -0.05085797235369682, 0.015032039023935795, 0.018284285441040993, 0.04863005504012108, -0.001659734291024506, -0.006773380562663078, 0.024878408759832382, -0.018245873972773552, -0.04040980711579323, 0.0073815761134028435, -0.03595397248864174, -0.011984657496213913, 0.008527545258402824, 0.0028153061866760254, -0.012119101360440254, -0.007439194712787867, -0.04325232282280922, -0.023828471079468727, -0.05526258796453476, -0.01768249273300171, -0.004593478515744209, 0.020358553156256676, -0.011651750653982162, -0.06985928863286972, -0.016939852386713028, -0.03802824020385742, -0.009737534448504448, -0.0324968621134758, 0.0027640897314995527, -0.03039698489010334, 0.009058916009962559, -0.0056850300170481205, -0.05078114569187164, -0.003418700536713004, -0.02998725324869156, 0.0037548085674643517, 0.005966720636934042, 0.021024366840720177, -0.03935987129807472, 0.03956473618745804, -0.009903987869620323, 0.010717050172388554, -0.01717032678425312, 0.005153658799827099, -0.03306024149060249, 0.018335502594709396, -0.030371377244591713, -0.01087069883942604, 0.027733728289604187, 0.028348324820399284, -0.03157496452331543, -0.0036299685016274452, -0.0019590305164456367, -0.01846354268491268, 0.03836114704608917, 0.05306027829647064, -0.01282332744449377, -0.038335539400577545, -0.035313766449689865, 0.013982100412249565, -0.017157522961497307, -0.007330359425395727, -0.02115240879356861, -0.008521143347024918, 0.0022167135030031204, -0.027912985533475876, -0.00359155610203743, 0.009494256228208542, 0.013277874328196049, 0.005995530169457197, -0.035723499953746796, 0.01982077956199646, 0.046222880482673645, -0.02427661418914795, -0.004491045605391264, 0.04053784906864166, -0.01742640882730484, 0.024148574098944664, -0.03587714955210686, -0.005998731125146151, 0.03672222048044205, -0.027247169986367226, -0.0525481142103672, 0.005601803306490183, -0.02247123420238495, 0.02612040750682354, 0.016888637095689774, -0.057977061718702316, 0.013201049529016018, 0.00423816405236721, -0.016261234879493713, -0.01879645138978958, 0.03385409712791443, 0.009903987869620323, 0.013841255567967892, 0.042612116783857346, -0.005320112686604261, -0.005560189951211214, -0.012221533805131912, 0.009097328409552574, 0.018258677795529366, -0.04939830303192139, -0.04852762073278427, -0.01028170995414257, 0.0016349263023585081, -0.004667102359235287, 0.015134471468627453, -0.009097328409552574, -0.05347001180052757, 0.0069526382721960545, 0.002379966201260686, 0.008431513793766499, -0.006110766902565956, 0.012035874649882317, 0.011542915366590023, -0.04965438321232796, -0.021754203364253044, -0.03941108658909798, 0.009161349385976791, -0.0009114934364333749, -0.0016013154527172446, -0.004206154029816389, -0.028783665969967842, 0.004833555780351162, 0.02863001637160778, 0.06484007090330124, -0.025147294625639915, -0.002695267554372549, -0.01285533793270588, 0.028604406863451004, 0.02329069748520851, 0.02439185231924057, -0.00416454067453742, -0.036747828125953674, -0.05828436091542244, -0.01599234715104103, 0.03024333529174328, 0.047733765095472336, 0.002919339807704091, 0.0017973785288631916, -0.002597636077553034, -0.004359803628176451, 0.025838717818260193, 0.020256120711565018, -0.009071719832718372, 0.006171586457639933, -0.031703006476163864, -0.01090270932763815, 0.012976977042853832, -0.03398213908076286, 0.02354677952826023, 0.0011619740398600698, 0.01249042060226202, -0.016491709277033806, 0.019078141078352928, 0.020768284797668457, 0.02056341990828514, -0.019692739471793175, 0.0037227983120828867, 0.04612044617533684, 0.052701763808727264, 0.037746552377939224, 0.004177344497293234, -0.004961597267538309, 0.0031418113503605127, 0.017080698162317276, -0.013777234591543674, -0.004036499187350273, 0.03234321251511574, 0.0016885435907170177, -0.006638937164098024, -0.053367577493190765, -0.004170942585915327, 0.05213838443160057, -0.018041007220745087, -0.01587711088359356, -0.004222159273922443, -0.01206788420677185, 0.007490410935133696, 0.015813089907169342, -0.05592840164899826, -0.02174139767885208, -0.0278873760253191, 0.003005767473950982, -0.009583884850144386, 0.0009971209801733494, 0.029449479654431343, 0.023405933752655983, -0.044558342546224594, -0.007163906004279852, 0.02001284249126911, -0.0036843859124928713, -0.03385409712791443, -0.014263791963458061, -0.021318862214684486, -0.008809235878288746, -0.04189508780837059, 0.03334193304181099, -0.017708100378513336, -0.010877101682126522, -0.004900777712464333, -0.020460985600948334, 0.009180555120110512, -0.04553145542740822, -0.004090916831046343, -0.003802824066951871, 0.002131886314600706, -0.0030793913174420595, -0.03946230188012123, -0.002866522641852498, -0.02152372896671295, -0.006142777390778065, -0.026760613545775414, -0.0050160144455730915, -0.055057723075151443, 0.003770813811570406, 0.03098597377538681, -0.022355996072292328, -0.015441770665347576, -0.03390531241893768, 0.013098616153001785, 0.04074271395802498, 0.02074267715215683, 0.008181833662092686, -0.027067912742495537, -0.013726018369197845, -0.002079069148749113, -0.05695273354649544, -0.011024348437786102, 0.01335469912737608, 0.01956469751894474, -0.037234384566545486, 0.02225356362760067, -0.04005129262804985, 0.006024339236319065, 0.001406052615493536, 0.035134509205818176, -0.009590286761522293, 0.03667100518941879, -0.02973117120563984, 0.009404627606272697, 0.011568523943424225, -0.057772196829319, 0.006978246383368969, 0.024852799251675606, 0.01610758528113365, 0.03408457338809967, -0.05295784771442413, -0.0041389320977032185, -0.04407178610563278, 0.017951378598809242, -0.0334443673491478, 0.054289475083351135, -0.001997442916035652, 0.029705561697483063, 0.006322035100311041, -0.029347047209739685, -0.025800304487347603, 0.0027320794761180878, -0.0007122292881831527, -0.04558267444372177, -0.027861768379807472, 0.0029177393298596144, 0.059820856899023056, -0.025364965200424194, -0.06524980068206787, 0.025518614798784256, 0.030883541330695152, 0.01355956494808197, -0.008930874988436699, 0.021242037415504456, -0.02372603677213192, -0.002115881070494652, 0.005470560863614082, -0.03628687933087349, -0.020358553156256676, -0.018591584637761116, -0.013649193570017815, -0.025761893019080162, -0.019142162054777145, -0.015108863823115826, 0.0065621123649179935, -0.006030741147696972, 0.0228041410446167, -0.01254803966730833, 0.007490410935133696, -0.08594126254320145, -0.027759335935115814, -0.007548029534518719, 0.018847666680812836, 0.007874534465372562, 0.0393342599272728, 0.033034633845090866, 0.016824616119265556, -0.005797066260129213, -1.4829774045210797e-05, 0.024775976315140724, 0.010691441595554352, -0.044302262365818024, -0.006136375479400158, 0.028015417978167534, 0.0045870766043663025, 0.006811792496591806, -0.021933460608124733, 0.06678629666566849, -0.005256091710180044, -0.008444318547844887, 0.022087110206484795, -0.004887973424047232, 0.021306058391928673, 0.01603076048195362, -0.013674802146852016, 0.0007922550430521369, 0.01540335826575756, 0.026683788746595383, -0.0037099942564964294, -0.009225369431078434, -0.05475042387843132, -0.04250968247652054, -0.0489373542368412, -0.023533975705504417, 0.047810591757297516, 0.013982100412249565, 0.013277874328196049, 0.025288140401244164, 0.020051253959536552, 0.03370044752955437, -0.03106279857456684, 0.0021302858367562294, 0.011773389764130116, 0.0218054186552763, -0.03014090284705162, -0.028220284730196, -0.004212555941194296, -0.008777225390076637, 0.0173879973590374, 0.026222841814160347, 0.01322665810585022, -0.013841255567967892, 0.010339328087866306, 0.015096059069037437, 0.029833603650331497, -0.025838717818260193, -0.021126801148056984, 0.008617173880338669, 0.018117832019925117, 0.02539057284593582, 0.0037259995006024837, 0.006971844006329775, -0.036056406795978546, -0.00258803297765553, -0.01897570863366127, -0.010640225373208523, -0.007528823334723711, -0.00517606595531106, 0.007650462910532951, 0.03646614030003548, 0.011824605986475945, 0.0014596699038520455, 0.010608214884996414, 0.00018535966228228062, 0.0042445664294064045, 0.034212611615657806, -0.01875803805887699, -0.008047390729188919, -0.004961597267538309, 0.03546741604804993, -0.006971844006329775, -0.013674802146852016, 0.016786202788352966, -0.010288111865520477, 0.010480173863470554, 0.011466090567409992, -0.012458410114049911, 0.01793857477605343, 0.00864278245717287, 0.035134509205818176, -0.01540335826575756, 0.005825875326991081, 0.030550634488463402, -0.016645358875393867, 0.019500676542520523, 0.0208579134196043, 0.0005765855894424021, -0.014609502628445625, -0.02103717252612114, 0.01850195601582527, 0.020422574132680893, -0.017029481008648872, -0.0124712148681283, -0.01764407940208912, 0.013213853351771832, -0.015032039023935795, -0.029372654855251312, -0.027426429092884064, 0.03021772764623165, 0.0028985331300646067, -0.0007510417490266263, -0.005236885976046324, -0.001505284570157528, -0.030038468539714813, -0.005073633044958115, 0.05439190939068794, 0.020064057782292366, -0.010012823157012463, -0.005502571351826191, -0.007279143203049898, 0.04250968247652054, 0.000618599122390151, 0.05956477299332619, -0.0105954110622406, 0.010268905200064182, -0.01944946125149727, -0.020512202754616737, -0.011542915366590023, -0.001965432660654187, 0.01956469751894474, 0.029628736898303032, -0.011101173236966133, -0.0010171274188905954, 0.012080688960850239, -0.050755538046360016, 0.01834830641746521, -0.010435359552502632, -0.010947523638606071, 0.014494265429675579, 0.002442386234179139, 0.015236904844641685, 0.006830998696386814, -0.009020503610372543, 0.0012267949059605598, 0.011869421228766441, -0.007906544953584671, -0.021818222478032112, -0.017067894339561462, -0.0324968621134758, -0.012900152243673801, -0.04875809699296951, -0.06617169827222824, 0.037823375314474106, -0.016017956659197807, 0.027580078691244125, -0.03685026243329048, -0.03436626121401787, -0.028834881260991096, -0.01772090420126915, -0.00467030331492424, 0.005560189951211214, 0.0175800584256649, -0.01964152231812477, -0.019103748723864555, 0.021933460608124733, 0.000257082749158144, -0.012336771003901958, -0.020422574132680893, -0.009353410452604294, -0.005323313642293215, 0.016939852386713028, 0.02384127490222454, 0.000234075341722928, 0.031216448172926903, 0.02303461544215679, 0.039590343832969666, -0.03375166282057762, 0.0041389320977032185, 0.027656903490424156, 0.002551221288740635, 0.003361081937327981, 0.011645348742604256, 0.021434100344777107, 0.056645434349775314, 0.03436626121401787, 0.00020746678637806326, -0.004907179623842239, -0.012042276561260223, -0.0006314032361842692, 0.030115293338894844, 0.03139570727944374, -0.0036363706458359957, 0.04189508780837059, -0.025557026267051697, 0.035723499953746796, 0.057157598435878754, 0.03359801694750786, -0.004839958157390356, -0.025774696841835976, 0.053623661398887634, -0.02729838714003563, -0.022048696875572205, -0.0005269696121104062, 0.004529458004981279, 0.034135788679122925, -0.017080698162317276, 0.002829710952937603, -0.01587711088359356, 0.017106305807828903, -0.0383867584168911, 0.008348287083208561, 0.030166510492563248, 0.0029449479188770056, -0.010941121727228165, 0.05864287540316582, 0.011491699144244194, -0.01394368801265955, -0.031370099633932114, -0.037259992212057114, -0.007976967841386795, -0.01116519421339035, -0.005089638289064169, -0.01306020375341177, -0.019756760448217392, 0.00271767470985651, -0.0496031679213047, -0.0065749166533350945, 0.012765709310770035, 0.007855328731238842, -0.022740120068192482, 0.009001297876238823, 0.006533303298056126, -0.029705561697483063, 0.036312490701675415, -0.005659421905875206, 0.02306022308766842, -0.045044898986816406, 0.01118439994752407, 0.003626767545938492, 0.009058916009962559, 0.0029369452968239784, -0.0022071104031056166, -0.00978234875947237, -0.002748084720224142, 0.012759307399392128, 0.05106283724308014, 0.036056406795978546, -0.004657499026507139, 0.010640225373208523, 0.013969296589493752, -0.01343152392655611, -0.03349558264017105, 0.012573647312819958, 0.04875809699296951, -0.005310509353876114, 0.015633832663297653, 0.015288121066987514, -0.01661974936723709, -0.0029945638962090015, 0.015083255246281624, 0.015505791641771793, -0.00921256560832262, 0.02103717252612114, -0.023713232949376106, 0.019807975739240646, -0.0021831027697771788, -0.004334195051342249, 0.033034633845090866, 0.022151131182909012, -0.028783665969967842, 0.00022227155568543822, -0.03208712860941887, -0.012221533805131912, -0.0018886079778894782, -0.030499417334794998, -0.023790057748556137, -0.031088408082723618, 0.004343798384070396, -0.01985919289290905, -0.037234384566545486, -0.02490401640534401, 0.017106305807828903, 0.01816904917359352, 0.008937276899814606, -0.020870719105005264, 0.010070441290736198, -0.01335469912737608, 0.003934066276997328, 0.025633851066231728, 0.027912985533475876, 0.021651769056916237, 0.03306024149060249, -0.002533615566790104, -0.015492986887693405, 0.00998721458017826, 0.025505810976028442, -0.006274019833654165, -0.023559583351016045, -0.0061491793021559715, -0.023521171882748604, 0.008982091210782528, 0.02619723230600357, 0.007279143203049898, -0.0008986892644315958, -0.02364921197295189, -0.031037190929055214, -0.04683747515082359, 0.044558342546224594, 0.01110757514834404, 0.012227935716509819, 0.015224101021885872, -0.0010875500738620758, 0.04184386879205704, -0.0034699169918894768, 0.013572368770837784, -0.01304099801927805, 0.035569850355386734, -0.021600553765892982, 0.02873244881629944, -0.004001288209110498, 0.0041101230308413506, -0.03669661283493042, -0.006344442255795002, 0.03231760486960411, 0.0005085637094452977, -0.007752895820885897, 0.022163935005664825, -0.011261224746704102, -0.01228555478155613, 0.027272779494524002, 0.00887965876609087, 0.0006226004334166646, 0.038668446242809296, -0.053623661398887634, 0.017823336645960808, -0.03941108658909798, 0.012791317887604237, 0.006290024612098932, -0.029551912099123, -0.0007298349519260228, -0.031446922570466995, -0.029679954051971436, 0.013162637129426003, 0.013316286727786064, 0.0026040382217615843, 0.012484018690884113, 0.006037143524736166, 0.03306024149060249, 0.02236879989504814, 0.04179265350103378, 0.027067912742495537, 0.034468695521354675, -0.01797698624432087, 0.003100197995081544, 0.010787472128868103, 0.007516019511967897, -0.0036523756571114063, -0.034801602363586426, -0.029167789965867996, 0.004190148785710335, 0.01153011154383421, 0.012170317582786083, -0.0061971950344741344, 0.033213891088962555, -0.01720874011516571, -0.027426429092884064, 0.031267665326595306, 0.009097328409552574, -0.02906535565853119, 0.015083255246281624, 0.0525481142103672, -0.0034859220031648874, -0.014468657784163952, -0.009539070539176464, -0.013533956371247768, 0.025544222444295883, -0.022676099091768265, 0.01486558560281992, 0.023751646280288696, 0.02272731624543667, -0.05347001180052757, 0.013162637129426003, 0.02229197509586811, -0.02763129398226738, -0.00447504036128521, -0.00732395751401782, -0.0157746784389019, -0.0011435680789873004, 0.03213834390044212, 0.020396966487169266, -0.01676059514284134, 0.01613319292664528, -0.005448153708130121, 0.014327812008559704, 0.0010843490017578006, 0.006075555924326181, -0.021498119458556175, -0.004967999178916216, 0.0011147588957101107, 0.03441748023033142, -0.031856656074523926, 0.0034475098364055157, -0.025339357554912567, 0.026402099058032036, -0.042458467185497284, 0.020768284797668457, -0.0010243296856060624, -0.005701035261154175, 0.009052514098584652, -0.029270222410559654, -0.01875803805887699, -0.0018998115556314588, -0.023572387173771858, -0.0030697882175445557, -0.003882849821820855, -0.010288111865520477, -0.009852771647274494, -0.005316911730915308, 0.003594757057726383, -0.04058906435966492, 0.0017253553960472345, -0.003911659121513367, 0.02571067586541176, 0.03398213908076286, 0.01066583301872015, -0.0015460976865142584, -0.004727921914309263, -0.022355996072292328, 0.026248449459671974, -0.03039698489010334, -0.009199761785566807, -0.009583884850144386, 0.015608224086463451, -0.006072354502975941, -0.042099952697753906, 0.01617160625755787, -0.01599234715104103, -0.024852799251675606, 0.020089667290449142, 0.012612059712409973, 0.0046735042706131935, -0.005617808550596237, 0.04015372693538666, 0.010819482617080212, 0.018950099125504494, -0.010217688977718353, 0.017439214512705803, 0.00624521030113101, 0.03157496452331543, -0.01709350198507309, 0.008162627927958965, -0.047067951411008835, 0.04939830303192139, 0.0008450720342807472, 0.034468695521354675, -0.007823318243026733, -0.04786180704832077, 0.007631256710737944, 0.02048659510910511, -0.00793855544179678, 0.00887965876609087, 0.012567245401442051, 0.004186947830021381, -0.013841255567967892, 0.022381603717803955, -0.01860438846051693, 0.04148535430431366, -0.00908452458679676, -0.0249424297362566, 0.007516019511967897, -0.007797710131853819, 0.006830998696386814, 0.0016485307132825255, -0.00020216507255099714, -0.011760585941374302, 0.011280431412160397, -0.026555748656392097, -0.01394368801265955, 0.003303463337942958, -0.001065943157300353, -0.005035220645368099, -0.024878408759832382, -0.021165212616324425, 0.05162621662020683, 0.01259925588965416, 0.035313766449689865, -0.014532677829265594, -0.008668390102684498, -0.020832305774092674, -0.05357244610786438, 0.007784905843436718, -0.007016658782958984, 0.0035467417910695076, 0.009314998053014278, -0.015224101021885872, 0.019961625337600708, 0.019590307027101517, -0.006863009184598923, 0.0010307318298146129, 0.022151131182909012, 0.003247445449233055, 0.012003864161670208, -0.01381564699113369, 0.008834843523800373, -0.013341894373297691, 0.00887965876609087, 0.003581953002139926, -0.028783665969967842, -0.012336771003901958, 0.009948802180588245, 0.018399523571133614, 0.004638293292373419, -0.025172902271151543, -0.0029049350414425135, 0.012592853978276253, 0.015416162088513374, -0.014250987209379673, 0.027323994785547256, 0.020601831376552582, -0.006895019672811031, -0.024379048496484756, -0.014929605647921562, 0.011895028874278069, 0.003671581856906414, -0.02929583005607128, -0.028501974418759346, 0.00952626671642065, 0.03764411807060242, 0.010896307416260242, -0.003492324147373438, -0.023303501307964325, -0.0006354045472107828, 0.011453286744654179, 0.02505766600370407, -0.007880937308073044, -0.0007770501542836428, -0.008117812685668468, 0.004193349741399288, -0.008706802502274513, -0.018950099125504494, 0.017618471756577492, 0.00836109183728695, -0.006959040183573961, 0.019167769700288773, 0.03920622169971466, -0.009571081027388573, 0.0039532724767923355, 0.008303472772240639, -0.02177981100976467, -0.011696564964950085, -0.0016741389408707619, 0.0489373542368412, -0.013905276544392109, -0.02217673882842064, -0.021280450746417046, -0.020806698128581047, 0.006078756880015135, -0.02998725324869156, 0.00036131631350144744, -0.022637687623500824, 0.008277864195406437, 0.017195936292409897, -0.017439214512705803, 0.004247767385095358, 0.01790016144514084, -0.026811830699443817, 0.015032039023935795, 0.010384142398834229, -0.009852771647274494, 0.017080698162317276, 0.0038572417106479406, 0.0050000096671283245, -0.009411029517650604, -0.013124224729835987, -0.025928346440196037, 0.0071959164924919605, 0.020947543904185295, 0.013188245706260204, 0.013303481973707676, 0.001259605516679585, 0.01595393568277359, -0.011280431412160397, -0.021946264430880547, 0.004446231294423342, 0.012131905183196068, -0.002426380990073085, 0.013495543971657753, 0.01989760436117649, -0.015390554443001747, 0.01001922506839037, 0.023188265040516853, 0.0066965557634830475, 0.044558342546224594, 0.0015613025752827525, -0.0022791337687522173, 0.011158792302012444, 0.03206152096390724, -0.022893769666552544, 0.007989771664142609, -0.006168385501950979, 0.034801602363586426, 0.0007110288715921342, -0.02450708858668804, -0.02174139767885208, -0.006347643211483955, -0.001172377378679812, -0.019846389070153236, -0.003042579395696521, -0.004049303475767374, 0.0008378697093576193, 0.00378041691146791, 0.013713214546442032, 0.016312450170516968, -0.004455834161490202, 0.007163906004279852, -0.013149833306670189, -0.026030778884887695, -0.028988530859351158, 0.0040236953645944595, 0.03423822298645973, -0.012503224425017834, 0.018105028197169304, 0.000807459931820631, -0.0023831671569496393, 0.01636366732418537, 0.024622326716780663, -0.008341885171830654, 0.007138297893106937, -0.016696574166417122, 0.0014732741983607411, -0.03267611935734749, -0.023149851709604263, -0.0023719635792076588, -0.0029705562628805637, -0.002968955785036087, -0.03300902619957924, 0.02007686346769333, -0.01621001772582531, 0.004497447516769171, 0.023457150906324387, -0.007708081044256687, 0.008425111882388592, -0.015006430447101593, 0.017746511846780777, -0.04606923088431358, 0.019244594499468803, 0.021139604970812798, -0.03828432410955429, -0.0019638321828097105, -0.007157504092901945, -0.0018998115556314588, 0.011991060338914394, 0.017964182421565056, -0.016222821548581123, 0.03603079915046692, 0.024852799251675606, 0.007989771664142609, -0.029039748013019562, 0.013495543971657753, -0.005902700126171112, -0.02870684117078781, 0.009679916314780712, 0.007874534465372562, 0.004958396311849356, 0.0715494304895401, 0.006978246383368969, 0.04189508780837059, 0.0013452330604195595, 0.03224077820777893, 0.01134445145726204, 0.011690163053572178, 0.00970552396029234, 0.018143439665436745, 0.0006986248772591352, 0.013828451745212078, -0.027093522250652313, 0.008482730947434902, 0.01507045142352581, -0.018591584637761116, 0.004186947830021381, 0.026069192215800285, 0.03285537660121918, -0.0010003220522776246, 0.013028194196522236, -0.003572349902242422, 0.007234328892081976, 0.04151096194982529, 0.022445624694228172, -0.005781061016023159, -0.043790094554424286, 0.02696548029780388, -0.04015372693538666, -0.0034347055479884148, 0.0004861564957536757, 0.03426383063197136, -0.002655254676938057, 0.007816916331648827, 0.0018886079778894782, 0.00738797802478075, 0.0016581336967647076, 0.004350200295448303, 0.0410500131547451, -0.008156225085258484, -0.00976314302533865, 0.003559545846655965, 0.0011907833395525813, -0.020793894305825233, -0.04407178610563278, 0.006754174362868071, 0.02663257345557213, 0.0015156879089772701, -0.00037792164948768914, -0.010243297554552555, -0.015236904844641685, 0.020128078758716583, 0.027323994785547256, -0.027861768379807472, -0.0015284919645637274, 0.02678622305393219, -0.010928317904472351, -0.017554450780153275, -0.00391486007720232, -0.037669725716114044, 0.009295792318880558, -0.041613396257162094, 0.0022327187471091747, 0.03887331485748291, 0.01436622440814972, -0.027349604293704033, 0.02303461544215679, 0.03451991081237793, 0.009980812668800354, -0.008553152903914452, 0.00598592683672905, 0.018540367484092712, -0.009564679116010666, 0.03485281765460968, -0.019167769700288773]
metadata : {"source": "pydantic_ai_docs", "crawled_at": "2025-03-15T11:18:04.933338", "url_path": "/examples/rag/", "chunk_size": 2248}
updated_dt: 2025-03-15T11:18:04.934852
---
# pyright: reportUnknownMemberType=false
# pyright: reportUnknownVariableType=false
@asynccontextmanager
async defdatabase_connect(
  create_db: bool = False,
) -> AsyncGenerator[asyncpg.Pool, None]:
  server_dsn, database = (
    'postgresql://postgres:postgres@localhost:54320',
    'pydantic_ai_rag',
  )
  if create_db:
    with logfire.span('check and create DB'):
      conn = await asyncpg.connect(server_dsn)
      try:
        db_exists = await conn.fetchval(
          'SELECT 1 FROM pg_database WHERE datname = $1', database
        )
        if not db_exists:
          await conn.execute(f'CREATE DATABASE {database}')
      finally:
        await conn.close()
  pool = await asyncpg.create_pool(f'{server_dsn}/{database}')
  try:
    yield pool
  finally:
    await pool.close()

DB_SCHEMA = """
CREATE EXTENSION IF NOT EXISTS vector;
CREATE TABLE IF NOT EXISTS doc_sections (
  id serial PRIMARY KEY,
  url text NOT NULL UNIQUE,
  title text NOT NULL,
  content text NOT NULL,
  -- text-embedding-3-small returns a vector of 1536 floats
  embedding vector(1536) NOT NULL
);
CREATE INDEX IF NOT EXISTS idx_doc_sections_embedding ON doc_sections USING hnsw (embedding vector_l2_ops);
"""

defslugify(value: str, separator: str, unicode: bool = False) -> str:
"""Slugify a string, to make it URL friendly."""
  # Taken unchanged from https://github.com/Python-Markdown/markdown/blob/3.7/markdown/extensions/toc.py#L38
  if not unicode:
    # Replace Extended Latin characters with ASCII, i.e. `žlutý` => `zluty`
    value = unicodedata.normalize('NFKD', value)
    value = value.encode('ascii', 'ignore').decode('ascii')
  value = re.sub(r'[^\w\s-]', '', value).strip().lower()
  return re.sub(rf'[{separator}\s]+', separator, value)

if __name__ == '__main__':
  action = sys.argv[1] if len(sys.argv) > 1 else None
  if action == 'build':
    asyncio.run(build_search_db())
  elif action == 'search':
    if len(sys.argv) == 3:
      q = sys.argv[2]
    else:
      q = 'How do I configure logfire to work with FastAPI?'
    asyncio.run(run_agent(q))
  else:
    print(
      'uv run --extra examples -m pydantic_ai_examples.rag build|search',
      file=sys.stderr,
    )
    sys.exit(1)

```

© Pydantic Services Inc. 2024 to present