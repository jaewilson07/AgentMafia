---
url: https://ai.pydantic.dev/examples/rag/
session_id: pydantic_ai_docs
chunk_number: 2
title: Asynchronous Document Retrieval with OpenAI and Pydantic
summary: This document provides an example of using Pydantic and OpenAI's API for retrieving documentation sections based on search queries. It imports necessary libraries, sets up logging with Logfire, and defines a data structure for dependency injection. An asynchronous tool function, 'retrieve', is implemented to perform the documentation retrieval process.
embedding: [0.0033364100381731987, 0.03562108427286148, 0.037853535264730453, -0.026789410039782524, -0.006844547111541033, 0.015271436423063278, -0.009021800011396408, 0.042490165680646896, -0.028801070526242256, -0.011137722060084343, 0.02865387499332428, -0.043986640870571136, 0.03692130371928215, -0.06108574569225311, -0.013885353691875935, -0.010088960640132427, -0.019540078938007355, -0.00016367729404009879, 0.025047607719898224, 0.03294704854488373, 0.09631431102752686, -0.0009299323428422213, 0.00743332551792264, 0.010984394699335098, -0.028555745258927345, 0.008482086472213268, -0.0034713384229689837, 0.04467355087399483, 0.022201847285032272, -0.005599526688456535, 0.0351794995367527, -0.005001548677682877, 0.0006711918977089226, 0.025979841127991676, -0.00910153053700924, 0.005492197349667549, -0.028825601562857628, -0.0143392039462924, 0.0020683903712779284, 0.017111368477344513, 0.02107335440814495, -0.03284892067313194, 0.0019211956532672048, -0.007893308065831661, -0.01573755219578743, -0.019687272608280182, -0.02065630443394184, 0.03230920806527138, 0.06206703931093216, -0.023330338299274445, 0.011757166124880314, -0.017602017149329185, 0.007660250645130873, 0.03343769907951355, 0.01486665103584528, -0.03122977912425995, -0.015639422461390495, -0.010156424716114998, 0.010236155241727829, -0.006611489225178957, -0.017319893464446068, -0.027010202407836914, -0.013738159090280533, 0.022974617779254913, -0.020042993128299713, 0.015946077182888985, -0.042686425149440765, 0.03081272915005684, -0.050880253314971924, -0.010254554450511932, 0.01639992743730545, 0.010162558406591415, -0.04425649717450142, -0.03284892067313194, 0.0061637721955776215, 0.004096915479749441, 0.020570440217852592, 0.03947267681360245, -0.03589094057679176, -0.04060116782784462, -0.031180715188384056, -0.02173572964966297, -0.03863857313990593, -0.002907092683017254, -0.029046393930912018, -0.03697036951780319, -0.06775856763124466, -0.028580278158187866, -0.0015194772277027369, -0.06368618458509445, -0.021858392283320427, 0.03890842944383621, -0.013958951458334923, -0.007555987685918808, 0.07551081478595734, 0.005811118520796299, -0.010677739046514034, 0.004587563686072826, -0.0012687864946201444, -0.016166869550943375, -0.00916899461299181, -0.07286130636930466, -0.03996332362294197, -0.013824022375047207, 0.009230325929820538, 0.013873087242245674, -0.012977654114365578, 0.01576208509504795, -0.027427254244685173, -0.05235220119357109, -0.06986835598945618, 0.007335195783525705, 0.013235244899988174, 0.009628977626562119, -0.013222978450357914, -0.039644401520490646, -0.019208891317248344, -0.0318676233291626, 0.034615255892276764, 0.013235244899988174, -0.06623755395412445, 0.01571301929652691, -0.00965351052582264, 0.002207918558269739, 0.037681806832551956, 0.02259436622262001, 0.0004032517608720809, -0.05141996592283249, -0.06054602935910225, 0.015369565226137638, 0.06766043603420258, 0.022741559892892838, 0.06255768984556198, -0.017295360565185547, -0.04781370237469673, 0.013492834754288197, -0.06039883568882942, -0.04013505205512047, -0.03559655323624611, 0.018374787643551826, 0.030493807047605515, -0.018301190808415413, -0.040527570992708206, 0.019233422353863716, -0.07850376516580582, 0.03238280490040779, -0.055884867906570435, 0.021613068878650665, -0.009862035512924194, -0.007322929333895445, 0.0013952817535027862, -0.0399387925863266, -0.03763274475932121, 0.0155290262773633, 0.03017488494515419, 0.02030058391392231, -0.013627762906253338, 0.0020177920814603567, 0.01498931273818016, -0.015811149030923843, -0.025881711393594742, 0.008107967674732208, 0.016056474298238754, -0.019564609974622726, -0.01651032269001007, -0.007850376889109612, -0.013713627122342587, -0.007267731707543135, -0.03537575900554657, -0.009843636304140091, -0.0034529392141848803, -0.04116541147232056, -0.0021067222114652395, 0.023612461984157562, 0.040895555168390274, -0.04796089604496956, -0.01756521873176098, -0.015479961410164833, -0.006844547111541033, -0.04406023770570755, -0.02627423033118248, -0.019871266558766365, -0.0316958948969841, 0.01344376988708973, -0.016939641907811165, -0.0029776233714073896, -0.001596141024492681, -0.02201785333454609, -0.017074570059776306, 0.046979598701000214, 0.015921546146273613, 0.027304591611027718, 0.028163226321339607, -0.034836046397686005, -0.025121206417679787, 0.004198111593723297, 0.020509108901023865, -0.03753461316227913, 0.02107335440814495, 0.0005124977324157953, 0.00923645868897438, 0.028923731297254562, -0.01717269979417324, -0.013615497387945652, -0.029855964705348015, -0.011695834808051586, -0.009990830905735493, -0.008512752130627632, -0.04253922775387764, -0.04190138727426529, 0.04445275664329529, -0.0633917897939682, 0.027402721345424652, -0.008985001593828201, -0.043741319328546524, -0.03711756318807602, -0.021196017041802406, 0.03667597845196724, 0.010346551425755024, -0.0013960484648123384, 0.000227883254410699, 0.038319651037454605, 0.004139847122132778, 0.004639695398509502, 0.04705319553613663, 0.021698931232094765, -0.009132196195423603, -0.03240733593702316, 0.014707189984619617, 0.04509060084819794, 0.00616683904081583, 0.037411950528621674, -0.027010202407836914, 0.005878583062440157, 0.06878892332315445, -0.013603230938315392, 0.005338869523257017, -0.02091389335691929, -0.011843029409646988, 0.01562715694308281, -0.009543114341795444, -0.00997243169695139, -0.0004802989133168012, -0.017160432413220406, 0.025906242430210114, 0.003538802731782198, -0.006268035154789686, -0.05470731109380722, 0.08424435555934906, 0.010683871805667877, -0.004701026249676943, -0.026421424001455307, 0.04516419768333435, -0.04347145929932594, -0.04447729140520096, -0.0205213762819767, -0.017442556098103523, 0.001954927807673812, -0.06010444834828377, -0.018215326592326164, 0.008709011599421501, 0.04364318773150444, 0.00688747875392437, 0.003823992097750306, 0.007592786103487015, 0.017761478200554848, -0.023992713540792465, -0.05338256061077118, -0.02027605101466179, -0.03567015007138252, -0.030469274148344994, 0.025243867188692093, 0.0375591479241848, -0.027844304218888283, -0.0694267675280571, -0.0007375060813501477, 0.008690612390637398, -0.0025651720352470875, 0.014621326699852943, -0.028408551588654518, 0.003946654032915831, 0.04406023770570755, 0.011272650212049484, 0.028261356055736542, -0.008095701225101948, 0.0251948032528162, -0.008230629377067089, -0.04344692826271057, -0.0018215327290818095, 0.038074325770139694, -0.002578971441835165, 0.00770318228751421, 0.04118994623422623, -0.03412460535764694, -0.03338863328099251, -0.011100923642516136, 0.02580811269581318, 0.03196575120091438, 0.015369565226137638, -0.02032511681318283, 0.009641244076192379, 0.01955234445631504, 0.032897986471652985, 0.015565824694931507, 0.009862035512924194, 0.04430556297302246, -0.0023735123686492443, -0.004970883019268513, 0.046096429228782654, -0.032677192240953445, 0.034590721130371094, 0.03954627364873886, -0.011910493485629559, -0.007237066049128771, 0.009316189214587212, -0.014241074211895466, 0.06893611699342728, -0.002148120664060116, 0.06191984564065933, -0.04170512780547142, -0.018264392390847206, -0.0013868487440049648, 0.04793636128306389, 0.0038025262765586376, -0.038319651037454605, -0.04594923555850983, 0.022471703588962555, -0.007746113929897547, -0.014903449453413486, 0.0058080521412193775, 0.02536652982234955, -0.06358805298805237, 0.009702575393021107, 0.015479961410164833, -0.007672516629099846, -0.02027605101466179, -0.007396526634693146, 0.026568619534373283, 0.01197795756161213, 0.039644401520490646, -0.04401117563247681, 0.032235611230134964, -0.05662084370851517, -0.03316784277558327, -0.039399079978466034, 0.08218362927436829, -0.005780453328043222, 0.03108258545398712, -0.03586640954017639, -0.01118678692728281, 0.024127641692757607, 0.002451709471642971, 0.02870294079184532, 0.02334260381758213, 0.0004848987446166575, -0.04315254092216492, -0.043348800390958786, -0.0027399654500186443, -0.006271101534366608, 0.03606266900897026, -0.052891913801431656, -0.02406631037592888, 0.034394461661577225, -0.02129414677619934, -0.03971799835562706, -0.008328759111464024, 0.006660554092377424, -0.014915715903043747, 0.02420124039053917, 0.009579912759363651, 0.030469274148344994, -0.016031941398978233, -0.027427254244685173, 0.010272953659296036, -0.06530532240867615, 0.011008926667273045, -0.03405100852251053, 0.030788196250796318, 0.007605052553117275, 0.05534515529870987, 0.008647680282592773, 0.00030761363450437784, -0.020153388381004333, -0.03694583475589752, 0.039840660989284515, 0.024054044857621193, -0.01723402924835682, 0.02713286504149437, -0.015578091144561768, 0.020349647849798203, 0.024078577756881714, -0.06952489912509918, 0.03576827794313431, -0.021245082840323448, -0.0310580525547266, 0.014793053269386292, -0.012658732011914253, 0.0031554833985865116, 0.03827058523893356, -0.023440733551979065, -0.010653206147253513, -0.004823688417673111, 0.008224496617913246, -0.02411537617444992, -0.02428710274398327, 0.004443435929715633, 0.020594973117113113, -0.00556579465046525, -0.006191371474415064, -0.037436485290527344, 0.03495870903134346, -0.03164683282375336, 0.005847917404025793, 0.028555745258927345, -0.035522956401109695, -0.02265569567680359, -0.004728625528514385, -0.002401111414656043, 0.0351794995367527, 0.03064100258052349, -0.017516152933239937, -0.054609183222055435, -0.00804663635790348, 0.03191668912768364, -0.029782366007566452, 0.0589759536087513, 0.06324459612369537, -0.014400535263121128, 0.03596453741192818, -0.031008988618850708, -0.028310421854257584, -0.023710591718554497, 0.0494573749601841, 0.02378418855369091, -0.027427254244685173, 0.011665169149637222, -0.016130071133375168, 0.004817555192857981, -0.02254530042409897, -0.04209764674305916, 0.00770318228751421, -0.06770949810743332, -0.0010288286721333861, 0.0061055077239871025, -0.05451105162501335, -0.005111944396048784, -0.014817586168646812, 0.0007125903503037989, 0.03520403429865837, -0.02254530042409897, 0.018153995275497437, -0.03542482480406761, 0.012867257930338383, -0.009886568412184715, -0.0034836046397686005, -0.03775540739297867, 0.06020257622003555, 0.012965387664735317, 0.058289047330617905, 0.009046332910656929, 0.054609183222055435, 0.009678042493760586, -0.041386205703020096, 0.05730774998664856, -0.008604749105870724, -0.03498324006795883, -0.011665169149637222, 0.008058902807533741, -0.018019067123532295, -0.0030987521167844534, 0.022582098841667175, 0.004357572179287672, -0.034860577434301376, -0.017160432413220406, -0.0525975227355957, -0.060889486223459244, -0.017197230830788612, 0.028555745258927345, -0.0027200328186154366, -0.04513966664671898, -0.0016452058916911483, -0.030690066516399384, 0.04553218558430672, 0.008794874884188175, 0.011082524433732033, 0.037215691059827805, 0.008684479631483555, -0.008451420813798904, 0.017651081085205078, 0.02821229211986065, 0.01606873981654644, 0.01919662393629551, 0.031573232263326645, -0.012695531360805035, 0.01366456225514412, 0.01794547028839588, -0.013922152109444141, -0.04379038140177727, -0.017994536086916924, -0.02259436622262001, -0.015970610082149506, 0.00864154752343893, -0.0007716214749962091, 0.03086179308593273, 0.0318676233291626, -0.011211318895220757, -0.038515910506248474, -0.0005362635129131377, 0.025121206417679787, 0.005194741301238537, -0.002028525108471513, 0.0009920300217345357, -0.0024425098672509193, 0.008880739100277424, 0.03473791852593422, 0.012290745973587036, 0.009451117366552353, -0.01750388741493225, -0.02442203089594841, -0.017577484250068665, 0.01642446033656597, -0.029267186298966408, 0.007513056043535471, 0.007046939805150032, 0.019650474190711975, 0.0026280363090336323, 0.002499240916222334, -0.027966966852545738, 0.007028540596365929, -0.014130678027868271, -0.02256983332335949, 0.02153947204351425, -0.006685086525976658, 0.023281274363398552, -0.051321838051080704, 0.0315241701900959, -0.006654420867562294, 0.034639786928892136, -0.030248483642935753, -0.005210074130445719, -0.05598299950361252, 0.01432693749666214, -0.012658732011914253, -0.0093897869810462, 0.01179396454244852, -0.02710833214223385, 0.007586653344333172, -0.017602017149329185, 0.007046939805150032, -0.020018460229039192, 0.06505999714136124, 0.006501093041151762, 0.019834468141198158, -0.04258829355239868, 0.04501700401306152, -0.0045139663852751255, 0.017908671870827675, -0.04320160299539566, 0.02843308262526989, -0.009475650265812874, 0.0019871266558766365, -0.03795166313648224, -0.005200874526053667, 0.0059675127267837524, -0.008911403827369213, 0.010205489583313465, 0.030763663351535797, -0.03446805849671364, 0.009898834861814976, -0.023624727502465248, -0.0038607907481491566, -0.018681444227695465, -0.018705975264310837, -0.04253922775387764, 0.02843308262526989, -0.020337382331490517, 0.0005569627392105758, -0.012499271892011166, -0.044428225606679916, 0.005998178385198116, -0.0022094517480582, -0.03540029376745224, -0.0318676233291626, 0.010475346818566322, -0.0050598131492733955, -0.0159338116645813, 0.004701026249676943, 0.0006715751951560378, 0.019515546038746834, -0.041778724640607834, 0.02406631037592888, 0.009549247100949287, -0.016547122970223427, -0.04827981814742088, -0.020239252597093582, -0.004559964872896671, -0.002968423767015338, 0.011493442580103874, -0.04109181463718414, 0.04521326348185539, 0.04621909186244011, -0.01091079693287611, -0.015663955360651016, 0.03196575120091438, -0.03257906436920166, -0.022361308336257935, 0.007212533615529537, -0.0059092482551932335, -0.013566432520747185, -0.015381831675767899, -0.012401142157614231, 0.004796089604496956, -0.03162229806184769, -0.046832405030727386, 0.0005236139986664057, 0.01165903639048338, -0.05205781012773514, 0.009463383816182613, 0.027893370017409325, -0.023183144629001617, 0.01325977686792612, 0.0005431632744148374, 0.036185331642627716, 0.03598907217383385, 0.020644037052989006, 0.005642458330839872, -0.03797619789838791, -0.03689676895737648, -0.027402721345424652, 0.03213747963309288, -0.0366269126534462, 0.03083726018667221, 0.02312181331217289, -0.014044814743101597, -0.021245082840323448, 0.03584187477827072, 0.0006087108631618321, -0.02054590731859207, -0.006544025149196386, 0.022753825411200523, 0.034860577434301376, 0.0366269126534462, 0.014081613160669804, -0.023600194603204727, 0.03736288845539093, 0.00836555752903223, -0.02190745808184147, 0.013296575285494328, 0.030273014679551125, -0.012977654114365578, -0.019184358417987823, -0.029586106538772583, -0.016314063221216202, 0.01864464394748211, 0.033069711178541183, -0.010125759057700634, -0.02848214842379093, -0.041778724640607834, 0.007641850970685482, 0.02691207267343998, -0.05912315100431442, 0.020239252597093582, 0.0016022741328924894, -0.018902234733104706, -0.042907215654850006, 0.0388348326086998, 0.016056474298238754, 0.020398713648319244, 0.017442556098103523, 0.02259436622262001, -0.039423611015081406, 0.00014403217937797308, 0.01833798922598362, 0.016252733767032623, 0.03360942378640175, -0.01891450211405754, 0.009954032488167286, -0.002815095940604806, 0.010880131274461746, 0.032211076468229294, 0.018705975264310837, -0.040527570992708206, -0.027083799242973328, 0.004989282228052616, 0.056571777909994125, -0.029659705236554146, 0.006777083035558462, 0.0019733270164579153, 0.011205186136066914, 0.03949720785021782, -0.013824022375047207, -0.030935389921069145, -0.01789640635251999, 0.01756521873176098, 0.0100276293233037, 0.004219577647745609, 0.017602017149329185, 0.014523196965456009, -0.002830428769811988, -0.014510930515825748, -0.014768521301448345, 0.016056474298238754, 0.0006370764458552003, -0.02442203089594841, -0.03697036951780319, -0.018656911328434944, -0.003781060455366969, 0.017651081085205078, 0.026642216369509697, -0.06609036028385162, -0.022091450169682503, -0.010769736021757126, -0.038957495242357254, 0.0028733606450259686, -0.045679379254579544, 0.0002614236727822572, -0.022336775436997414, 0.013627762906253338, 0.02085256390273571, -0.024606024846434593, -0.024655088782310486, 0.007709315046668053, 0.0005071312771178782, -0.04511513561010361, 0.0038699903525412083, -0.05367695167660713, -0.0211592186242342, 0.0064704278483986855, 0.02715739607810974, 0.003922121599316597, -0.03623439371585846, -0.0033640090841799974, 0.005234606564044952, 0.018153995275497437, -0.0269366055727005, -0.01399574987590313, -0.07026087492704391, 0.00965351052582264, -0.040478505194187164, -0.011554772965610027, 0.002494641114026308, -0.005452332086861134, -0.018092665821313858, 0.04862327128648758, -0.0050751459784805775, -0.017933204770088196, -0.0027890303172171116, 0.05666990578174591, -0.03081272915005684, 0.04857420548796654, -0.01637539453804493, 0.008359424769878387, -0.020226987078785896, -0.05377507954835892, 0.06805295497179031, 0.028187759220600128, 0.022361308336257935, -0.0011829229770228267, -0.03903109207749367, -0.012548336759209633, -0.006087108515202999, -0.015173306688666344, 0.0007164235576055944, 0.01059187576174736, -0.020950693637132645, 0.008445288054645061, 0.004164379555732012, -0.004759290721267462, -0.017160432413220406, 0.032235611230134964, -0.031156182289123535, -0.03449259325861931, 0.0013224511640146375, 0.015234637074172497, 0.03436993062496185, -0.03132791072130203, 0.0058939154259860516, 0.011045725084841251, 0.018963566049933434, -0.004259442910552025, 0.0028932930435985327, -0.0033609424717724323, 0.014228807762265205, 0.005979779176414013, 0.0015539759770035744, 0.004351439420133829, -0.015320501290261745, 0.022410372272133827, -0.033339567482471466, -0.003268945962190628, -0.05696429684758186, -0.03108258545398712, 0.005939913913607597, 0.0009797638049349189, 0.03174496069550514, -0.003268945962190628, 0.004047850612550974, -0.09165314584970474, -0.019454214721918106, 0.00011097090464318171, 0.004379038233309984, 0.014682658016681671, -0.005863250233232975, 0.038074325770139694, 0.010076694190502167, 0.011346247978508472, -0.004664227832108736, -0.002393445000052452, -0.0039773196913301945, -0.010598008520901203, -0.029218120500445366, 0.02173572964966297, -0.0009835970122367144, -0.007243199273943901, 0.0310580525547266, 0.05927034467458725, -0.022827424108982086, -0.03240733593702316, 0.0014374469174072146, -0.021649867296218872, 0.01961367577314377, 0.01604420691728592, -0.015676220878958702, -0.01344376988708973, 0.05107651278376579, 0.03567015007138252, -0.013406971469521523, -0.01598287560045719, -0.00972097460180521, -0.02453242801129818, -0.00401105172932148, -0.026789410039782524, 0.03814792260527611, 0.007384260650724173, 0.010046028532087803, 0.0018460651626810431, -0.004443435929715633, 0.01695190742611885, -0.01855878159403801, 0.016191402450203896, 0.0388348326086998, 0.060889486223459244, 0.00832262635231018, -0.009659643284976482, -0.0010709938360378146, -0.02605343796312809, 0.007194134406745434, 0.03127884492278099, 0.023244474083185196, -0.004685693420469761, 0.0037565280217677355, 0.04666067659854889, 0.022851955145597458, -0.03927641734480858, -0.03392834588885307, 0.004704093094915152, 0.0016222067642956972, -0.010585742071270943, -0.01637539453804493, 0.009187393821775913, -0.018816372379660606, -0.02696113847196102, -0.0206072386354208, -0.021674400195479393, -0.010021496564149857, -0.009021800011396408, 0.013590964488685131, -0.001333950785920024, 0.012155817821621895, -0.018399320542812347, -0.005406333599239588, -0.005973645951598883, 0.03142603859305382, 0.022079184651374817, -0.009628977626562119, 0.0052714054472744465, -0.007329062558710575, 0.02497401088476181, -0.01554129272699356, 0.015946077182888985, 0.04349599406123161, -0.011830762960016727, -0.009923366829752922, 0.0031125517562031746, -0.02422577142715454, -0.012830459512770176, 0.04300534352660179, 0.026323294267058372, -0.01816626265645027, 0.023379404097795486, 0.009003400802612305, -0.00832262635231018, 0.011928892694413662, -0.013615497387945652, -0.007316796574741602, 0.043741319328546524, -0.0018905302276834846, 0.02607797086238861, 0.02334260381758213, -0.0002993722737301141, 0.008733544498682022, 0.010205489583313465, 0.04575297608971596, -0.032480932772159576, -0.02085256390273571, -0.028604811057448387, 0.007053073029965162, 0.030763663351535797, 0.0211592186242342, -0.027917902916669846, -0.01584794744849205, -0.026568619534373283, 0.008009837940335274, 0.07212533801794052, 0.0015187106328085065, -0.04538499191403389, -0.013002186082303524, -0.002332113916054368, 0.021012023091316223, 0.03751008212566376, 0.022250911220908165, -0.0069120111875236034, -0.018301190808415413, -0.01617913506925106, -0.035081371665000916, -0.028089629486203194, -0.003465205430984497, 0.0229010209441185, 0.06319553405046463, -0.034198202192783356, 0.007046939805150032, -0.01675564795732498, 0.007010140921920538, 0.05686616525053978, 0.0074578579515218735, -0.03284892067313194, 0.009616711176931858, 0.00442503672093153, -0.02843308262526989, -0.0007363561308011413, -0.001746402122080326, -0.05367695167660713, 0.006271101534366608, -0.012621933594346046, 0.0004086182452738285, -0.03510590270161629, -0.01770014688372612, -0.03039567731320858, -0.03454165905714035, -0.03191668912768364, 0.0304202102124691, 0.038761235773563385, 0.049408309161663055, -0.020288316532969475, -0.05161622539162636, 0.015553559176623821, -0.012303012423217297, 0.007053073029965162, 0.04695506393909454, 0.02259436622262001, 0.01783507503569126, 0.00428704172372818, 0.009714840911328793, -0.002795163542032242, -0.01659618690609932, -0.030518339946866035, 0.009751640260219574, -0.0040202513337135315, 0.017884138971567154, 0.027010202407836914, 0.006605356000363827, 0.01684151217341423, 0.048304349184036255, 0.04543405398726463, -0.0038761235773563385, -0.002255450002849102, 0.02627423033118248, -0.01595834456384182, 0.04001238942146301, -0.021809328347444534, 0.00514567643404007, 0.03625892847776413, 0.003925188444554806, 0.004225710406899452, -0.0044281031005084515, 0.017908671870827675, 0.026445956900715828, 0.020226987078785896, 0.0014581461437046528, -0.01659618690609932, 0.025513723492622375, -0.047691039741039276, 0.019822200760245323, 0.031794026494026184, -0.011898227035999298, 0.00034153737942688167, -0.013210712000727654, 0.030125821009278297, 0.02517027035355568, 0.010775868780910969, 0.002795163542032242, 0.0318676233291626, 0.017651081085205078, -0.006691219750791788, -0.01620366796851158, -0.007451724726706743, 0.020570440217852592, -0.00970870815217495, -0.05034054070711136, 0.002379645360633731, 0.014523196965456009, 0.021760262548923492, 0.011297183111310005, -0.025930775329470634, 0.00528367143124342, 0.0008203030447475612, -0.01005216222256422, -0.01869370974600315, -0.04908938705921173, -0.005857117008417845, 0.01089853048324585, 0.017871873453259468, -0.0030481540597975254, -0.0047102258540689945, 0.0026725013740360737, 0.012879524379968643, 0.021012023091316223, 0.008831674233078957, -0.007954639382660389, -0.008028237149119377, -0.019270220771431923, 0.047028664499521255, -0.008181564509868622, -0.010757469572126865, -0.016878310590982437, 0.018019067123532295, 0.03513043746352196, 0.014842118136584759, 0.023440733551979065, -0.008598615415394306, -0.019589142873883247, 0.01723402924835682, 0.01230914518237114, 0.020644037052989006, 0.03930094838142395, -0.025489192456007004, -0.0017878006910905242, 0.04712679237127304, 0.006090174894779921, 0.016583921387791634, -0.0059031154960393906, 0.010732936672866344, -0.012217149138450623, 0.01026068814098835, 0.012732329778373241, -0.0105796093121171, -0.0010441613849252462, 0.027648044750094414, -0.007807444781064987, -0.024372966960072517, -0.014081613160669804, -0.010818800888955593, -0.019846733659505844, 0.020570440217852592, 0.014707189984619617, 0.012720063328742981, 0.02561185322701931, -0.03343769907951355, -0.0027322990354150534, -0.005133410450071096, 0.0240049809217453, -0.025341996923089027, -0.03544935584068298, -0.01825212500989437, -0.006586956791579723, 0.009199660271406174, -0.014486398547887802, -0.046120963990688324, 0.003636932233348489, -0.01794547028839588, -0.012198748998343945, 0.019981661811470985, -0.019061695784330368, -0.0047255586832761765, -0.00629256758838892, 0.01291632279753685, 0.012805926613509655, 0.008733544498682022, -0.011456643231213093, -0.022631164640188217, -0.004802222829312086, 0.0293162502348423, 0.0007137403008528054, 0.03719116002321243, 0.002074523363262415, -0.005455398466438055, -0.0047102258540689945, 0.013873087242245674, 0.02043551206588745, -0.014977047219872475, -0.013517367653548717, -0.00023497465008404106, 0.0010433947900310159, 0.009070864878594875, -0.041337139904499054, 0.034394461661577225, 0.0056547243148088455, -0.025072140619158745, -0.006329366005957127, 0.016338596120476723, -0.03338863328099251, 0.035694681107997894, 0.0170377716422081, -0.037706341594457626, 0.02956157550215721, -0.0446980819106102, 0.013897620141506195, -0.023085014894604683, 0.008672213181853294, 0.001150724128820002, 0.016718849539756775, 0.008549550548195839, -0.009175127372145653, -0.005338869523257017, 0.014142944477498531, 0.009285523556172848, -0.02517027035355568, 0.020141122862696648, 0.01670658215880394, -0.0042839753441512585, 0.037019431591033936, -0.04099368676543236, 0.01798226870596409, -0.038736701011657715, -0.0013646162115037441, -0.03456619009375572, -0.007506922818720341, -0.007359728217124939, -0.034394461661577225, -0.012425674125552177, -0.03490964323282242, 0.029831431806087494, -0.0025973706506192684, 0.032652661204338074, 0.005584193859249353, 0.03753461316227913, 0.02466735616326332, 0.05912315100431442, 0.0017111367778852582, -0.017884138971567154, -0.005985912401229143, -0.01675564795732498, 0.007022407371550798, 0.011284916661679745, 0.007470123935490847, -0.02488814666867256, -0.022385839372873306, -0.024458829313516617, 0.026666749268770218, 0.006117774173617363, 0.028972797095775604, -0.01728309504687786, -0.02629876136779785, 0.002325980691239238, 0.03731382265686989, 0.015345033258199692, 0.0036767974961549044, 0.04128807410597801, 0.044428225606679916, 0.005860183387994766, -0.007243199273943901, -0.003477471647784114, -0.0269366055727005, 0.019625941291451454, -0.04278455302119255, 0.005424732808023691, 0.033339567482471466, 0.044379159808158875, -0.06295020878314972, -0.0020499909296631813, 0.022275444120168686, -0.050683993846178055, -0.0027997633442282677, 0.000453083252068609, 0.016853777691721916, -0.010180957615375519, 0.019037162885069847, 0.00455689849331975, 0.015124241821467876, 0.00428090849891305, -0.028948264196515083, 0.014780787751078606, 0.007421059068292379, -0.006452028173953295, 0.00039290214772336185, -0.006617622449994087, 0.017209498211741447, 0.012621933594346046, 0.0019917264580726624, 0.005587260238826275, -0.0046243625693023205, -0.019049430266022682, -0.06437309086322784, -0.0082858270034194, 0.0015447762561962008, 0.017516152933239937, 0.03822152316570282, -0.004520099610090256, -0.003820925485342741, -0.007181867957115173, 0.027402721345424652, -0.02268022857606411, -0.04825528338551521, 0.00092916568974033, 0.01723402924835682, -0.004955550190061331, 0.020460044965147972, -0.019491013139486313, 0.005624059122055769, 0.025906242430210114, 0.005280605051666498, -0.0011246585054323077, 0.02309728041291237, 0.042686425149440765, -0.00662988843396306, 0.04386397823691368, 0.022692495957016945, -0.008727410808205605, -0.0077829123474657536, -0.011536373756825924, -0.015345033258199692, 0.0030742196831852198, -0.012744596228003502, -0.0069120111875236034, 0.0019181291572749615, -0.028923731297254562, 0.027697110548615456, 0.022030118852853775, 0.006875212769955397, 0.021944256499409676, 0.06309740245342255, -0.010935329832136631, 0.039840660989284515, 0.016191402450203896, -0.024360699579119682, -0.02223864570260048, -0.006746417377144098, -0.013063517399132252, 0.018742773681879044, -0.029021861031651497, 0.02107335440814495, 0.012431807816028595, 0.015271436423063278, 0.00429317494854331, -0.0016099405474960804, 0.000969797489233315, 0.021196017041802406, 0.005719122011214495, 0.01681697927415371, -0.015026112087070942, -0.003986519295722246, -0.04943284019827843, 0.0012963854242116213, -0.024078577756881714, 0.01366456225514412, -0.024471096694469452, -0.016583921387791634, -0.00897273514419794, 0.010150291956961155, -0.01348056923598051, 0.011560906656086445, 0.008751943707466125, 0.005476864520460367, 0.009794571436941624, -0.03370755538344383, -0.017528418451547623, -0.0041306475177407265, 0.012413408607244492, -0.018399320542812347, 0.010230022482573986, -0.000913832918740809, 0.01377495750784874, -0.01891450211405754, -0.00044733347021974623, -0.004728625528514385, -0.0009935633279383183, -0.021330945193767548, -0.015921546146273613, 0.01888996921479702, 0.0074149263091385365, -0.012247813865542412, 0.014780787751078606, -0.014216541312634945, 0.015725286677479744, -0.005274471826851368, 0.01675564795732498, 0.03670050948858261, 0.03284892067313194, 0.005519796162843704, 0.016890576109290123, 0.018620112910866737, 0.013983483426272869, -0.008935936726629734, 0.030469274148344994, 0.003946654032915831, -0.03037114441394806, -0.02422577142715454, -0.019908064976334572, -0.005550461821258068, -0.02497401088476181, -0.006252702325582504, 0.018325723707675934, 0.010309753008186817, 0.006550157908350229, 0.024790016934275627, 0.01233367808163166, 0.02508440613746643, 0.022582098841667175, -0.0105796093121171, -0.0023229143116623163, -0.03392834588885307, -0.005130344070494175, 0.0028319619596004486, -0.028923731297254562, -0.008383956737816334, 0.00770318228751421, 0.01919662393629551, 0.012805926613509655, -0.007850376889109612, 0.0014060147805139422, -0.001133091514930129, 0.005685389973223209, -7.2830644057830796e-06, 0.0042747752740979195, -0.01465812511742115, 0.01485438458621502, 0.003781060455366969, -0.00015419014380313456, -0.0028196959756314754, -0.0013761158334091306, -0.0170377716422081, 0.03343769907951355, 0.059564732015132904, -0.017319893464446068, 0.0015670087886974216, 0.006685086525976658, 0.014633593149483204, -0.028285888954997063, -0.005443132482469082, -0.0031738828402012587, -0.004204244818538427, -0.008236762136220932, 0.019601410254836082, -0.017307627946138382, 0.03125431388616562, -0.011861428618431091, 0.03019941784441471, -0.0018767307046800852, 0.004375971853733063, -0.011008926667273045, 0.004483301192522049, -0.0038761235773563385, 0.018791839480400085, 0.022250911220908165, -0.0046672942116856575, 0.007555987685918808, 0.009009533561766148, 0.020644037052989006, 0.004701026249676943, -0.027574447914958, -0.03908015787601471, 0.005406333599239588, -0.004704093094915152, 0.00897273514419794, 0.01675564795732498, -0.0002683234342839569, -0.014584528282284737, 0.01485438458621502, -0.008751943707466125, 0.00810183398425579, -0.01291632279753685, -0.011082524433732033, -0.01205768808722496, -0.008899138309061527, -0.016522590070962906, 0.038564976304769516, 0.008475953713059425, -0.019601410254836082, 0.03542482480406761, 0.0031171515583992004, 0.03240733593702316, -0.03081272915005684, -0.01197795756161213, 0.012284613214433193, 0.025035342201590538, -0.016142336651682854, -0.009475650265812874, 0.0176756139844656, 0.03731382265686989, -0.017528418451547623, -0.059172213077545166, -0.0024394432548433542, -0.01252993755042553, -0.00716346874833107, -0.02754991501569748, 0.005338869523257017, 0.022471703588962555, -0.024152174592018127, 0.011217452585697174, -0.004277842119336128, 0.023023683577775955, 0.015013845637440681, -0.02624969743192196, -0.003330277046188712, 0.002802829723805189, -0.03213747963309288, 0.002375045558437705, 0.036577850580215454, -0.011732633225619793, 0.01078813523054123, 0.00635389843955636, -0.026176100596785545, 0.0009391320054419339, 0.019785402342677116, -0.0025191735476255417, -0.012014755979180336, -0.012395008467137814, 0.01146277692168951, 0.005050613544881344, 0.0093897869810462, -0.01024842169135809, 0.018730508163571358, 0.0017172698862850666, -0.003998785745352507, -0.0052131409756839275, 0.02669128030538559, -0.014044814743101597, 0.037730872631073, 0.017957737669348717, 0.00401718495413661, -0.009076997637748718, -0.014584528282284737, -0.03145057335495949, 0.029438912868499756, 0.002051524119451642, -0.02444656379520893, -0.050046153366565704, -0.01961367577314377, 0.0016206734580919147, 0.018607845529913902, 0.006323233246803284, -0.014228807762265205, 0.023624727502465248, -0.014486398547887802, 0.0003823608858510852, -0.02821229211986065, -0.0063171000219881535, -0.00916899461299181, -0.035940006375312805, 0.021061088889837265, -0.02948797680437565, 0.03015035390853882, 0.061968911439180374, 0.017528418451547623, -0.0046948934905231, -0.035081371665000916, 0.0029852897860109806, 0.030223950743675232, -0.00461209611967206, -0.008390090428292751, 0.0024808417074382305, 0.06054602935910225, -0.009003400802612305, -0.048108089715242386, -0.010401749052107334, 0.010438547469675541, -0.02732912451028824, 0.015786616131663322, 0.01999392732977867, 0.013222978450357914, -0.0008417689241468906, 0.010187090374529362, 0.010205489583313465, 0.02823682315647602, 0.009886568412184715, 0.006464294623583555, 0.026421424001455307, -0.011340114288032055, 0.010266820900142193, -0.003808659268543124, -0.005544328596442938, -0.009334588423371315, -0.008770342916250229, -0.020177921280264854, -0.012450207024812698, -0.01582341641187668, -0.01864464394748211, 0.001596141024492681, 0.026789410039782524, 0.035940006375312805, -0.004575297702103853, -0.01565168797969818, 0.0042839753441512585, -0.03559655323624611, 0.022189579904079437, -0.029218120500445366, 0.02956157550215721, -0.03368302434682846, 0.014891183003783226, -0.023747390136122704, 0.007641850970685482, -0.021588535979390144, 0.04585110768675804, -0.01485438458621502, -0.031794026494026184, 0.0229010209441185, 0.027280058711767197, -0.0165716540068388, 0.004026384558528662, 0.02146587334573269, -0.010364950634539127, -0.007255465257912874, -0.007954639382660389, -0.03081272915005684, 0.0143392039462924, 0.029242653399705887, -0.03800072893500328, -0.015467694960534573, -0.01811719685792923, 0.020484576001763344, -0.011100923642516136, 0.0033486762549728155, -0.03434539958834648, 0.009230325929820538, 0.008230629377067089, -0.025979841127991676]
metadata : {"source": "pydantic_ai_docs", "crawled_at": "2025-03-15T11:18:04.750292", "url_path": "/examples/rag/", "chunk_size": 4665}
updated_dt: 2025-03-15T11:18:04.751809
---
```
from__future__import annotations as _annotations
importasyncio
importre
importsys
importunicodedata
fromcontextlibimport asynccontextmanager
fromdataclassesimport dataclass
importasyncpg
importhttpx
importlogfire
importpydantic_core
fromopenaiimport AsyncOpenAI
frompydanticimport TypeAdapter
fromtyping_extensionsimport AsyncGenerator
frompydantic_aiimport RunContext
frompydantic_ai.agentimport Agent
# 'if-token-present' means nothing will be sent (and the example will work) if you don't have logfire configured
logfire.configure(send_to_logfire='if-token-present')
logfire.instrument_asyncpg()

@dataclass
classDeps:
  openai: AsyncOpenAI
  pool: asyncpg.Pool

agent = Agent('openai:gpt-4o', deps_type=Deps, instrument=True)

@agent.tool
async defretrieve(context: RunContext[Deps], search_query: str) -> str:
"""Retrieve documentation sections based on a search query.
  Args:
    context: The call context.
    search_query: The search query.
  """
  with logfire.span(
    'create embedding for {search_query=}', search_query=search_query
  ):
    embedding = await context.deps.openai.embeddings.create(
      input=search_query,
      model='text-embedding-3-small',
    )
  assert len(embedding.data) == 1, (
    f'Expected 1 embedding, got {len(embedding.data)}, doc query: {search_query!r}'
  )
  embedding = embedding.data[0].embedding
  embedding_json = pydantic_core.to_json(embedding).decode()
  rows = await context.deps.pool.fetch(
    'SELECT url, title, content FROM doc_sections ORDER BY embedding <-> $1 LIMIT 8',
    embedding_json,
  )
  return '\n\n'.join(
    f'# {row["title"]}\nDocumentation URL:{row["url"]}\n\n{row["content"]}\n'
    for row in rows
  )

async defrun_agent(question: str):
"""Entry point to run the agent and perform RAG based question answering."""
  openai = AsyncOpenAI()
  logfire.instrument_openai(openai)
  logfire.info('Asking "{question}"', question=question)
  async with database_connect(False) as pool:
    deps = Deps(openai=openai, pool=pool)
    answer = await agent.run(question, deps=deps)
  print(answer.data)

#######################################################
# The rest of this file is dedicated to preparing the #
# search database, and some utilities.        #
#######################################################
# JSON document from
# https://gist.github.com/samuelcolvin/4b5bb9bb163b1122ff17e29e48c10992
DOCS_JSON = (
  'https://gist.githubusercontent.com/'
  'samuelcolvin/4b5bb9bb163b1122ff17e29e48c10992/raw/'
  '80c5925c42f1442c24963aaf5eb1a324d47afe95/logfire_docs.json'
)

async defbuild_search_db():
"""Build the search database."""
  async with httpx.AsyncClient() as client:
    response = await client.get(DOCS_JSON)
    response.raise_for_status()
  sections = sessions_ta.validate_json(response.content)
  openai = AsyncOpenAI()
  logfire.instrument_openai(openai)
  async with database_connect(True) as pool:
    with logfire.span('create schema'):
      async with pool.acquire() as conn:
        async with conn.transaction():
          await conn.execute(DB_SCHEMA)
    sem = asyncio.Semaphore(10)
    async with asyncio.TaskGroup() as tg:
      for section in sections:
        tg.create_task(insert_doc_section(sem, openai, pool, section))

async definsert_doc_section(
  sem: asyncio.Semaphore,
  openai: AsyncOpenAI,
  pool: asyncpg.Pool,
  section: DocsSection,
) -> None:
  async with sem:
    url = section.url()
    exists = await pool.fetchval('SELECT 1 FROM doc_sections WHERE url = $1', url)
    if exists:
      logfire.info('Skipping {url=}', url=url)
      return
    with logfire.span('create embedding for {url=}', url=url):
      embedding = await openai.embeddings.create(
        input=section.embedding_content(),
        model='text-embedding-3-small',
      )
    assert len(embedding.data) == 1, (
      f'Expected 1 embedding, got {len(embedding.data)}, doc section: {section}'
    )
    embedding = embedding.data[0].embedding
    embedding_json = pydantic_core.to_json(embedding).decode()
    await pool.execute(
      'INSERT INTO doc_sections (url, title, content, embedding) VALUES ($1, $2, $3, $4)',
      url,
      section.title,
      section.content,
      embedding_json,
    )

@dataclass
classDocsSection:
  id: int
  parent: int | None
  path: str
  level: int
  title: str
  content: str
  defurl(self) -> str:
    url_path = re.sub(r'\.md$', '', self.path)
    return (
      f'https://logfire.pydantic.dev/docs/{url_path}/#{slugify(self.title,"-")}'
    )
  defembedding_content(self) -> str:
    return '\n\n'.join((f'path: {self.path}', f'title: {self.title}', self.content))

sessions_ta = TypeAdapter(list[DocsSection])