---
url: https://ai.pydantic.dev/examples/chat-app/
session_id: pydantic_ai_docs
chunk_number: 2
title: Chat Application - Send Message Endpoint
summary: This documentation chunk describes the '/chat/' endpoint in a FastAPI application, which processes chat prompts. It features an asynchronous function that streams JSON-encoded messages, starting with the user's prompt and followed by chat history from a database. The agent processes the prompt alongside the chat history, sending back responses in real-time.
embedding: [-0.044804323464632034, -0.0031968955881893635, 0.05637494847178459, 0.008811771869659424, 0.031271275132894516, -0.015240605920553207, 0.0020277269650250673, -0.006983153987675905, -0.011201080866158009, -0.028365876525640488, 0.01282581128180027, -0.03868769109249115, 0.010767819359898567, 0.000537992746103555, -0.022300217300653458, -0.020732831209897995, -0.016833478584885597, 0.03769373893737793, -0.004297570325434208, 0.029257886111736298, 0.07360345870256424, -0.020516199991106987, 0.020363284274935722, -0.004173326306045055, -0.023701945319771767, -0.01898704282939434, -0.02177775464951992, 0.0413382314145565, -0.02465766854584217, -0.0643775463104248, -0.03511965647339821, -0.012271490879356861, 0.048474300652742386, -0.005836285650730133, 0.0021009990014135838, -0.001635880209505558, 0.02365097403526306, 0.03980907425284386, 0.03180648013949394, -0.038840606808662415, 0.006862095557153225, -0.04931533709168434, 0.046894170343875885, -0.0129341259598732, -0.022096330299973488, 0.04121080040931702, -0.042204756289720535, 0.07334860414266586, 0.042204756289720535, -0.0045396871864795685, -0.027677755802869797, 0.004453672096133232, -0.021624838933348656, -0.003931209910660982, -0.015291578136384487, -0.011226566508412361, -0.025791794061660767, 0.023039311170578003, 0.01093984954059124, 0.00539665250107646, 0.03173002228140831, 0.006664579268544912, 0.006556264124810696, -0.0034565336536616087, -0.03313175216317177, -0.006594493053853512, -0.042408641427755356, 0.008671598508954048, -0.028518792241811752, 0.038636721670627594, 0.009952268563210964, -0.041108857840299606, -0.03889157995581627, -0.03540000319480896, -0.012265119701623917, -0.014832830056548119, -0.027397410944104195, 0.026377972215414047, -0.030965445563197136, -0.04437106102705002, 0.00036576337879523635, 0.009767495095729828, -0.047174517065286636, 0.020732831209897995, -0.03438056260347366, -0.0007880737539380789, -0.06554989516735077, -0.010748704895377159, -0.0036795358173549175, 0.0009286447893828154, -0.035833265632390976, 0.026607345789670944, -0.054947737604379654, -0.012456264346837997, 0.06305227428674698, 0.0642756000161171, 0.005074892193078995, 0.01134125329554081, -0.008626998402178288, -0.004243412986397743, 0.03771922364830971, -0.03063412755727768, -0.0873149111866951, -0.008505940437316895, 0.03886609524488449, 0.008142765611410141, 0.024211665615439415, 0.010570303536951542, -0.062389638274908066, -0.04643542319536209, -0.05887257307767868, 0.001332437968812883, 0.017547085881233215, -0.027371924370527267, -0.012398920953273773, 0.002026134170591831, 0.040318794548511505, -0.04923887923359871, 0.026887690648436546, -0.016973651945590973, -0.017330454662442207, 0.006432020105421543, -0.02069460228085518, -0.010175270959734917, 0.00790064875036478, -0.020949462428689003, -0.010143413208425045, -0.027907129377126694, -0.03509417176246643, 0.006893952842801809, 0.0465373694896698, -0.02981857769191265, 0.015176891349256039, -0.04174600914120674, -0.03611360862851143, 0.013877106830477715, -0.03728596493601799, 0.004625702276825905, -0.030047951266169548, 0.009410691447556019, 0.03669978678226471, -0.027320953086018562, -0.02186695672571659, -0.0077477325685322285, -0.006103888154029846, -0.008263823576271534, -0.06305227428674698, 0.016527647152543068, -0.02974211797118187, -0.05081900954246521, 0.02474687062203884, 0.021854212507605553, -0.03134773299098015, 0.004957019817084074, 0.005215065088123083, 0.02645443007349968, 0.020745573565363884, 0.040114905685186386, -0.010735961608588696, -0.05780216306447983, -0.011723542585968971, 0.009289633482694626, -0.020235855132341385, -0.04284190386533737, -0.03960518538951874, -0.04118531569838524, -0.023523543030023575, -0.010506588034331799, -0.03748985007405281, -0.020860260352492332, -0.01557192299515009, -0.013087041676044464, 0.018617495894432068, 0.02524384669959545, 0.0596371553838253, -0.017878403887152672, 0.03359049931168556, -0.05571231618523598, -0.027983587235212326, -0.007448272779583931, -0.010009611956775188, 0.005587797611951828, 0.00870345626026392, -0.03183196857571602, -0.03155162185430527, -0.001091117737814784, 0.040726568549871445, -0.005651512183248997, -0.03657235577702522, 0.017865659669041634, -0.018948813900351524, 0.03731144964694977, 0.0031459236051887274, 0.004415443167090416, -0.008002592250704765, -0.017368683591485023, 0.03669978678226471, -0.01550820842385292, -0.0030025651212781668, 0.035145144909620285, 0.01680799201130867, 0.04533952847123146, -0.009576350450515747, -0.05612009018659592, -0.002222057431936264, -0.06182894483208656, 0.0008991766371764243, 0.02984406240284443, -0.02156112529337406, -0.0037496222648769617, 0.018069548532366753, -0.039324842393398285, 0.02872268110513687, 0.010952592827379704, -0.031780995428562164, -0.0504876933991909, -0.008034450002014637, 0.023842118680477142, -0.05469287559390068, -0.028697194531559944, -0.037133049219846725, 0.0202740840613842, 0.03827991709113121, -0.022338446229696274, 0.02943628653883934, 0.06871015578508377, 0.028518792241811752, -0.019509505480527878, -0.02376566082239151, 0.057037584483623505, 0.03499222546815872, -0.04378488287329674, -0.024402810260653496, -0.026123112067580223, 0.06498920917510986, -0.05058963596820831, 0.013685962185263634, -0.0075183589942753315, 0.026913177222013474, 0.0413382314145565, 0.016960907727479935, 0.0030949516221880913, 0.024593954905867577, 0.001609597820788622, 0.02017213962972164, 0.024695897474884987, -0.026811232790350914, -0.04567084461450577, 0.03947775810956955, 0.06590670347213745, 0.02913045510649681, -0.026581859216094017, -0.00791339110583067, -0.0023924948181957006, 0.0012774838833138347, -0.03848380595445633, -0.02775421366095543, -0.014756372198462486, 0.003332289634272456, -0.026530887931585312, -0.00939794909209013, 0.01899978518486023, -0.03708207607269287, 0.021255293861031532, 0.0425870455801487, -0.029971493408083916, 0.04044622182846069, -0.04592570662498474, -0.026607345789670944, -0.00985032506287098, -0.0012066010385751724, -0.0039025379810482264, 0.025307562202215195, 0.005227808374911547, -0.058209940791130066, 0.018158748745918274, -0.016336502507328987, -0.00014186522457748652, 0.0664164200425148, 0.001127753872424364, -0.012660152278840542, -0.007365443278104067, 0.0013141200179234147, 0.022440390661358833, -0.0053647952154278755, 0.031780995428562164, 0.023052053526043892, -0.012475378811359406, 0.012857668101787567, 0.011519655585289001, -0.007180670276284218, 0.050462208688259125, -0.008295681327581406, -0.04019136354327202, 0.0237784031778574, 0.056527867913246155, 0.05209330841898918, 0.04024233669042587, -0.02553693577647209, -0.00587132852524519, 0.02097494713962078, 0.021917928010225296, 0.0006526795914396644, -0.015966955572366714, -0.04819395765662193, 0.006489363498985767, 0.005288337357342243, 0.005747084505856037, 0.044218145310878754, -0.04686868563294411, -0.031475163996219635, 0.08695810288190842, -0.0244537815451622, -0.042408641427755356, -0.025422248989343643, 0.003619006834924221, 0.03014989383518696, 0.028518792241811752, -0.009136717766523361, -0.0064638773910701275, -0.028799138963222504, -0.013010583817958832, 0.04990151524543762, -0.034074731171131134, -0.054743848741054535, -0.0321887731552124, 0.027907129377126694, -0.03338661044836044, -0.02167581208050251, 0.018948813900351524, 0.003845194587484002, -0.06147214397788048, 0.010035097599029541, 0.025906480848789215, 0.010022355243563652, -0.021726783365011215, -0.03012440912425518, -0.0036890930496156216, 0.025205617770552635, 0.049570199102163315, 0.003931209910660982, 0.023408856242895126, -0.0365978442132473, -0.0004647205932997167, -0.022809937596321106, -0.000136091053718701, 0.02534579113125801, 0.041822466999292374, -0.03122030384838581, -0.011303024366497993, -0.03223974257707596, 0.027983587235212326, 0.015304320491850376, -0.05092095583677292, 0.019127216190099716, -0.032469116151332855, -0.04284190386533737, -0.012806696817278862, -0.008282938040792942, 0.014603456482291222, -0.01391533575952053, 0.0078114476054906845, -0.011207452043890953, -0.039834558963775635, 0.041032399982213974, 0.021446438506245613, -0.020044710487127304, -0.07890453934669495, -0.02625054121017456, -0.010857020504772663, 0.003975810017436743, -0.004600216168910265, -0.007894276641309261, -0.005947786848992109, -0.03323369473218918, -0.028416849672794342, -0.005087635479867458, 0.035068683326244354, 0.003548920387402177, 0.033666957169771194, -0.006556264124810696, -0.0134693318977952, 0.021701296791434288, -0.001416063867509365, -0.0007279427954927087, 0.030685098841786385, 0.004141469020396471, 0.036827217787504196, -0.05438704416155815, 0.026123112067580223, 0.04760777950286865, -0.035935208201408386, 0.018260693177580833, -0.018757669255137444, 0.029283370822668076, 0.03361598402261734, 0.026276027783751488, -0.010188013315200806, 0.029512744396924973, 0.0013021734775975347, 0.020044710487127304, -0.022019872441887856, 0.021344494074583054, 0.004125540144741535, -0.010876134969294071, -0.0029595575761049986, 0.02316674031317234, 0.014284882694482803, 0.01611987128853798, -0.009691037237644196, -0.006836609449237585, -0.0483468733727932, 0.01631101593375206, 0.004151026252657175, -0.052348166704177856, -0.03647041320800781, -0.02803455851972103, -0.016043413430452347, 0.013061556033790112, 0.0664164200425148, 0.024925271049141884, -0.06906695663928986, -0.010812419466674328, 0.012500864453613758, -0.011360367760062218, 0.04454946517944336, 0.0522971972823143, -0.041032399982213974, 0.01970065012574196, 0.011704428121447563, -0.0018142820335924625, -0.046206049621105194, 0.02077106013894081, 0.040216848254203796, 0.007785961497575045, -0.010627646930515766, -0.002210907405242324, -0.0067665232345461845, -0.009678294882178307, -0.05397927016019821, 0.010602160356938839, -0.003555291797965765, -0.03012440912425518, 0.022529590874910355, -0.018732182681560516, -0.01780194602906704, -0.007664903532713652, -0.010901620611548424, -0.011850972659885883, -0.006275918334722519, -0.012137689627707005, -0.033947303891181946, 0.008856371976435184, -0.04307127743959427, -0.006728294305503368, -0.06707905232906342, 0.08068855851888657, 0.03491576761007309, 0.010729590430855751, 0.002497624373063445, 0.03731144964694977, 0.06086048111319542, -0.032978836447000504, 0.02388034760951996, 0.019356589764356613, -0.0417969785630703, 0.058821603655815125, 0.03631749749183655, 0.0037082075141370296, 0.003271760419011116, 0.035247087478637695, 0.0010465173982083797, -0.011500541120767593, 0.032061342149972916, -0.05102289840579033, -0.04745486378669739, 0.03114384599030018, 0.037234991788864136, -0.007957992143929005, 0.039426784962415695, 0.02526933327317238, -0.0026632831431925297, 0.011557884514331818, -0.010213499888777733, -0.02515464462339878, 0.04770972207188606, 0.011895573697984219, -0.03769373893737793, -0.005575054325163364, -0.0055304537527263165, 0.008168251253664494, 0.033565014600753784, -0.0028655780479311943, -0.01471814326941967, 0.0003902538155671209, -0.03677624464035034, -0.04954471066594124, -0.04324967786669731, 0.012838553637266159, -0.04467689245939255, 0.023090282455086708, 0.027907129377126694, -0.030455725267529488, 0.004928348120301962, 0.004045896697789431, -0.030200866982340813, -0.04786263778805733, 0.030251838266849518, 0.0318574532866478, 0.008168251253664494, -0.006298218388110399, -0.03720950707793236, 0.006543520838022232, -0.00162313727196306, -0.0017585314344614744, -0.007575702387839556, -0.03043024055659771, 0.029589202255010605, -0.031067388132214546, -0.005473110359162092, -0.0018222463550046086, 0.01917818747460842, 0.025294817984104156, -0.03741339221596718, -0.001956047723069787, -0.0017505671130493283, -0.02148466743528843, -0.013405616395175457, 0.011570626869797707, -0.022236503660678864, 0.04498272389173508, 0.005176836159080267, 0.019229158759117126, 0.013380130752921104, -0.01471814326941967, 0.005982829723507166, -0.05069158226251602, -0.015852268785238266, 0.002234800485894084, -0.02783067151904106, -0.018923327326774597, 0.011048165149986744, -0.01851555146276951, -0.014501512981951237, -0.002742926822975278, 0.008569655008614063, 0.01999373733997345, -0.00825108028948307, 0.003015307942405343, -0.010366415604948997, 0.020911233499646187, 0.009283262304961681, -0.007957992143929005, -0.03560389205813408, 0.029487259685993195, 0.007887905463576317, -0.007397300563752651, -0.00215197098441422, 0.013290929608047009, 0.029206912964582443, 0.02059265784919262, 0.004931533709168434, 0.022618792951107025, -0.024033263325691223, -0.03718401864171028, 0.013826134614646435, 0.0134693318977952, 0.005721598863601685, -0.07034125924110413, 0.0134693318977952, 0.009143088944256306, -0.02189244143664837, -0.0350177139043808, 0.012787582352757454, -0.009792981669306755, -0.026913177222013474, -0.012233261950314045, 0.005285151768475771, -0.042306698858737946, 0.01970065012574196, -0.014297625049948692, -0.015495465137064457, -0.017929375171661377, 0.02345982939004898, -0.0423576720058918, -0.009359720163047314, -0.011475054547190666, -0.0019687905441969633, 0.014374082908034325, 1.1766102943511214e-05, 0.018553780391812325, 0.01849006675183773, -0.029104970395565033, -0.0025708964094519615, -0.023829376325011253, -0.00985032506287098, -0.005504968110471964, 0.018948813900351524, -0.046996116638183594, -0.001898704213090241, 0.027779700234532356, -0.022402161732316017, -0.03180648013949394, 0.01910172961652279, 0.013354644179344177, 0.019343845546245575, 0.022911880165338516, -0.024033263325691223, -0.00272381235845387, -0.003835637355223298, 0.01248174998909235, 0.025677107274532318, -0.031780995428562164, -0.0538773275911808, 0.003778293961659074, 0.020567171275615692, -0.0024068306665867567, 0.028263933956623077, 0.02158661000430584, -0.011557884514331818, -0.03132224828004837, 0.0160943865776062, 0.01978985033929348, 0.039732616394758224, 0.002539039123803377, 0.038432832807302475, -0.014501512981951237, -0.02298833802342415, -0.005304266232997179, 0.013214471749961376, 0.03198488429188728, 0.008174622431397438, 0.027193522080779076, 0.025931967422366142, -0.024887042120099068, -0.011449568904936314, 0.046384453773498535, -0.00031439325539395213, 0.002499217167496681, -0.00440270034596324, 0.016043413430452347, 0.0279581006616354, 2.630728886288125e-05, 0.010691361501812935, 0.020809289067983627, -0.0019958694465458393, -0.010532074607908726, -0.0015172112034633756, 0.021140607073903084, -0.005304266232997179, -0.010876134969294071, -0.032086826860904694, 0.026403456926345825, 0.0006096720462664962, 0.017534341663122177, -0.030277324840426445, -0.009436178021132946, -0.03091447241604328, 0.012475378811359406, 0.03748985007405281, -0.025333046913146973, 0.011819114908576012, -0.017521599307656288, 0.05058963596820831, -0.02277170866727829, 0.025027215480804443, -0.005195950623601675, 0.00713606970384717, -0.001999055268242955, 0.020223110914230347, 0.023893089964985847, 0.012449893169105053, 0.024823328480124474, -0.010047840885818005, 0.026428943499922752, -0.012946869246661663, 0.006046544760465622, -0.0019910908304154873, 0.0047244601882994175, 0.018859611824154854, 0.002707883482798934, -0.006298218388110399, -0.06391879171133041, 0.0042561558075249195, 0.0564768947660923, -0.010837906040251255, -0.011430454440414906, 0.006772894877940416, 0.0004563580150716007, 0.018158748745918274, -0.007461015600711107, -0.015775810927152634, -0.0019815335981547832, 0.015023975633084774, -0.003657235763967037, 0.012641037814319134, -0.015176891349256039, 0.00984395295381546, 0.031169332563877106, -0.030990930274128914, 0.011526026763021946, -0.006569006945937872, 0.020618144422769547, -0.007461015600711107, -0.03211231529712677, -0.025116415694355965, -0.005431695841252804, -0.04205184057354927, 0.03708207607269287, -0.01550820842385292, -0.014654428698122501, -0.009582722559571266, -0.024593954905867577, 0.028518792241811752, -0.03458445146679878, 0.01730496808886528, -0.03254557400941849, 0.00277159851975739, 0.026785748079419136, -0.02265702188014984, -0.012819439172744751, 0.0033832616172730923, 0.012316091917455196, -0.03427862003445625, 0.025231104344129562, -0.06524406373500824, 0.00865885615348816, 0.05423412844538689, -0.006110259797424078, 0.026785748079419136, -0.007977106608450413, 0.017980346456170082, 0.06300129741430283, -0.009531750343739986, -0.012118575163185596, -0.02584276720881462, -0.025014473125338554, 0.013711447827517986, -0.01967516355216503, -0.006696437019854784, 0.005670626647770405, -0.01810777746140957, -0.005466739181429148, 0.0017489742022007704, -0.007690389174968004, 0.017139310017228127, -0.02247861959040165, 0.08043369650840759, -0.004055453930050135, 0.023192226886749268, -0.03331015259027481, 0.008932829834520817, -0.031092874705791473, -0.008875486440956593, -0.029461773112416267, 0.02375291846692562, 0.026174083352088928, 0.03155162185430527, -0.0504876933991909, 0.030863501131534576, -0.03091447241604328, 0.03771922364830971, -0.025524191558361053, 0.021854212507605553, -0.0059414152055978775, -0.029461773112416267, 0.015699353069067, -0.036929160356521606, -0.016986394301056862, -0.004928348120301962, -0.011201080866158009, -0.016757020726799965, -0.003956695552915335, 0.003822894534096122, 0.041924409568309784, -0.049289852380752563, -0.024823328480124474, 0.03868769109249115, 0.029665660113096237, 0.004154211841523647, -0.013023327104747295, -0.01039190124720335, 0.0015785368159413338, -0.005230993963778019, 0.012016631662845612, -0.006432020105421543, 0.0008067900198511779, -0.006212203297764063, -0.003838823176920414, -0.00020159795531071723, -0.025396762415766716, -0.021459180861711502, -0.01840086467564106, -0.02585550956428051, 0.03489028289914131, -0.014743629842996597, 0.016272787004709244, -0.09582722187042236, -0.027473868802189827, -0.023727431893348694, -0.012195033021271229, 0.035654861479997635, 0.0014447355642914772, -0.021204320713877678, -0.0022666577715426683, -0.006323704496026039, -0.03641944006085396, 0.011615227907896042, -0.006033801939338446, -0.005759827792644501, -0.03114384599030018, 0.029410801827907562, -0.01619632914662361, 0.029589202255010605, 0.006556264124810696, 0.03165356442332268, 0.009780238382518291, -0.017840174958109856, -0.0058872574009001255, -0.060503676533699036, 0.04146566241979599, -0.008136393502354622, -0.023141253739595413, 0.0019687905441969633, 0.010621274821460247, 0.022516848519444466, -0.023816632106900215, 0.031755510717630386, 0.012067603878676891, 0.01550820842385292, -0.014794601127505302, -0.03239265829324722, 0.05362246558070183, -0.018757669255137444, 0.03825443238019943, 0.013278186321258545, 0.0029229214414954185, 0.0015028753550723195, -0.041312746703624725, -0.004428185988217592, 0.0001931358128786087, 0.039528727531433105, 0.024441039189696312, -0.042026352137327194, 0.01800583302974701, -0.035247087478637695, -0.025485962629318237, 0.010264471173286438, -0.008499568328261375, -0.0078114476054906845, 0.030506698414683342, -0.003309989348053932, 0.06758877635002136, -0.051965877413749695, 0.03341209888458252, 0.01808229088783264, 0.010028726421296597, -0.014106480404734612, -0.004979319870471954, 0.022809937596321106, -0.020847517997026443, -0.0010449244873598218, -0.01819697767496109, -0.010500216856598854, -0.003934395499527454, -0.027881642803549767, 0.011780885979533195, -0.0031172519084066153, 0.06447948515415192, -0.001122975256294012, -0.002841684967279434, 0.034151189029216766, 0.029410801827907562, 0.029003025963902473, 0.02565162256360054, 0.011277538724243641, -0.005807613953948021, 0.009952268563210964, -0.029283370822668076, -0.011347625404596329, 0.021229807287454605, -0.011385854333639145, 0.0028846925124526024, 0.046894170343875885, -0.005431695841252804, -0.004829590208828449, 0.014144709333777428, 0.040930457413196564, 0.003507505636662245, -0.004657559562474489, 0.02844233438372612, 0.024734126403927803, 0.00328131765127182, -0.03369244188070297, 0.0058235423639416695, 0.030455725267529488, -0.03430410474538803, 0.045900218188762665, -0.02635248564183712, 0.009716523811221123, 0.005371166858822107, -0.0026234614197164774, 0.014730886556208134, -0.00019333492673467845, -0.0032112314365804195, -0.0023112583439797163, -0.00954449363052845, -0.017725488170981407, 0.013596761040389538, 0.005979644134640694, 0.005186393391340971, -0.029104970395565033, -0.028697194531559944, 0.04108337312936783, 0.002822570502758026, -0.030455725267529488, 0.006645464804023504, -0.004523758310824633, 0.004552430007606745, 0.020860260352492332, -0.0023526728618890047, -0.03552743420004845, 0.011576998978853226, -0.01680799201130867, -0.03629201278090477, 0.022950109094381332, -0.02017213962972164, 0.002752484055235982, 0.014590714126825333, -0.000570646661799401, 0.04760777950286865, -0.016948165372014046, -0.019356589764356613, 0.03606263920664787, -0.009149461053311825, 0.007410043850541115, -0.00494746258482337, 0.004170140717178583, -0.033259183168411255, 0.0059414152055978775, -0.014565227553248405, -0.025511449202895164, -0.018744925037026405, -0.006874838378280401, 0.02892656810581684, -0.03568034991621971, -0.0207838024944067, 0.04164406284689903, -0.0279581006616354, -0.013533046469092369, 0.0006626350223086774, 0.005113121122121811, 0.014730886556208134, -0.017343197017908096, -0.025575164705514908, -0.04164406284689903, -0.02574082277715206, 0.0018684397218748927, 0.06611058861017227, 0.017470628023147583, -0.011576998978853226, 0.004979319870471954, -0.020720088854432106, -0.02179049886763096, -0.013214471749961376, -0.04635896533727646, 0.025995682924985886, -0.006320518907159567, 0.04954471066594124, 0.007008639629930258, -0.01039827335625887, 0.03170453757047653, 0.03274946287274361, 0.05448899045586586, 0.02069460228085518, 0.002177456859499216, 0.012806696817278862, -0.029895035549998283, 0.026428943499922752, 0.004759503528475761, 0.007250756490975618, 0.02974211797118187, 0.03858574852347374, -0.0006809530896134675, 0.024925271049141884, -0.011653456836938858, -0.028595250099897385, 0.005285151768475771, 0.008231965824961662, -0.01970065012574196, -0.0036859074607491493, -0.003088580211624503, 0.004695788491517305, 0.03703110292553902, -0.013443845324218273, -0.021828727796673775, -0.0012161582708358765, 0.03929935395717621, 0.032367173582315445, 0.03769373893737793, -0.015622895210981369, -0.00034644981496967375, 0.05994298681616783, -0.025524191558361053, 0.007034125737845898, -0.013545789755880833, -0.0069321817718446255, -0.02077106013894081, -0.026887690648436546, 0.0025963825173676014, -0.013252700679004192, 0.0070596118457615376, -0.002749298233538866, -0.023204969242215157, -0.003265389008447528, -0.005011177621781826, -0.0159287266433239, -0.005632397718727589, -0.033666957169771194, -0.016158100217580795, 0.007970734499394894, -0.02762678451836109, 0.017763717100024223, -0.03331015259027481, 0.020847517997026443, -0.019879050552845, 0.01506220456212759, 0.01968790590763092, -0.012265119701623917, -0.023001082241535187, 0.010825162753462791, 0.05555940046906471, -0.03427862003445625, -0.009627322666347027, -0.03190842643380165, 0.06295032799243927, 0.041924409568309784, 0.02458121068775654, 0.009519007056951523, -0.0017840174259617925, -0.037948597222566605, 0.0003769134928006679, 0.03170453757047653, 0.03562937676906586, -0.00019851175602525473, -0.006279103923588991, 0.006983153987675905, 0.019420303404331207, 0.009684666059911251, -0.0032335314899683, 0.021408209577202797, 0.03410021960735321, 0.001935340347699821, 0.0014399569481611252, 0.023243198171257973, -0.018439093604683876, -0.01719028130173683, 0.018770411610603333, 0.017725488170981407, 0.010404644533991814, -0.016553133726119995, -0.011315767653286457, -0.01476911548525095, -0.026301514357328415, 0.020936718210577965, 0.017776459455490112, 0.03353952616453171, -0.022797193378210068, -0.007511987816542387, 0.008525054901838303, -0.005520896520465612, 0.0015514580300077796, -0.03473736718297005, -0.018413608893752098, -0.018642982468008995, -0.009780238382518291, 0.018158748745918274, -0.03667430207133293, -0.012507236562669277, -0.03348855674266815, -0.027524840086698532, 0.02546047791838646, 0.0029595575761049986, 0.025779051706194878, -0.028467820957303047, -0.002981857629492879, 0.041032399982213974, 0.025422248989343643, 0.021051404997706413, -0.021306265145540237, -0.02297559566795826, 0.027677755802869797, -0.01123293861746788, 0.008079050108790398, 0.03043024055659771, 0.0020707345101982355, 0.0031618522480130196, 3.422187364776619e-05, -0.005253294017165899, 0.019458532333374023, -0.0001986113202292472, 0.009595464915037155, 0.01590324006974697, 0.008684341795742512, -0.02037602663040161, 0.04347905144095421, 0.014144709333777428, -0.02895205467939377, -0.001667737727984786, 0.026479914784431458, -0.01452699862420559, 0.019165445119142532, 0.0007848879904486239, -0.005253294017165899, -0.03331015259027481, -0.01068499032407999, -0.0241734366863966, -0.016578618437051773, 0.02345982939004898, -0.018247948959469795, 0.010015983134508133, -0.0036636071745306253, 0.026607345789670944, 0.017942117527127266, -0.004765875171869993, 0.022045357152819633, -0.005686555523425341, 0.046206049621105194, 0.005743898916989565, -0.024020520970225334, -0.011175595223903656, -0.06402073800563812, -0.014501512981951237, -0.06534601002931595, 0.0017951675690710545, -0.011991146020591259, -0.01878315396606922, -0.029283370822668076, -0.022032614797353745, -0.014641685411334038, 0.007416415028274059, 0.013290929608047009, -0.01620907336473465, -0.002985043451189995, 0.016056157648563385, -0.003867494873702526, 0.014157452620565891, 0.06498920917510986, 0.008365767076611519, -0.019917279481887817, 0.004182883538305759, 0.01838812232017517, 0.0016852592816576362, 0.01422116719186306, -0.003018493764102459, -0.032774947583675385, -0.02268250659108162, -0.020070195198059082, 0.03331015259027481, 0.017368683591485023, -0.00800896342843771, 0.019356589764356613, -0.021000433713197708, 0.025294817984104156, -0.006944925058633089, 0.005281965713948011, -0.013520303182303905, 0.0321887731552124, 0.02467041276395321, 0.008295681327581406, -0.0044855293817818165, -0.02974211797118187, 0.0002472934720572084, 0.010653132572770119, -0.04049719497561455, 0.026097625494003296, 0.10117927193641663, 0.027703242376446724, -0.042026352137327194, 0.004380399826914072, -0.005737527273595333, -0.02487429976463318, 0.02974211797118187, -0.006569006945937872, -0.010882506147027016, 0.015495465137064457, -0.03282592073082924, 0.0018748111324384809, -0.007951620034873486, 0.02376566082239151, -0.012112203985452652, -0.004482343792915344, 0.026607345789670944, -0.016361989080905914, -0.01759805716574192, 0.02385486103594303, -0.007690389174968004, 0.036241039633750916, 0.002954778727144003, 0.024492010474205017, -0.008977430872619152, -0.016158100217580795, -0.03269848972558975, 0.005683369934558868, 0.04342808201909065, -0.0033928188495337963, 0.008601512759923935, -0.04324967786669731, 0.001090321340598166, 0.008454968221485615, 0.018362635746598244, -0.01739417016506195, 0.003603077959269285, 0.00844859704375267, -0.010767819359898567, -0.049391794949769974, 0.004794546868652105, -0.025702593848109245, 0.01550820842385292, 0.007613931316882372, 0.0097993528470397, -0.008773542940616608, 0.037234991788864136, 0.0037050219252705574, -0.00658812141045928, 0.030073435977101326, 0.03641944006085396, -0.011850972659885883, -0.008894600905478, 0.0050175487995147705, 0.008512311615049839, -0.027320953086018562, 0.026021167635917664, 0.033565014600753784, -0.021599354222416878, -0.021663067862391472, -0.018273435533046722, 0.03318272531032562, 0.0040076677687466145, -0.0023574514780193567, -0.006619978696107864, 0.0318574532866478, 0.03091447241604328, -0.007671274710446596, 0.02813650295138359, 0.00489967642351985, 0.007027754094451666, -0.0015618116594851017, 0.015763068571686745, 0.013851621188223362, -0.006052916403859854, -0.0078114476054906845, 0.03443153575062752, -0.03371793031692505, -0.03292786329984665, 0.021344494074583054, -0.0013125271070748568, -0.010079698637127876, -0.0033832616172730923, 0.02356177195906639, 0.0018397679086774588, 0.006753780413419008, -0.01690993644297123, -0.014093737117946148, -0.021025920286774635, 0.009181317873299122, -0.027575811371207237, 0.012328834272921085, 0.03573131933808327, 0.0026154969818890095, -0.014539741910994053, -0.004068196751177311, 0.005626026540994644, 0.020057452842593193, -0.006384233944118023, 0.007734989747405052, -0.013762420043349266, -0.0033737043850123882, -0.014781858772039413, 0.021917928010225296, -2.862193105102051e-05, -0.018872356042265892, -0.016030671074986458, -0.005039849318563938, -0.00999049749225378, -0.004463229328393936, -0.030583156272768974, 0.009671922773122787, 0.0228736512362957, 0.0311183612793684, -0.023408856242895126, 0.016655076295137405, -6.65522093186155e-05, 0.0025549677666276693, -0.0054221386089921, 0.013685962185263634, 0.00494746258482337, 0.010251728817820549, 0.0034501622430980206, -0.005724784452468157, -0.008512311615049839, 0.0318574532866478, 0.006119817029684782, 0.026479914784431458, -0.05540648475289345, 0.014284882694482803, -0.019356589764356613, 0.015215120278298855, 2.0234461771906354e-05, 0.014042765833437443, -0.010207127779722214, 0.015215120278298855, 0.03960518538951874, -0.0034055619034916162, -0.01809503324329853, -0.0064001623541116714, -0.012736610136926174, -0.01857926696538925, -0.028391363099217415, -0.019114471971988678, 0.0019018900347873569, 0.050079915672540665, 0.0037400650326162577, -0.008499568328261375, 0.03022635169327259, 0.005030292086303234, -0.012864040210843086, 0.015253349207341671, 0.011475054547190666, 0.00768401799723506, 0.007155184168368578, 0.008193736895918846, 0.007613931316882372, -0.008741685189306736, 0.0020930347964167595, -0.01849006675183773, -0.027677755802869797, 0.024109721183776855, 0.03331015259027481, -0.016234558075666428, -0.024708641692996025, -0.003093358827754855, 0.013074299320578575, 0.00805993564426899, 0.0047149029560387135, 0.015419007278978825, 0.022644277662038803, -0.052169766277074814, -0.021166091784834862, 0.01850280910730362, 0.002515146043151617, 0.00328131765127182, 0.010334557853639126, -0.029181428253650665, 0.019853565841913223, -0.01611987128853798, 0.008505940437316895, -0.012539093382656574, -0.003322732402011752, 0.012456264346837997, -0.002580453874543309, 0.04500821232795715, 0.026683803647756577, -0.0061707887798547745, 0.0006180346244946122, -0.004380399826914072, -0.04342808201909065, -0.0015339363599196076, 0.025817280635237694, -0.025218360126018524, -0.03359049931168556, 0.001134125399403274, 0.006301404442638159, 0.01731771230697632, 0.004514201078563929, -0.0017346383538097143, -0.021663067862391472, 0.023026566952466965, -0.021344494074583054, 0.00846133939921856, 0.018872356042265892, -0.005673812702298164, -0.007677646353840828, -0.019241902977228165, -0.00805993564426899, 0.022019872441887856, -0.008671598508954048, -0.007741361390799284, 0.030200866982340813, -0.004482343792915344, 0.016858965158462524, -0.009914039634168148, 0.013991793617606163, -0.007180670276284218, 0.01213131844997406, -0.012857668101787567, 0.030888987705111504, 0.04962116852402687, 0.047964584082365036, 0.0054221386089921, -0.01600518450140953, 0.005371166858822107, -0.005055777728557587, 0.017967604100704193, 0.024033263325691223, -6.933973781997338e-05, -0.014093737117946148, 0.0013220843393355608, -0.019445789977908134, 0.017075594514608383, 0.010340929962694645, 0.014399569481611252, -0.014131966978311539, 0.016782507300376892, -0.028595250099897385, -0.02474687062203884, 0.03751533851027489, -0.012781210243701935, 0.002519924659281969, 0.00604017311707139, 0.012443521060049534, -0.024593954905867577, -0.026123112067580223, 0.0108442772179842, -0.023396113887429237, 0.023243198171257973, -0.035068683326244354, -0.007671274710446596, -0.03361598402261734, -0.04174600914120674, 0.000818736560177058, 0.038127001374959946, 0.017343197017908096, -0.010512960143387318, 0.021000433713197708, 0.008646112866699696, 0.023396113887429237, 0.059331320226192474, -0.003485205350443721, 0.013660476543009281, -0.009404320269823074, 0.05744536221027374, -0.0019066686509177089, 0.008187365718185902, -0.001353145344182849, -0.0228736512362957, -0.021408209577202797, -0.016260044649243355, 0.0005077281966805458, 0.009691037237644196, -0.011124623008072376, 0.005479482002556324, 0.00763304578140378, 0.005205507855862379, 0.0019926836248487234, -0.049289852380752563, 0.01391533575952053, -0.0015809261240065098, -0.013940821401774883, -0.008818143047392368, 0.014182938262820244, 0.026530887931585312, 0.030481211841106415, 0.0072252703830599785, 0.028671707957983017, -0.006543520838022232, 0.011118251830339432, 0.0013109341962262988, 0.0031905239447951317, 0.014756372198462486, 0.005272408481687307, -0.00016197524382732809, 0.02376566082239151, -0.030506698414683342, 0.013443845324218273, 0.016158100217580795, -0.009308747947216034, -0.00025824448675848544, 0.007856047712266445, 0.04546695947647095, 0.017789201810956, 0.016260044649243355, -0.01800583302974701, -0.002836906351149082, 0.02298833802342415, -0.014667171984910965, 0.002484881319105625, -0.04661382734775543, -0.015189633704721928, -0.026530887931585312, -0.012379806488752365, -1.987357609323226e-05, 0.023103024810552597, -0.0038834235165268183, 0.0021264851093292236, -0.01496026013046503, -0.028493307530879974, -0.015151404775679111, 0.02895205467939377, -0.014679914340376854, -0.013061556033790112, -0.022045357152819633, 0.0011612041853368282, -0.01650216057896614, 0.001678887871094048, -0.035935208201408386, 0.010818791575729847, 0.019879050552845, 0.0054922248236835, -0.006084773689508438, 0.015113175846636295, -0.03529806062579155, 0.031373221427202225, -0.01144319772720337, -0.0006869263597764075, 0.025333046913146973, 0.010704104788601398, -0.015444493852555752, -0.014858316630125046, 0.04612959176301956, -0.02187969908118248, 0.002489659935235977, -0.03746436536312103, -0.03799957036972046, -0.009315119124948978, 0.015431750565767288, -0.02686220593750477, 0.016833478584885597, 0.009882181882858276, 0.042332183569669724, 0.0020404700189828873, -0.004055453930050135, -0.034074731171131134, -0.014603456482291222, 0.01263466663658619, -0.028085531666874886]
metadata : {"source": "pydantic_ai_docs", "crawled_at": "2025-03-15T11:18:02.233792", "url_path": "/examples/chat-app/", "chunk_size": 3664}
updated_dt: 2025-03-15T11:18:02.233792
---
@app.post('/chat/')
async defpost_chat(
  prompt: Annotated[str, fastapi.Form()], database: Database = Depends(get_db)
) -> StreamingResponse:
  async defstream_messages():
"""Streams new line delimited JSON `Message`s to the client."""
    # stream the user prompt so that can be displayed straight away
    yield (
      json.dumps(
        {
          'role': 'user',
          'timestamp': datetime.now(tz=timezone.utc).isoformat(),
          'content': prompt,
        }
      ).encode('utf-8')
      + b'\n'
    )
    # get the chat history so far to pass as context to the agent
    messages = await database.get_messages()
    # run the agent with the user prompt and the chat history
    async with agent.run_stream(prompt, message_history=messages) as result:
      async for text in result.stream(debounce_by=0.01):
        # text here is a `str` and the frontend wants
        # JSON encoded ModelResponse, so we create one
        m = ModelResponse(parts=[TextPart(text)], timestamp=result.timestamp())
        yield json.dumps(to_chat_message(m)).encode('utf-8') + b'\n'
    # add new messages (e.g. the user prompt and the agent response in this case) to the database
    await database.add_messages(result.new_messages_json())
  return StreamingResponse(stream_messages(), media_type='text/plain')

P = ParamSpec('P')
R = TypeVar('R')

@dataclass
classDatabase:
"""Rudimentary database to store chat messages in SQLite.
  The SQLite standard library package is synchronous, so we
  use a thread pool executor to run queries asynchronously.
  """
  con: sqlite3.Connection
  _loop: asyncio.AbstractEventLoop
  _executor: ThreadPoolExecutor
  @classmethod
  @asynccontextmanager
  async defconnect(
    cls, file: Path = THIS_DIR / '.chat_app_messages.sqlite'
  ) -> AsyncIterator[Database]:
    with logfire.span('connect to DB'):
      loop = asyncio.get_event_loop()
      executor = ThreadPoolExecutor(max_workers=1)
      con = await loop.run_in_executor(executor, cls._connect, file)
      slf = cls(con, loop, executor)
    try:
      yield slf
    finally:
      await slf._asyncify(con.close)
  @staticmethod
  def_connect(file: Path) -> sqlite3.Connection:
    con = sqlite3.connect(str(file))
    con = logfire.instrument_sqlite3(con)
    cur = con.cursor()
    cur.execute(
      'CREATE TABLE IF NOT EXISTS messages (id INT PRIMARY KEY, message_list TEXT);'
    )
    con.commit()
    return con
  async defadd_messages(self, messages: bytes):
    await self._asyncify(
      self._execute,
      'INSERT INTO messages (message_list) VALUES (?);',
      messages,
      commit=True,
    )
    await self._asyncify(self.con.commit)
  async defget_messages(self) -> list[ModelMessage]:
    c = await self._asyncify(
      self._execute, 'SELECT message_list FROM messages order by id'
    )
    rows = await self._asyncify(c.fetchall)
    messages: list[ModelMessage] = []
    for row in rows:
      messages.extend(ModelMessagesTypeAdapter.validate_json(row[0]))
    return messages
  def_execute(
    self, sql: LiteralString, *args: Any, commit: bool = False
  ) -> sqlite3.Cursor:
    cur = self.con.cursor()
    cur.execute(sql, args)
    if commit:
      self.con.commit()
    return cur
  async def_asyncify(
    self, func: Callable[P, R], *args: P.args, **kwargs: P.kwargs
  ) -> R:
    return await self._loop.run_in_executor( # type: ignore
      self._executor,
      partial(func, **kwargs),
      *args, # type: ignore
    )

if __name__ == '__main__':
  importuvicorn
  uvicorn.run(
    'pydantic_ai_examples.chat_app:app', reload=True, reload_dirs=[str(THIS_DIR)]
  )

```

Simple HTML page to render the app:
chat_app.html