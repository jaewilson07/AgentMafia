---
url: https://ai.pydantic.dev/graph/
session_id: pydantic_ai_docs
chunk_number: 4
title: Pydantic Graph Example - Machine State and Nodes
summary: This document illustrates the use of Pydantic Graph by defining a machine state with user balance and product selection. It includes data classes for `MachineState`, `InsertCoin`, and `CoinsInserted` that manage user interactions within an asynchronous context, specifically handling coin insertion and product selection.
embedding: [-0.011763961985707283, 0.010534791275858879, -0.0075286682695150375, -0.038344770669937134, 0.04323473200201988, -0.02557208761572838, 0.0185711607336998, 0.0612981915473938, 0.014696601778268814, 0.00721469521522522, 0.05336202681064606, -0.040135081857442856, -0.021283350884914398, -0.033347927033901215, 0.03308071568608284, -0.020441636443138123, -0.03449693322181702, 0.005280756391584873, 0.006155872251838446, 0.03161105513572693, 0.05309481546282768, 0.06183261051774025, 0.04398291930556297, -0.006416402757167816, -0.03131712228059769, 0.017168303951621056, -0.006880681961774826, 0.030836142599582672, 0.00656336871907115, -0.010634995065629482, 0.023421039804816246, -0.008864723145961761, -0.017996657639741898, -0.012719240970909595, -0.0317981019616127, 0.006212654523551464, -0.011476709507405758, 0.02885878086090088, 0.01993393711745739, 0.003221561899408698, 0.000606234825681895, -0.07364333420991898, 0.015458152629435062, 0.012532193213701248, -0.05638150870800018, 0.016299868002533913, -0.02143031731247902, 0.02778993733227253, 0.03666134178638458, 0.05600741505622864, -0.0602293461561203, -0.001617461210116744, -0.04018852487206459, -0.025665611028671265, -0.04876599833369255, 0.010254220105707645, -0.02776321768760681, 0.022739650681614876, -0.009379103779792786, -0.030141394585371017, 0.011029131710529327, -0.013079975731670856, 0.015925772488117218, 0.05411021411418915, -0.03858526051044464, 0.03711559996008873, -0.06498569995164871, 0.041925396770238876, -0.02217850834131241, 0.013213581405580044, 0.03602003678679466, 0.00360734760761261, -0.021029500290751457, -0.023087024688720703, -0.011463349685072899, -0.04785747826099396, 9.576798765920103e-05, 0.018584521487355232, -0.01442939043045044, -0.013300424441695213, -0.007962886244058609, 0.00024925771867856383, -0.005150490906089544, 0.037676744163036346, 0.00821673683822155, -0.08604191988706589, -0.037462975829839706, 0.0023380958009511232, -0.05451103299856186, -0.08347669988870621, -0.022298753261566162, -0.006259416230022907, -0.004028204828500748, 0.03698199614882469, 0.049567628651857376, 0.04376915097236633, 0.025064386427402496, -0.025585448369383812, -0.03139728680253029, 0.005828538443893194, 0.013387268409132957, -0.02757616899907589, -0.03797067329287529, 0.004803116898983717, 0.0360734760761261, -0.004940062295645475, -0.006519947201013565, 0.040776390582323074, -0.054136935621500015, -0.027549447491765022, -0.0865228995680809, -0.009425866417586803, -0.005457783583551645, 0.020642045885324478, -0.030515490099787712, 0.022298753261566162, -0.009051770903170109, -0.028591571375727654, 0.02875189669430256, -0.03310743719339371, -0.056060854345560074, 0.018584521487355232, -0.002535163890570402, -0.022846534848213196, -0.012692519463598728, 0.023140467703342438, -0.02676117606461048, -0.010708478279411793, -0.020708847790956497, 0.011363144963979721, -0.0007594635826535523, 0.0085039883852005, -0.006413062568753958, -0.04443718120455742, -0.02093597687780857, 0.0032633135560899973, -0.03893263265490532, 0.022138426080346107, -0.04168490692973137, 0.048285018652677536, 0.029874183237552643, -0.0580916590988636, -0.014335867017507553, 0.008223416283726692, -0.03318759799003601, 0.011790682561695576, -0.04860566928982735, 0.03000778891146183, -0.039199844002723694, 0.005561327561736107, 0.06760437041521072, 0.019733527675271034, -0.021590644493699074, -0.016660602763295174, -0.024917419999837875, -0.003854517824947834, -0.00495676277205348, 0.04347522184252739, -0.010120614431798458, -0.04657486826181412, -0.013908329419791698, 0.0030629055108875036, -0.02503766492009163, -0.02100278064608574, -0.06535979360342026, -0.0006985060754232109, -0.0568624883890152, -0.016059378162026405, -0.012525512836873531, -0.0191055815666914, -0.008684355765581131, -0.006820559501647949, -0.022525882348418236, -0.0036106877960264683, 0.018531078472733498, -0.03305399417877197, -0.06055000051856041, -0.04390275850892067, 0.02078901045024395, -0.02853812836110592, -0.011383186094462872, -0.04726961627602577, -0.02040155604481697, -0.04590683802962303, -0.03203859180212021, -0.008624233305454254, 0.008991648443043232, 0.02204490266740322, -0.00339858909137547, 0.01786305196583271, 0.02304694429039955, 0.007775838486850262, 0.013607717119157314, 0.04112376272678375, 0.008918165229260921, -0.0360734760761261, 0.08486619591712952, 0.029954345896840096, 0.0689404234290123, 0.0362338051199913, 0.028965666890144348, 0.03326776251196861, 0.017488956451416016, -0.001487195841036737, 0.014977172948420048, -0.060175903141498566, -0.020481718704104424, -0.01814362220466137, -0.01703469827771187, 0.027843380346894264, 0.027242155745625496, -0.04694896191358566, 0.01660715974867344, -0.014897010289132595, -0.04248654097318649, -0.009853403083980083, -0.02014770545065403, 0.01436258852481842, 0.014148819260299206, 0.052319902926683426, -0.021590644493699074, 0.05272071808576584, 0.009759879671037197, 0.0032115415669977665, 0.01865132339298725, 0.019853772595524788, 0.007415103726089001, -0.029740577563643456, 0.00998700875788927, 0.018317310139536858, -0.002227871213108301, -0.0012959730811417103, -0.007548708934336901, -0.04248654097318649, -0.010174056515097618, -0.010374465025961399, -0.006793837994337082, -0.00962627399712801, -0.031637776643037796, -0.007869361899793148, -0.01273260172456503, 0.030622374266386032, 0.01446947269141674, 0.017903132364153862, 0.009953607805073261, 0.018691405653953552, -0.02979402057826519, 0.003246612846851349, 0.01878492906689644, 0.05384300649166107, 0.029072551056742668, 0.012578954920172691, 0.00718797417357564, 0.007348300889134407, -0.0262935571372509, -0.05632806569337845, -0.022525882348418236, 0.023875297978520393, -0.006539987865835428, 0.008029689081013203, 0.0015965853817760944, -0.013460751622915268, -0.0733761265873909, 0.03201187029480934, 0.03984115272760391, -0.019626643508672714, 0.024636849761009216, -0.03487102687358856, -0.021884575486183167, -0.06172572821378708, 0.01632658764719963, 0.01559175830334425, 0.030301719903945923, 0.0008742808131501079, -0.010648355819284916, -0.0241558700799942, -0.020481718704104424, 0.07086434215307236, 0.027816658839583397, 0.018050098791718483, -0.05330858379602432, 0.014175540767610073, 0.03543217107653618, 0.05557987466454506, -0.01457635685801506, 0.03235924616456032, -0.008817961439490318, 0.00705436896532774, -0.004345518071204424, -0.008383743464946747, 0.02599962428212166, 0.02525143325328827, 0.011790682561695576, -0.012405267916619778, 0.05632806569337845, -0.05718314275145531, 0.016420112922787666, 0.04796436429023743, 0.007575429975986481, 0.014669880270957947, 0.02736240066587925, 0.013694561086595058, -0.025665611028671265, 0.029526809230446815, -0.01724846661090851, 0.03754313662648201, -0.03433660790324211, -0.006436443421989679, 0.04414324834942818, -0.0015130819519981742, 0.002349786227568984, 0.012933009304106236, 0.03203859180212021, 0.007795879151672125, 0.008236777037382126, 0.013654478825628757, 0.0546446368098259, -0.05670216307044029, -0.007361661642789841, -0.05341546609997749, -0.01871812716126442, 0.008650953881442547, 0.05739691108465195, -0.030782699584960938, -0.03775690495967865, -0.0018754868069663644, 0.030462047085165977, -0.00827017892152071, -0.013447390869259834, -0.005688252858817577, -0.019159024581313133, -0.018517717719078064, -0.0032583035062998533, 0.025839298963546753, 0.007147892843931913, 0.036634620279073715, 0.023728331550955772, 0.04972795769572258, -0.003861198201775551, 0.053068093955516815, -0.020909255370497704, -0.036955274641513824, -0.017662642523646355, -0.013079975731670856, -0.03930673003196716, 5.349437924451195e-05, 0.010421226732432842, 0.027028387412428856, -0.022806454449892044, -0.018798289820551872, -0.008343661203980446, 0.00474967435002327, 0.036741506308317184, 0.023300794884562492, -0.018263867124915123, 0.0032249020878225565, -0.006613470613956451, 0.014188900589942932, -0.03273333981633186, 0.00661013089120388, -0.07187974452972412, 0.006062348373234272, -0.020267950370907784, -0.0025652251206338406, 0.007334940135478973, -0.006847280543297529, -0.010474668815732002, -0.027736496180295944, 0.05191908776760101, 0.005384300369769335, 0.051384665071964264, 0.02883206121623516, -0.005023565609008074, -0.0011515121441334486, -0.05712969973683357, -0.05750379338860512, -0.009252178482711315, -0.002708850894123316, 0.016086097806692123, 0.017048057168722153, -0.0013803115580230951, -0.01180404331535101, 0.0009761549881659448, 0.016553718596696854, 0.021697528660297394, 0.01711486093699932, 0.0048365178517997265, 0.005180552136152983, -0.023835215717554092, 0.008817961439490318, 0.06509258598089218, -0.04887288063764572, -0.006934124045073986, -0.001900537870824337, -0.024770453572273254, -0.012097975239157677, 0.002785674063488841, 0.009579512290656567, 0.07049024850130081, 0.04804452881217003, 0.005775096360594034, -0.027202073484659195, -0.006463164463639259, 0.03532528504729271, 0.014990533702075481, -0.010414546355605125, 0.030943026766180992, 0.01650027558207512, -0.01818370446562767, 0.021136386319994926, 0.02104286104440689, -0.05723658204078674, -0.003406939562410116, -0.025879379361867905, -0.012318424880504608, -0.029767299070954323, -0.008958246558904648, 0.006259416230022907, 0.01416218001395464, 0.022672848775982857, -0.04125737026333809, -0.04408980533480644, 0.019265908747911453, -0.012792724184691906, -0.0015873999800533056, 0.022993501275777817, 0.02311374619603157, -0.04994172602891922, 0.002832436002790928, -0.06632175296545029, 0.011115974746644497, -0.0036607899237424135, -0.011149376630783081, -0.004064946435391903, 0.04286063462495804, -0.03644757345318794, 0.0051438105292618275, 0.030141394585371017, 0.0032399327028542757, -0.05419037863612175, 0.0068339197896420956, -0.016246424987912178, 0.02271292917430401, 0.024236032739281654, -0.042593423277139664, -0.02000073902308941, -0.046067167073488235, -0.03583298623561859, 0.015003894455730915, -0.03433660790324211, -0.01575208455324173, 0.011844124644994736, -0.03799739480018616, 0.0123451454564929, -0.03591315075755119, -0.0017669323133304715, 0.06653552502393723, 0.023781774565577507, 0.006025606766343117, -0.0075553893111646175, 0.008123212493956089, -0.007588790729641914, -0.009432545863091946, 0.04398291930556297, -0.027602890506386757, -0.002159398514777422, 0.038371492177248, 0.038104280829429626, 0.01782296970486641, -0.0007218870450742543, 0.01073519978672266, -0.04708256945014, 0.0011389866704121232, 0.026053067296743393, 0.014589717611670494, -0.03436332568526268, -0.005364259704947472, 0.0186112429946661, 0.005087028257548809, 0.02657412737607956, -0.026841338723897934, 0.00018725641712080687, 0.0016066058306023479, 0.019412875175476074, -0.005177211947739124, 0.059855252504348755, -0.01982705108821392, -0.05664872005581856, 0.003099646884948015, -0.018584521487355232, -0.013734642416238785, 0.0025652251206338406, 0.047242894768714905, -0.015458152629435062, 0.038852471858263016, -0.0009552791016176343, 0.012672479264438152, -0.023995542898774147, 0.017903132364153862, -0.007835960946977139, -0.0009135273867286742, -8.026765863178298e-05, 0.006660232786089182, -0.0006041472661308944, 0.006299498025327921, -0.06867321580648422, 0.03350825235247612, -0.004285395611077547, 0.02697494439780712, 0.03209203481674194, -0.01775616779923439, 0.0006851455545984209, 0.015177581459283829, 0.008069770410656929, -0.020762290805578232, 0.016019295901060104, 0.007461865432560444, 0.032065313309431076, -0.02471701242029667, 0.0051170894876122475, -0.0013619407545775175, -0.016513636335730553, 0.01009389292448759, -0.01764928363263607, -0.0169278122484684, -0.020161066204309464, 0.011650397442281246, -0.05058303102850914, 0.008423824794590473, -0.03644757345318794, 0.02100278064608574, 0.008236777037382126, 0.026026345789432526, 0.03107663244009018, -0.07973574846982956, 0.001117275794968009, -0.007321579847484827, -0.007375021930783987, -0.01604601740837097, -0.008978287689387798, 0.002473371336236596, 0.022619405761361122, 0.0009168675169348717, -0.0075286682695150375, -0.023527923971414566, 0.018771568313241005, 0.034015953540802, -0.020922616124153137, -0.0015848949551582336, 0.04865911230444908, 0.02025458961725235, 0.017635922878980637, 0.010802002623677254, -0.07059713453054428, -0.0016675633378326893, 0.012525512836873531, -0.00855743046849966, -0.02110966481268406, 0.0011957689421251416, -0.021056221798062325, 0.011222859844565392, -0.03639413043856621, 0.011409907601773739, 0.025131188333034515, -0.010581552982330322, 0.08262162655591965, 0.03513823822140694, 0.004779735580086708, -0.05002188682556152, 0.005020225420594215, -0.03660789877176285, 0.010361104272305965, 0.03214547783136368, 0.011363144963979721, 0.011403227224946022, -0.021737610921263695, -0.019640004262328148, -0.04040229320526123, -0.02718871273100376, 0.031156795099377632, -0.04096343740820885, -0.054992012679576874, 0.01080868300050497, 0.0007552884053438902, -0.010007049888372421, 0.03449693322181702, -0.00018433379591442645, 0.024142509326338768, 0.01305325422435999, 0.00035342821502126753, 0.00026199198327958584, -0.0018855072557926178, -0.006212654523551464, 0.01410873793065548, -0.03326776251196861, 0.006112450268119574, 0.013494152575731277, 0.01703469827771187, -0.0733761265873909, 0.017876412719488144, 0.02275301143527031, 0.00017535718507133424, -0.047029126435518265, 0.004275375045835972, 0.01442939043045044, 0.039386894553899765, 0.012558914721012115, 0.02490405924618244, 0.020588602870702744, 0.021243270486593246, -0.03209203481674194, -0.00246502086520195, -0.0029543510172516108, -0.014389309100806713, -0.04360882565379143, -0.004552606493234634, -0.034309886395931244, 0.0493805818259716, 0.04344850033521652, -0.008016328327357769, 0.004946742672473192, 0.011142696253955364, -0.0024082385934889317, -0.02239227667450905, -0.015244384296238422, 0.03818444535136223, 0.027843380346894264, -0.027308957651257515, -0.0028925584629178047, -0.005648171063512564, -0.018477637320756912, 0.012705880217254162, 0.030194835737347603, -0.003757653757929802, -0.015271104872226715, -0.0018537759315222502, -0.005247354973107576, -0.01833067089319229, 0.01596585288643837, -0.02589274011552334, -0.00835702195763588, 0.0284312441945076, -0.0057082935236394405, 0.0013485802337527275, 0.023875297978520393, 0.018303949385881424, 0.028965666890144348, 0.029313040897250175, 0.008797920309007168, -0.008056409657001495, -0.04465094953775406, -0.013734642416238785, 0.029072551056742668, -0.0246502086520195, 0.004559286870062351, -0.01082204282283783, -0.02328743413090706, -0.041497860103845596, -0.015297826379537582, 0.0025769155472517014, -0.04366226866841316, 0.015030615031719208, 0.0007744941976852715, -0.010047131218016148, -0.019533120095729828, 0.041284091770648956, -0.0031965109519660473, 0.04622749239206314, 0.013614397495985031, 0.017315268516540527, -0.021884575486183167, 0.02432955615222454, 0.02557208761572838, 0.006122470833361149, -0.021096304059028625, -0.030168116092681885, -0.020842453464865685, -0.04270030930638313, -0.019599922001361847, 0.029713856056332588, -0.0004241973801981658, 0.006102429702877998, -0.05405677482485771, 0.06055000051856041, 0.05141138657927513, -0.02422267198562622, 0.029125992208719254, 0.015498234890401363, 0.016086097806692123, 0.02010762318968773, 0.002914269221946597, 0.029847461730241776, 0.0005824363324791193, 0.018103541806340218, -0.01159027498215437, 0.002104286104440689, 0.010200778022408485, 0.05055630952119827, -0.03075597994029522, -0.0721469521522522, -0.020067540928721428, -0.017876412719488144, 0.019225826486945152, 0.018090181052684784, -0.008330301381647587, -0.007982926443219185, -0.019987378269433975, 0.05277416110038757, 0.012926328927278519, 0.004382259678095579, 0.0037910551764070988, 0.009452586993575096, -0.018303949385881424, 0.04964779317378998, -0.02511782944202423, 0.004108368419110775, 0.003887919243425131, -0.01865132339298725, 0.015658561140298843, -0.0361536405980587, 0.0032583035062998533, 0.01750231720507145, -0.03340136632323265, -0.002473371336236596, -0.021443678066134453, -0.035886429250240326, -0.003194840857759118, 0.031236959621310234, -0.00835702195763588, -0.009492668323218822, -0.0128595270216465, -0.03871886432170868, -0.014830207452178001, -0.023100385442376137, -0.009766560047864914, 0.004322137217968702, -0.04208572208881378, -0.010321022942662239, -0.06397029757499695, -0.01867804490029812, -0.013480791822075844, -8.741764031583443e-05, 0.005220633931457996, -0.018811650574207306, -0.02597290277481079, 0.011917607858777046, -0.00835702195763588, 0.023020222783088684, -0.013373907655477524, 0.01671404391527176, -0.029019108042120934, 0.011336424387991428, -0.01929263025522232, -0.003082946175709367, 0.03505807742476463, 0.030702536925673485, 0.0019155684858560562, -0.0072213755920529366, -0.051705315709114075, 0.02082909271121025, -0.035779546946287155, 0.02004082128405571, -0.026200033724308014, 0.033668577671051025, 0.007896083407104015, -0.06493225693702698, 0.0164334736764431, -0.006125811021775007, 0.004763035103678703, 0.03182482346892357, -0.013774723745882511, 0.001947299693711102, 0.011683798395097256, 0.010561512783169746, 0.03583298623561859, -0.04430357366800308, 0.034015953540802, -0.03690183162689209, 0.000953609065618366, -0.017488956451416016, 0.01096900925040245, 0.00040165145765058696, 0.00021115927665960044, -0.011743920855224133, 0.027442563325166702, -0.0031647796276956797, -0.007595471106469631, -0.02260604500770569, -0.029847461730241776, 0.0024065684992820024, -0.04433029517531395, -0.021016141399741173, -0.0028491367120295763, -0.012572274543344975, 0.006139171309769154, -0.013560955412685871, -0.003336796537041664, -0.10255555808544159, -0.008210056461393833, 0.060389671474695206, -0.05058303102850914, 0.026346998289227486, -0.003978102933615446, 0.02143031731247902, 0.009526070207357407, 0.0020174426026642323, -0.031130075454711914, -0.016780847683548927, -0.02511782944202423, -0.04940730333328247, -0.019746888428926468, 0.02004082128405571, -0.01218481920659542, 0.02507774718105793, 0.0026437181513756514, 0.036313965916633606, -0.013894968666136265, -0.025264794006943703, -0.018263867124915123, -0.03543217107653618, 0.006089069414883852, -0.0038177762180566788, -0.007976246997714043, 0.00038390696863643825, 0.04125737026333809, 0.023995542898774147, 0.022619405761361122, -0.0013911669375374913, -0.03644757345318794, -0.010888845659792423, 0.02475709468126297, 0.009592873044312, 0.019733527675271034, 0.02396882139146328, 0.04010836407542229, 0.029847461730241776, 0.027389122173190117, -0.003365187905728817, -0.024703651666641235, 0.001062163501046598, -0.011189457960426807, 0.021243270486593246, 0.028591571375727654, -0.029553530737757683, 0.0169278122484684, 0.004813136998564005, 0.004819817375391722, 0.018985336646437645, 0.0039914632216095924, -0.007815919816493988, 0.0037643341347575188, 0.026534046977758408, 0.04240637645125389, -0.033134154975414276, 0.006319538690149784, 0.0014379288768395782, 0.03406939655542374, 0.013420669361948967, 0.02000073902308941, 0.04326144978404045, -0.01446947269141674, -0.006506586447358131, -0.026173312216997147, 0.009379103779792786, -0.0015565037028864026, -0.019426235929131508, -0.021871214732527733, 0.0015164221404120326, 0.03676822409033775, 0.014255703426897526, 0.011383186094462872, 0.005207273177802563, -0.004292075987905264, 0.006236035376787186, -0.011216179467737675, 0.006159212440252304, 8.799172792350873e-05, 0.019559841603040695, 0.0003732602926902473, 0.016994616016745567, 0.017876412719488144, -0.014562996104359627, 0.019172385334968567, -0.004241973627358675, -0.005260715261101723, -0.005454443395137787, 0.005066987592726946, -0.039600662887096405, -0.013961771503090858, -0.013400629162788391, -0.014402669854462147, -0.014669880270957947, 0.005621450021862984, -0.02853812836110592, 0.01807682029902935, 0.034015953540802, 0.015190942212939262, 0.02936648204922676, 0.045746512711048126, -0.005264055449515581, -0.005177211947739124, -0.0328669473528862, 0.02004082128405571, -0.030408605933189392, -0.023127106949687004, -0.009532750584185123, 0.007241416722536087, -0.00821673683822155, 0.0011080903932452202, -0.0034370007924735546, 0.0075821103528141975, -0.025812577456235886, 0.017529038712382317, 0.037382811307907104, -0.00728817842900753, -0.020027460530400276, -0.011971049942076206, 0.01354091428220272, 0.019412875175476074, -0.007361661642789841, 0.0213234331458807, -0.014709962531924248, -0.005207273177802563, -0.002460010815411806, -0.0022429018281400204, -0.011677118018269539, 0.0018537759315222502, 0.010421226732432842, 0.02789682149887085, -0.031236959621310234, 0.03604675456881523, -0.014589717611670494, -0.009425866417586803, 0.03818444535136223, -0.037676744163036346, -0.013340506702661514, -0.020281311124563217, -0.0024048984050750732, -0.03650101646780968, -0.013033214025199413, -0.02746928483247757, -0.025638889521360397, -0.013193540275096893, 0.00017546156595926732, 0.0047029126435518265, -0.05411021411418915, 0.020054182037711143, 0.002860827138647437, 0.005748375318944454, 0.027656331658363342, 0.009238818660378456, -0.026373719796538353, 0.029072551056742668, -0.02114974521100521, -0.04211244359612465, 0.005678232293576002, 0.02200482040643692, -0.017261827364563942, 0.04897976666688919, 0.0014462792314589024, -0.017689364030957222, -0.0373026467859745, -0.0007724066381342709, -0.03096974827349186, 0.0020441636443138123, -0.015351268462836742, -0.002819075481966138, -0.03783706948161125, 0.010414546355605125, 0.01457635685801506, 0.017315268516540527, 0.0483117401599884, 0.04983483999967575, 0.06712339073419571, -0.014870288781821728, -0.03195842728018761, 0.01628650724887848, -0.015578397549688816, 0.0021894597448408604, 0.0015297826612368226, 0.004272034857422113, 0.03460381552577019, -0.02461012825369835, 0.02646724320948124, 0.0240757055580616, 0.0040983478538692, -0.01221822015941143, -0.004078307189047337, 0.02678789757192135, 0.005407681223005056, 0.028457965701818466, 0.01457635685801506, 0.025264794006943703, 0.016166262328624725, 0.021777691319584846, -0.0018621262861415744, -0.01796993613243103, 0.012578954920172691, 0.011383186094462872, 0.014082016423344612, -0.011897566728293896, 0.012351825833320618, 0.03532528504729271, -0.020882535725831985, 0.005948783364146948, -0.01679420843720436, 0.00482315756380558, 0.006940804421901703, -0.030462047085165977, 0.02221859060227871, 0.005324177909642458, -0.028564849868416786, 0.01589905098080635, -0.003219891805201769, 0.011196138337254524, -0.00420523202046752, -0.02514454908668995, -0.01118277758359909, -0.007648913189768791, -0.025558726862072945, 0.00596548430621624, -0.03203859180212021, 0.02861829102039337, -0.007495266851037741, 0.017488956451416016, 0.018317310139536858, 0.003794395364820957, 0.01086212508380413, 0.005738354753702879, -0.029606971889734268, -0.027242155745625496, 0.024142509326338768, -0.03869214281439781, -0.003814436262473464, -0.007695674896240234, 0.042807191610336304, -0.030168116092681885, -0.011763961985707283, 0.0028491367120295763, -0.007381702307611704, -0.021804412826895714, 0.016807567328214645, -0.02018778584897518, 0.02851140685379505, 0.03984115272760391, 0.01728854887187481, 0.0027689733542501926, -0.004953423049300909, 0.004081646911799908, 0.0066836136393249035, -0.011503431014716625, 0.014643159694969654, -0.005788457114249468, 0.022726289927959442, 0.0032516231294721365, -0.0003868296043947339, 0.022352194413542747, 0.010300981812179089, 0.0503692626953125, 0.02000073902308941, -0.03075597994029522, -0.0033518271520733833, -0.020668765529990196, -0.014282424934208393, 0.02089589647948742, 0.01903877966105938, 0.0329471081495285, 0.008517349138855934, 0.031985148787498474, -0.0019088881090283394, 0.02004082128405571, 0.017943214625120163, 0.003754313802346587, -0.03807755932211876, -0.0018370752222836018, -0.03724920377135277, -0.0645047202706337, -0.016700683161616325, -0.02008090168237686, 0.003171459771692753, 0.011189457960426807, 0.020815731957554817, -0.019199106842279434, -0.0077825188636779785, -0.05750379338860512, -0.008390423841774464, 0.005247354973107576, 0.061137862503528595, 0.007835960946977139, 0.028992386534810066, -0.016994616016745567, 0.00845054630190134, 0.00973315816372633, 0.010341063141822815, -0.007542029023170471, -0.010781961493194103, -0.0416581854224205, 0.01532454788684845, 0.01882501132786274, -0.017021337524056435, 0.02565225027501583, 0.019800331443548203, 0.012625716626644135, 0.0023447759449481964, -0.04291407763957977, 0.028885502368211746, 0.032492849975824356, -0.014402669854462147, -0.009252178482711315, 0.014549635350704193, -0.02546520344913006, 0.018905173987150192, 0.041070323437452316, -0.02668101340532303, -0.02185785584151745, -0.049567628651857376, 0.009612913243472576, -0.006192613393068314, 0.013674519956111908, 0.01664724200963974, 0.030782699584960938, 0.007508627604693174, 0.007455185055732727, -0.008918165229260921, 0.0022930039558559656, 0.03724920377135277, -0.009953607805073261, 0.03700871393084526, 0.0240757055580616, 0.00350046344101429, 0.003547225147485733, -0.021056221798062325, 0.01548487413674593, -0.05830542743206024, 0.018050098791718483, -0.007916124537587166, -0.027228794991970062, 0.022672848775982857, -0.00991352554410696, -0.015725363045930862, 0.005691593047231436, 0.01579216681420803, -0.027442563325166702, -0.0027138611767441034, -0.005377619992941618, 0.0005507050664164126, 0.031985148787498474, 0.07198663055896759, -0.02275301143527031, -0.01328706368803978, 0.041097041219472885, 0.025812577456235886, 0.014456111937761307, 0.023407679051160812, 0.00044716079719364643, -0.012852846644818783, -0.062313590198755264, -0.021550562232732773, -0.00017420900985598564, 0.0318782664835453, 0.0078092399053275585, 0.004248654004186392, -0.041952118277549744, 0.0006458989228121936, -0.01968008652329445, 0.008210056461393833, -0.00026491458993405104, 0.026427162811160088, 0.03682166710495949, -0.007521987892687321, -0.011496750637888908, 0.014228982850909233, -0.004863239359110594, 0.015979213640093803, -0.010474668815732002, 0.020775651559233665, 0.0362338051199913, 0.029099270701408386, -0.028671734035015106, 0.022485800087451935, 0.014656520448625088, -0.03634068742394447, 0.008938206359744072, -0.014910370111465454, -0.005431062541902065, -0.022018181160092354, 0.02768305316567421, 0.0013861567713320255, 0.009405825287103653, -0.007989606820046902, 0.001661718008108437, 0.025051025673747063, -0.008978287689387798, 0.01965336501598358, -0.003744293237105012, 0.028564849868416786, -0.0057583958841860294, 0.015003894455730915, 0.018878452479839325, 0.02426275424659252, -0.023207269608974457, 0.013213581405580044, -0.02990090474486351, -0.014496193267405033, 0.07620856165885925, 0.0049834842793643475, 0.0317981019616127, -0.017488956451416016, 0.022953419014811516, 0.013921690173447132, 0.017168303951621056, -0.01416218001395464, -0.032385967671871185, -0.0362338051199913, -0.029125992208719254, 0.0015698643401265144, 0.034817587584257126, -0.029313040897250175, 0.010775281116366386, 0.03054220974445343, 0.01291296910494566, 0.00982668250799179, 0.03692855313420296, 0.02676117606461048, -0.02593282237648964, 0.02746928483247757, 0.03174465894699097, -0.006693634204566479, -0.0048097968101501465, -0.022565964609384537, 0.0246502086520195, -0.03447021171450615, -0.0044123209081590176, 0.01850435696542263, 0.013474111445248127, -0.025211352854967117, -0.0036607899237424135, 0.004051585681736469, 0.01062831562012434, 0.004692892078310251, 0.025719054043293, 0.01066171657294035, 0.0071078110486269, -0.010187417268753052, 0.018170343711972237, -0.023167189210653305, 0.015284465625882149, -0.002839116146788001, 0.0038578580133616924, 0.01086212508380413, -0.00422527315095067, -0.023915378376841545, 0.007869361899793148, -0.02318054996430874, 0.008063090033829212, 0.012846166267991066, 0.027268877252936363, 0.006994246505200863, 0.009045090526342392, 0.010060491971671581, -0.00625273585319519, -0.0021911298390477896, 0.0029860823415219784, -0.03321431949734688, 0.003740953281521797, -0.03676822409033775, -0.01650027558207512, 0.008851362392306328, -0.010087213478982449, -0.023167189210653305, -0.00957283191382885, 0.0039814431220293045, 0.011723879724740982, 0.01654035784304142, -0.017088139429688454, 0.0022712929639965296, -0.02925959788262844, 0.0036674700677394867, 0.009786601178348064, 0.020201146602630615, -0.00650992663577199, 0.014335867017507553, 0.014803485944867134, -0.01107589341700077, -0.028992386534810066, -0.022980140522122383, 0.010848764330148697, -0.0014020224334672093, 0.012772683054208755, 0.00843050517141819, -0.008944886736571789, 0.01209129486232996, 0.015551676973700523, 0.022512521594762802, 0.015030615031719208, -0.034523654729127884, 0.012151417322456837, 0.0295802503824234, 0.006239375565201044, 0.0009911855449900031, 0.018945256248116493, -0.02050844021141529, -0.060496557503938675, 0.03326776251196861, -0.03634068742394447, 0.0006354610086418688, -0.03444349020719528, 0.009512709453701973, -0.01982705108821392, -0.018905173987150192, -0.037703465670347214, 0.02264612726867199, -0.014041935093700886, -0.005097048822790384, -0.004378919489681721, 0.0147901251912117, -0.01330710481852293, 0.016406752169132233, -0.001327704405412078, 0.004712933208793402, 0.039199844002723694, 0.027602890506386757, -0.02589274011552334, 0.006523286923766136, -0.009379103779792786, -0.005100389011204243, -0.006155872251838446, -0.009172015823423862, -0.030488768592476845, 0.007461865432560444, -0.0015381330158561468, -0.02294006012380123, 0.0012475410476326942, 0.01724846661090851, -0.01568528264760971, -0.000398311298340559, -0.012138057500123978, 0.008310260251164436, -0.0024065684992820024, -0.024142509326338768, 0.00011815733887488022, 0.008724437095224857, 0.033347927033901215, -0.011837444268167019, -0.007495266851037741, 0.017021337524056435, 0.0580916590988636, -0.033989232033491135, -0.01232510432600975, -0.021951379254460335, 0.016126180067658424, -0.013026533648371696, 0.022806454449892044, -0.00803636945784092, -0.013614397495985031, 0.010334382764995098, 0.011797362938523293, -0.018090181052684784, -0.0024266093969345093, 0.012619037181138992, 0.012385226786136627, 0.026493964716792107, -0.01066171657294035, 0.012064574286341667, -0.022298753261566162, 0.04328817129135132, 0.006853960454463959, 0.0011189457727596164, 0.0008078955579549074, 0.029954345896840096, -0.0012107995571568608, -0.034737423062324524, -0.010668396949768066, 0.035378728061914444, 0.005614770110696554, -0.0066568925976753235, 0.009192056022584438, 0.033668577671051025, -0.021336793899536133, -0.030836142599582672, -0.001528947614133358, 0.010508070699870586, -0.005684912670403719, -0.01871812716126442, -0.0047029126435518265, 0.043742429465055466, -0.022485800087451935, -0.006847280543297529, 0.03978770971298218, -0.003677490632981062, 0.019025418907403946, -0.031851544976234436, -0.00495676277205348, 0.02042827568948269, -0.020535161718726158, -0.03284022584557533, -0.01825050823390484, 0.04983483999967575, 0.021163105964660645, -0.02200482040643692, -0.0059087020345032215, -0.002226201118901372, -0.011844124644994736, 0.027161993086338043, 0.01107589341700077, 0.007321579847484827, -0.007127851713448763, -0.023554643616080284, 0.02264612726867199, -0.024663569405674934, -0.03917312249541283, 0.03634068742394447, 0.006516607012599707, -0.03861198201775551, 0.010594913735985756, -0.029927626252174377, -0.03639413043856621, -0.00705436896532774, 0.01462979894131422, 0.004525885451585054, -0.01878492906689644, -0.008129892870783806, -0.004365558736026287, -0.01229170337319374, 0.015204302966594696, 0.020161066204309464, -0.03529856726527214, 0.010060491971671581, -0.019172385334968567, -0.01954648084938526, -0.015992574393749237, 0.0003386063617654145, -0.00022378916037268937, 0.015070697292685509, 0.017315268516540527, 0.019305991008877754, 0.0018487656489014626, 0.0415780209004879, -0.009472628124058247, 0.019533120095729828, -0.015524955466389656, 0.04117720574140549, -0.0014195580733940005, 0.010234178975224495, -0.02296677976846695, -0.017261827364563942, -0.034015953540802, -0.024129148572683334, -0.0048264977522194386, 0.04561290889978409, -0.007675634231418371, 0.00656336871907115, 0.024556685239076614, 0.020227868109941483, 0.011703839525580406, -0.016086097806692123, -0.0018103541806340218, 0.007254777010530233, -0.03246612846851349, 0.010888845659792423, -0.01935943216085434, 0.02640044130384922, 0.031049910932779312, 0.013494152575731277, 0.0023197249975055456, 0.0052941166795790195, 0.02454332448542118, 0.04783075675368309, -0.01437594834715128, 0.01833067089319229, -0.008530708961188793, 0.016099458560347557, -0.016767486929893494, -0.01899869740009308, -0.005374280270189047, -0.012812764383852482, 0.023741692304611206, 0.02018778584897518, 0.029660414904356003, 0.027349039912223816, -0.011763961985707283, 0.018410833552479744, -0.012692519463598728, -0.00682389922440052, 0.004038225393742323, 0.04275375232100487, 0.007488586474210024, -0.012632397003471851, 0.016727404668927193, -0.004789756145328283, 0.010381145402789116, -0.0006124975625425577, 0.026747815310955048, 0.02599962428212166, -0.014482833445072174, -0.055312663316726685, -0.0010195767972618341, 0.009966968558728695, 0.007742437068372965, -0.01628650724887848, -0.01283948589116335, 0.010194097645580769, -0.009018369019031525, -0.0029125993605703115, 0.007101130671799183, -0.0037108920514583588, 0.0022195209749042988, -0.046387817710638046, -0.019212467595934868, 0.02525143325328827, -0.030488768592476845, -0.03107663244009018, 0.012906288728117943, -0.013226941227912903, -0.003961401991546154, -0.004950082860887051, -0.01245202962309122, -6.528923404403031e-05, -0.01899869740009308, 0.019920576363801956, -0.011483389884233475, 0.004148449748754501, -0.03417627885937691, -0.017275188118219376, -0.015885690227150917, 0.03556577488780022, -0.03866542503237724, 0.020601963624358177, -0.0284312441945076, 0.02008090168237686, -0.02497086301445961, 0.020348113030195236, 0.002872517565265298, -0.03321431949734688, 0.023955460637807846, -0.02042827568948269]
metadata : {"source": "pydantic_ai_docs", "crawled_at": "2025-03-15T11:24:54.617671", "url_path": "/graph/", "chunk_size": 3944}
updated_dt: 2025-03-15T11:24:54.620825
---
```
from__future__import annotations
fromdataclassesimport dataclass
fromrich.promptimport Prompt
frompydantic_graphimport BaseNode, End, Graph, GraphRunContext

@dataclass
classMachineState: [](https://ai.pydantic.dev/graph/#__code_7_annotation_1)
  user_balance: float = 0.0
  product: str | None = None

@dataclass
classInsertCoin(BaseNode[MachineState]): [](https://ai.pydantic.dev/graph/#__code_7_annotation_3)
  async defrun(self, ctx: GraphRunContext[MachineState]) -> CoinsInserted: [](https://ai.pydantic.dev/graph/#__code_7_annotation_16)
    return CoinsInserted(float(Prompt.ask('Insert coins'))) [](https://ai.pydantic.dev/graph/#__code_7_annotation_4)

@dataclass
classCoinsInserted(BaseNode[MachineState]):
  amount: float [](https://ai.pydantic.dev/graph/#__code_7_annotation_5)
  async defrun(
    self, ctx: GraphRunContext[MachineState]
  ) -> SelectProduct | Purchase: [](https://ai.pydantic.dev/graph/#__code_7_annotation_17)
    ctx.state.user_balance += self.amount [](https://ai.pydantic.dev/graph/#__code_7_annotation_6)
    if ctx.state.product is not None: [](https://ai.pydantic.dev/graph/#__code_7_annotation_7)
      return Purchase(ctx.state.product)
    else:
      return SelectProduct()

@dataclass
classSelectProduct(BaseNode[MachineState]):
  async defrun(self, ctx: GraphRunContext[MachineState]) -> Purchase:
    return Purchase(Prompt.ask('Select product'))

PRODUCT_PRICES = { [](https://ai.pydantic.dev/graph/#__code_7_annotation_2)
  'water': 1.25,
  'soda': 1.50,
  'crisps': 1.75,
  'chocolate': 2.00,
}

@dataclass
classPurchase(BaseNode[MachineState, None, None]): [](https://ai.pydantic.dev/graph/#__code_7_annotation_18)
  product: str
  async defrun(
    self, ctx: GraphRunContext[MachineState]
  ) -> End | InsertCoin | SelectProduct:
    if price := PRODUCT_PRICES.get(self.product): [](https://ai.pydantic.dev/graph/#__code_7_annotation_8)
      ctx.state.product = self.product [](https://ai.pydantic.dev/graph/#__code_7_annotation_9)
      if ctx.state.user_balance >= price: [](https://ai.pydantic.dev/graph/#__code_7_annotation_10)
        ctx.state.user_balance -= price
        return End(None)
      else:
        diff = price - ctx.state.user_balance
        print(f'Not enough money for {self.product}, need {diff:0.2f} more')
        #> Not enough money for crisps, need 0.75 more
        return InsertCoin() [](https://ai.pydantic.dev/graph/#__code_7_annotation_11)
    else:
      print(f'No such product: {self.product}, try again')
      return SelectProduct() [](https://ai.pydantic.dev/graph/#__code_7_annotation_12)

vending_machine_graph = Graph( [](https://ai.pydantic.dev/graph/#__code_7_annotation_13)
  nodes=[InsertCoin, CoinsInserted, SelectProduct, Purchase]
)

async defmain():
  state = MachineState() [](https://ai.pydantic.dev/graph/#__code_7_annotation_14)
  await vending_machine_graph.run(InsertCoin(), state=state) [](https://ai.pydantic.dev/graph/#__code_7_annotation_15)
  print(f'purchase successful item={state.product} change={state.user_balance:0.2f}')
  #> purchase successful item=crisps change=0.25

```

_(This example is complete, it can be run "as is" with Python 3.10+ — you'll need to add`asyncio.run(main())` to run `main`)_
A [mermaid diagram](https://ai.pydantic.dev/graph/#mermaid-diagrams) for this graph can be generated with the following code:
vending_machine_diagram.py```
fromvending_machineimport InsertCoin, vending_machine_graph
vending_machine_graph.mermaid_code(start_node=InsertCoin)

```

The diagram generated by the above code is:
See [below](https://ai.pydantic.dev/graph/#mermaid-diagrams) for more information on generating diagrams.
## GenAI Example
So far we haven't shown an example of a Graph that actually uses PydanticAI or GenAI at all.
In this example, one agent generates a welcome email to a user and the other agent provides feedback on the email.
This graph has a very simple structure:
genai_email_feedback.py